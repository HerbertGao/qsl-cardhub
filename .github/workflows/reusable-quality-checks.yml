name: Reusable Quality Checks

on:
  workflow_call:

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  # 前端代码检查（无需 Rust 编译）
  frontend-lint:
    name: Frontend Lint
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装 pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: 安装 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: web/pnpm-lock.yaml

      - name: 安装依赖
        working-directory: web
        run: pnpm install --frozen-lockfile

      - name: TypeScript 类型检查
        working-directory: web
        run: pnpm run type-check

      - name: ESLint 检查
        working-directory: web
        run: pnpm run lint

  # Rust 导出绑定校验（会触发 Rust 编译）
  rust-bindings-check:
    name: Rust Bindings Check
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: Rust 缓存
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-quality-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-quality-cargo-

      - name: 安装 Linux 系统依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev

      - name: 安装 Rust
        uses: dtolnay/rust-toolchain@stable

      - name: 生成占位配置文件
        run: |
          cat > config/sf_express_default.toml << TOML
          enabled = false
          partner_id = ""
          checkword_sandbox = ""
          checkword_prod = ""
          TOML

      - name: 验证 TypeScript 类型同步
        run: |
          cargo test export_bindings --features ts-rs
          if ! git diff --exit-code web/src/types/generated/; then
            echo "::error::生成的 TypeScript 类型与 Rust 定义不同步。请运行 'cargo test export_bindings --features ts-rs' 并提交更新后的文件。"
            exit 1
          fi
