# qrz-herbertgao-me-integration Specification

## Purpose
TBD - created by archiving change add-card-management. Update Purpose after archive.
## 需求
### 需求：分发弹框中的呼号地址查询

系统必须在卡片分发弹框中提供基于 QRZ.herbertgao.me 的呼号查询功能,实时查询并展示呼号对应的地址信息。该数据源无需登录配置,直接查询即可。

#### 场景：在分发弹框中自动查询地址

- **当** 用户打开卡片分发弹框
- **那么** 系统必须自动向 QRZ.herbertgao.me 发起查询
- **并且** 与 QRZ.cn 和 QRZ.com 查询并行执行
- **并且** 无需用户配置或登录
- **并且** 该数据源查询失败不影响其他数据源

#### 场景：执行呼号查询

- **当** 系统查询地址（自动或手动刷新）
- **那么** 系统必须发送 HTTP GET 请求到 `https://qrz.herbertgao.me/qrz/callsign/<呼号>`
- **并且** 请求必须包含以下头部:
  - `Accept: application/json`
  - `User-Agent: qsl-cardhub/<version>`
- **并且** 系统必须接收 JSON 格式的响应
- **并且** 无需 Cookie 或 Token 认证

#### 场景：解析呼号查询结果

- **当** 收到 QRZ.herbertgao.me 查询响应
- **那么** 系统必须解析 JSON 响应内容
- **并且** 必须提取以下信息（从第一个 `isShow: true` 的记录）:
  - `callSign`（呼号）
  - `name`（姓名）
  - `mailAddress`（邮寄地址）
  - `mailMethod`（邮寄方式）
  - `createTime`（创建时间，格式：ISO 8601）
- **并且** 必须过滤 `isShow: false` 的记录
- **并且** 如果所有记录的 `isShow` 都为 `false`，视为未找到数据
- **并且** 如果响应为空数组，视为呼号不存在

#### 场景：显示查询结果

- **当** 呼号查询成功或显示缓存数据
- **那么** 系统必须在分发弹框的地址展示区域按以下格式显示:
  ```
  呼号: BH*** (QRZ卡片查询)
  姓名: 李青阳
  邮寄方式: 普通快递（申通）
  地址: 辽宁省 沈阳市 于洪区 赤山路122-4号
  更新时间: 2021-01-18
  缓存时间: 2026-01-22 10:30
  ```
- **并且** 各字段显示规则:
  - 呼号: 显示从 API 查询到的呼号，后面跟数据来源标识 `(QRZ卡片查询)`
  - 姓名: 用户姓名（来自 `name` 字段）
  - 邮寄方式: 用户选择的邮寄方式（来自 `mailMethod` 字段）
  - 地址: 完整邮寄地址（来自 `mailAddress` 字段）
  - 更新时间: 数据创建时间（来自 `createTime`，格式: YYYY-MM-DD）
  - 缓存时间: 本地查询时间（格式: YYYY-MM-DD HH:mm）
- **并且** 所有地址信息必须可复制
- **并且** 提供"复制地址"快捷按钮
- **并且** 地址信息为只读展示，不自动填充到收件地址输入框

#### 场景：查询失败处理

- **当** 呼号查询失败(网络错误、呼号不存在等)
- **那么** 系统必须静默处理错误（不显示错误提示）
- **并且** 记录错误到控制台日志
- **并且** 不影响其他数据源的查询
- **并且** 如果呼号不存在（空数组或所有记录 `isShow: false`），不显示该数据源的结果

#### 场景：查询结果缓存（智能去重）

- **当** 查询成功获取呼号地址
- **那么** 系统必须检查最新缓存记录的数据内容
- **并且** 比较以下字段是否完全一致:
  - `callsign`（呼号）
  - `name`（姓名）
  - `mail_method`（邮寄方式）
  - `address`（地址，完整字符串）
  - `data_updated_at`（数据更新日期）
- **当** 数据内容完全一致（仅 `cached_at` 不同）
- **那么** 系统必须更新现有记录的 `cached_at` 字段为当前查询时间
- **并且** 不得创建新记录
- **当** 数据内容有任何差异
- **那么** 系统必须更新 `address_cache` 中的记录
- **并且** 缓存格式为:
  ```json
  {
    "address_cache": [
      {
        "source": "QRZ卡片查询",
        "callsign": "BH***",
        "name": "李青阳",
        "mail_method": "普通快递（申通）",
        "address": "辽宁省 沈阳市 于洪区 赤山路122-4号",
        "data_updated_at": "2021-01-18",
        "cached_at": "2026-01-22T10:30:00+08:00"
      }
    ]
  }
  ```
- **并且** `source` 字段必须固定为 `"QRZ卡片查询"`,标识数据来源（对应 API 来源 qrz.herbertgao.me 的用户友好显示名称）
- **并且** `data_updated_at` 存储 API 返回的 `createTime` 日期部分
- **并且** `cached_at` 存储查询时间（本地时间戳）
- **并且** 数组按 `cached_at` 降序排列，最新查询结果在最前面

#### 场景：单版本缓存规则

- **当** 查询成功获取新数据
- **那么** 系统必须检查该来源是否已有缓存记录
- **并且** 如果数据有变化，直接覆盖原有记录（单版本）
- **并且** 如果数据无变化，仅更新 `cached_at` 时间戳

#### 场景：优先显示缓存数据

- **当** 用户打开分发弹框
- **并且** 卡片的 metadata 包含地址缓存记录
- **那么** 系统必须自动显示最新的缓存地址
- **并且** 按标准格式显示呼号、姓名、邮寄方式、地址、更新时间、缓存时间
- **并且** 如果缓存距今不超过 365 天（1年），数据有效
- **并且** 如果缓存距今超过 365 天，显示提示"数据已过期，建议刷新"
- **并且** 自动在后台刷新查询最新数据

#### 场景：手动刷新地址

- **当** 用户在分发弹框中点击"刷新"按钮
- **那么** 系统必须向 QRZ.herbertgao.me 发起实时查询
- **并且** 查询期间显示加载状态
- **并且** 查询成功后将新结果更新到 address_cache
- **并且** 自动显示最新查询结果
- **并且** 更新缓存时间标识

#### 场景：与其他数据源并行查询

- **当** 用户打开分发弹框或点击刷新按钮
- **那么** 系统必须并行查询所有可用数据源
- **并且** 包括 QRZ.cn（如果已登录）、QRZ.com（如果已登录）、QRZ.herbertgao.me（始终查询）
- **并且** 各数据源查询互不依赖
- **并且** 单个数据源查询失败不影响其他数据源
- **并且** 所有成功查询的结果都更新到 address_cache
- **并且** 按数据来源分组显示

---

