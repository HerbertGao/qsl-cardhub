## 新增需求

### 需求：微信功能开关

系统**必须**将微信集成功能设计为可选模块，根据环境变量配置自动启用或禁用相关功能。

#### 场景：未配置微信参数时隐藏订阅功能

- **当** 环境变量 `WECHAT_APPID` 或 `WECHAT_SECRET` 未配置（为空或不存在）
- **那么** `/api/config` 接口返回的 `features.wechat_subscribe` 必须为 `false`
- **并且** 前端必须隐藏「订阅收卡」按钮及相关 UI
- **并且** 查询功能（按呼号查询收卡）必须正常可用，不受影响

#### 场景：配置微信参数后启用订阅功能

- **当** 环境变量 `WECHAT_APPID` 和 `WECHAT_SECRET` 均已配置
- **那么** `/api/config` 接口返回的 `features.wechat_subscribe` 必须为 `true`
- **并且** 返回 `wechat_appid` 字段供前端构建授权 URL
- **并且** 前端必须显示「订阅收卡」按钮

#### 场景：微信推送依赖完整配置

- **当** 顺丰路由推送触发微信消息发送
- **那么** 必须同时满足 `WECHAT_APPID`、`WECHAT_SECRET`、`WECHAT_TEMPLATE_ID` 均已配置才发送
- **并且** 若缺少任一配置，仅落库路由数据，不尝试发送微信消息，不报错

#### 场景：/api/config 接口返回功能开关

- **当** 前端请求 `GET /api/config`
- **那么** 响应必须包含 `features` 对象，结构如下：
  ```json
  {
    "features": {
      "wechat_subscribe": <boolean>,
      "wechat_push": <boolean>
    },
    "wechat_appid": <string|null>
  }
  ```
- **并且** `wechat_subscribe` 为 `true` 当且仅当 `WECHAT_APPID` 和 `WECHAT_SECRET` 均已配置
- **并且** `wechat_push` 为 `true` 当且仅当 `WECHAT_APPID`、`WECHAT_SECRET`、`WECHAT_TEMPLATE_ID` 均已配置
- **并且** `wechat_appid` 仅在 `wechat_subscribe` 为 `true` 时返回实际值，否则为 `null`

---

### 需求：微信服务号推送可行性说明

系统**必须**在设计与文档中明确微信服务号推送的可行性与前置条件，供决策是否在本期实现。

#### 场景：可行性结论文档化

- **当** 评估微信服务号推送能力时
- **那么** 必须说明：需已认证的服务号、模板消息或订阅消息的申请与审核流程、用户 openid 通过网页授权获取
- **并且** 说明与顺丰路由推送的衔接方式：收到顺丰回调 → 解析呼号 → 查 D1 中呼号–openid 绑定 → 向该呼号下绑定的用户发送微信模板消息
- **并且** 说明绑定方式：在「根据呼号查询收卡信息」的结果页提供「订阅收卡」，经微信授权后建立呼号–openid 绑定

---

### 需求：按呼号查询结果页与「订阅收卡」绑定流程

若集成微信服务号推送，系统**必须**提供根据呼号查询收卡信息的单独页面；在该页的查询结果处提供「订阅收卡」入口，并按微信公众平台要求完成授权后将呼号与用户（openid）绑定；后续顺丰推送根据该绑定关系向对应用户推送。

#### 场景：查询结果页展示订阅入口与提示

- **当** 用户访问根据呼号查询收卡信息的单独页面，并完成一次按呼号查询且返回了该呼号的收卡信息
- **那么** 结果区域必须提供「订阅收卡」按钮
- **并且** 必须提示用户：订阅后将收到该呼号相关的卡片分发/物流信息（如「订阅后，该呼号的卡片分发与物流动态将推送至您的微信」）
- **并且** 用户点击「订阅收卡」后，进入微信公众平台要求的授权流程（如跳转微信授权页）

#### 场景：微信授权后建立呼号–openid 绑定

- **当** 用户在「订阅收卡」流程中按微信公众平台要求完成授权（提供用户信息/授权后带回 code）
- **那么** 服务端必须用授权得到的 code 换取 openid（及必要用户信息）
- **并且** 将当前查询的**呼号**与得到的 **openid** 建立绑定并写入 D1（同一呼号可绑定多个用户，即一呼号多 openid）
- **并且** 向用户展示订阅成功提示；重复订阅同一呼号时可按幂等处理（已绑定则提示已订阅）

#### 场景：顺丰推送时按绑定关系向对应用户推送

- **当** 顺丰路由推送接口解析出呼号，且微信推送功能已启用
- **那么** 服务端必须从 D1 查询**该呼号**下通过「订阅收卡」建立的绑定关系，得到对应的 openid 列表
- **并且** 对每个 openid 调用微信「发送模板消息」接口，模板内容包含运单号、路由描述（如 remark）、时间等卡片分发/物流信息
- **并且** 若该呼号无绑定用户，则仅落库路由数据，不发送微信；发送失败时记录日志，不影响向顺丰返回 0000
