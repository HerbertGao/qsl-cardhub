# sf-express-integration Specification

## Purpose
TBD - created by archiving change add-sf-express-waybill. Update Purpose after archive.
## 需求
### 需求：顺丰配置管理

系统**必须**提供顺丰速运 API 配置管理功能，支持默认预配置参数和自定义参数两种模式。

#### 场景：配置界面智能展开面板

**前提条件：**
- 用户打开顺丰速运配置页面

**预期结果：**
- 如果未配置 API 凭据（顾客编码为空），自动展开「API 凭据配置」面板
- 如果已配置 API 凭据，自动展开「寄件人信息」面板

---

#### 场景：使用默认预配置参数

**前提条件：**
- 配置文件中存在有效的默认 API 参数

**操作步骤：**
1. 用户打开「数据配置 > 顺丰速运」页面
2. 用户在「参数来源」中选择「使用默认参数」
3. 用户选择环境（生产/沙箱）
4. 用户点击「保存」

**预期结果：**
- 系统使用配置文件中的默认参数
- 顾客编码和校验码输入框显示为只读状态
- 显示风险警告提示「该参数不可滥用，有随时停用或更换的风险，请尽量使用自定义参数」
- 配置保存成功后显示「已保存凭据」状态

---

#### 场景：使用自定义参数

**前提条件：**
- 用户选择使用自定义参数

**操作步骤：**
1. 用户在「参数来源」中选择「使用自定义参数」
2. 系统显示顺丰开放平台申请提示和链接
3. 用户输入自己的顾客编码和校验码
4. 用户点击「保存」

**预期结果：**
- 显示提示文字「前往 顺丰开放平台 申请您自己的 API 凭据」
- 提示中的「顺丰开放平台」为可点击链接，指向 https://open.sf-express.com/
- 输入框可编辑
- 配置保存成功

---

#### 场景：默认参数不可用时

**前提条件：**
- 配置文件中未配置默认参数或参数无效

**操作步骤：**
1. 用户打开「数据配置 > 顺丰速运」页面

**预期结果：**
- 「使用默认参数」选项被禁用
- 自动选中「使用自定义参数」
- 显示自定义参数输入界面

---

### 需求：运单面单打印
系统**必须**支持通过顺丰云打印 API 打印运单面单，并保证顺丰打印链路在兼容参数策略下与统一打印行为保持一致。

#### 场景：从卡片列表打印面单（两步流程）
- **当** 用户在卡片列表中输入运单号并完成“获取预览 -> 确认打印”两步流程
- **那么** 系统必须先展示可确认的面单预览，再执行打印
- **并且** 打印阶段必须使用全局 TSPL 生效参数生成 TSPL
- **并且** 打印成功后必须返回成功提示

#### 场景：从分发界面打印面单
- **当** 用户在分发对话框点击“打印面单”并完成两步流程
- **那么** 系统必须自动带入默认运单号并允许用户修正
- **并且** 最终打印必须走与卡片列表一致的顺丰参数策略

#### 场景：获取面单失败处理
- **当** 运单号无效或顺丰接口返回错误
- **那么** 系统必须显示中文错误信息
- **并且** 在获取失败时禁止进入打印阶段

### 需求：API 数字签名

系统**必须**使用数字签名方式进行顺丰 API 认证。

#### 场景：计算请求签名

**输入：**
- msgData：业务 JSON 字符串
- timestamp：当前时间戳（毫秒）
- checkWord：校验码

**计算步骤：**
1. 拼接字符串：`msgData + timestamp + checkWord`
2. 对拼接结果进行 MD5 哈希（UTF-8 编码）
3. 对 MD5 结果进行 Base64 编码

**预期结果：**
- 生成的 msgDigest 可通过顺丰 API 验证

---

### 需求：PDF 转 TSPL 打印
系统**必须**将 PDF 面单转换为 TSPL 指令进行打印，并确保 TSPL 头参数来源可追踪且可配置。

#### 场景：PDF 渲染为点阵
- **当** 系统接收到顺丰面单 PDF
- **那么** 系统必须将 PDF 渲染为灰度图并转换为可打印位图数据
- **并且** 渲染尺寸必须使用顺丰面单固定规格 `76mm x 130mm @ 203 DPI`

#### 场景：生成 TSPL 指令
- **当** 系统根据位图生成 TSPL 指令
- **那么** 指令必须包含 SIZE、GAP、DIRECTION、CLS、BITMAP、PRINT
- **并且** GAP 与 DIRECTION 必须来自全局打印配置而非顺丰模块硬编码
- **并且** 系统必须记录关键指令头参数用于排查

### 需求：寄件人信息管理

系统**必须**提供寄件人信息的保存和管理功能。

#### 场景：添加寄件人信息

**前提条件：**
- 用户已打开顺丰速运配置页面

**操作步骤：**
1. 用户在配置页面点击「管理寄件人」按钮
2. 系统打开寄件人管理对话框
3. 用户点击「添加寄件人」
4. 用户填写寄件人信息：
   - 姓名（必填）
   - 电话（必填）
   - 手机（可选）
   - 省市区（通过地址选择器选择，基于 data_location 数据）
   - 详细地址（必填）
5. 用户可选择「设为默认寄件人」
6. 用户点击「保存」

**预期结果：**
- 寄件人信息保存成功
- 如果设为默认，其他寄件人的默认状态被取消
- 寄件人信息加密存储到本地数据库

#### 场景：编辑寄件人信息

**操作步骤：**
1. 用户在寄件人列表中点击「编辑」按钮
2. 系统打开编辑对话框，预填现有信息
3. 用户修改信息
4. 用户点击「保存」

**预期结果：**
- 寄件人信息更新成功
- 列表显示更新后的信息

#### 场景：删除寄件人信息

**操作步骤：**
1. 用户在寄件人列表中点击「删除」按钮
2. 系统显示确认对话框
3. 用户确认删除

**预期结果：**
- 寄件人信息从数据库中删除
- 如果删除的是默认寄件人，系统自动选择第一个寄件人为默认

#### 场景：地址选择器

**操作步骤：**
1. 用户在寄件人表单中点击「省市区」选择器
2. 系统显示三级联动选择器（省-市-区）
3. 用户依次选择省、市、区

**预期结果：**
- 地址数据基于 data_location 项目（符合 GB/T 2260 标准）
- 选择后自动填充到表单
- 支持搜索功能

---

### 需求：顺丰下单功能

系统**必须**支持通过顺丰开放平台 API 创建订单。

#### 场景：从分发界面下单

**前提条件：**
- 用户已配置顺丰凭据
- 用户已配置至少一个寄件人信息
- 用户在卡片分发界面选择了"快递"方式

**操作步骤：**
1. 用户在分发对话框中点击「下顺丰订单」按钮
2. 系统打开下单对话框
3. 系统自动预填默认寄件人信息
4. 用户填写或确认收件人信息：
   - 收件人姓名（必填）
   - 收件人电话（必填）
   - 收件人手机（可选）
   - 收件地址（省市区详细地址，支持地址选择器）
5. 用户确认订单信息
6. 用户点击「提交订单」
7. 系统调用 EXP_RECE_CREATE_ORDER 接口

**预期结果：**
- 订单创建成功，返回订单号（orderId）
- 系统显示「二次确认」对话框
- 订单保存到本地数据库，状态为"待确认"
- 如果创建失败，显示具体错误信息

#### 场景：订单二次确认（立即确认）

**前提条件：**
- 订单已创建成功

**操作步骤：**
1. 系统显示「二次确认」对话框，显示订单信息预览
2. 用户点击「立即确认」
3. 系统调用 EXP_RECE_UPDATE_ORDER 接口确认订单

**预期结果：**
- 订单确认成功，获取运单号（waybillNo）
- 订单状态更新为"已确认"
- 系统自动回填运单号到卡片分发备注
- 系统显示「打印面单」选项

#### 场景：订单二次确认（稍后确认）

**前提条件：**
- 订单已创建成功

**操作步骤：**
1. 系统显示「二次确认」对话框
2. 用户点击「稍后确认」

**预期结果：**
- 对话框关闭
- 订单保存到订单列表，状态为"待确认"
- 用户可在订单列表中稍后确认

#### 场景：下单数据验证

**操作步骤：**
1. 用户填写下单表单
2. 用户点击「提交订单」
3. 系统验证必填字段

**预期结果：**
- 如果必填字段缺失，显示具体错误提示
- 如果电话号码格式不正确，显示格式错误提示
- 如果地址信息不完整，提示补充地址信息
- 验证通过后才调用 API

---

### 需求：顺丰订单管理

系统**必须**提供订单列表页面，支持订单的查询、确认、取消和打印。

#### 场景：查看订单列表

**前提条件：**
- 系统中存在至少一个订单

**操作步骤：**
1. 用户打开「顺丰订单列表」页面（从菜单或分发界面进入）
2. 系统显示订单列表

**预期结果：**
- 列表显示以下信息：
  - 订单号（orderId）
  - 运单号（waybillNo，确认后显示）
  - 关联卡片信息（呼号、项目名称、数量，通过 LEFT JOIN 关联查询）
  - 订单状态（待确认、已确认、已取消、已打印）
  - 下单时间
  - 收件人信息（姓名、电话、地址）
  - 付款方式（寄方付、收方付、第三方付）
  - 托寄物名称
- 支持按状态筛选
- 支持按时间排序

#### 场景：确认待确认订单

**前提条件：**
- 订单列表中存在状态为"待确认"的订单

**操作步骤：**
1. 用户在订单列表中点击「确认订单」按钮
2. 系统显示确认对话框
3. 用户确认操作
4. 系统调用 EXP_RECE_UPDATE_ORDER 接口确认订单

**预期结果：**
- 订单确认成功，获取运单号
- 订单状态更新为"已确认"
- 如果订单关联卡片，自动回填运单号到卡片分发备注
- 显示「打印面单」按钮

#### 场景：取消待确认订单

**前提条件：**
- 订单列表中存在状态为"待确认"的订单

**操作步骤：**
1. 用户在订单列表中点击「取消订单」按钮
2. 系统显示确认对话框
3. 用户确认取消
4. 系统调用 EXP_RECE_UPDATE_ORDER 接口取消订单（waybillNoInfoList 传空数组）

**预期结果：**
- 订单取消成功
- 订单状态更新为"已取消"
- 订单从待处理列表中移除

#### 场景：取消已确认订单

**前提条件：**
- 订单列表中存在状态为"已确认"的订单
- 订单已获取运单号

**操作步骤：**
1. 用户在订单列表中点击「取消订单」按钮
2. 系统显示确认对话框
3. 用户确认取消
4. 系统调用 EXP_RECE_UPDATE_ORDER 接口取消订单（waybillNoInfoList 需传入运单号）

**预期结果：**
- 订单取消成功
- 订单状态更新为"已取消"
- 运单号保留在订单记录中（用于历史追溯）

#### 场景：查询订单状态

**操作步骤：**
1. 用户在订单列表中点击「查询订单」按钮
2. 系统调用 EXP_RECE_SEARCH_ORDER_RESP 接口查询订单

**预期结果：**
- 返回订单最新状态和详细信息
- 如果订单状态有变化，更新本地数据库
- 显示订单详细信息（包括运单号、物流状态等）

#### 场景：从订单列表打印面单

**前提条件：**
- 订单状态为"已确认"，已获取运单号

**操作步骤：**
1. 用户在订单列表中点击「打印面单」按钮
2. 系统打开运单打印对话框，自动带入运单号
3. 用户点击「提交打印」获取预览
4. 用户确认后点击「打印」

**预期结果：**
- 打印流程同「运单面单打印」需求
- 打印成功后，订单状态可更新为"已打印"（可选）

#### 场景：查看订单详情

**操作步骤：**
1. 用户在订单列表中点击「查看详情」按钮
2. 系统显示订单详情对话框

**预期结果：**
- 显示订单完整信息：
  - 订单号、运单号
  - 订单状态
  - 寄件人信息
  - 收件人信息
  - 快件信息（托寄物名称、数量）
  - 付款方式
  - 创建时间、更新时间
  - 关联卡片信息（呼号、项目、数量）

---

### 需求：订单与卡片关联

系统**必须**支持订单与卡片的关联，并自动回填运单号。

#### 场景：自动回填运单号到卡片备注

**前提条件：**
- 订单已确认，已获取运单号
- 订单关联了卡片

**操作步骤：**
1. 系统检测到订单确认成功
2. 系统查找关联的卡片
3. 系统自动将运单号回填到卡片的分发备注

**预期结果：**
- 卡片的分发备注字段自动更新为运单号
- 用户可在卡片列表中看到运单号
- 用户可直接从卡片列表打印面单

#### 场景：从卡片查看关联订单

**前提条件：**
- 卡片已关联订单

**操作步骤：**
1. 用户在卡片列表中点击「查看订单」按钮（如果备注包含运单号）
2. 系统打开订单详情对话框

**预期结果：**
- 显示关联订单的完整信息
- 支持跳转到订单列表页面

### 需求：下单前配置检查

系统**必须**在打开下单界面时检查 API 配置状态和寄件人配置状态。

#### 场景：API 未配置时打开下单界面

**前提条件：**
- 用户未配置顺丰 API 凭据

**操作步骤：**
1. 用户从分发界面点击「顺丰速运下单」按钮
2. 系统打开下单对话框

**预期结果：**
- 在寄件人信息区域上方显示警告提示「请先配置顺丰速运 API」
- 提供「去配置」按钮，点击后跳转到顺丰速运配置页面
- 「提交订单」按钮处于禁用状态

#### 场景：沙箱环境时打开下单界面

- **当** 用户已配置顺丰 API 凭据且当前环境为沙箱环境（environment 为 "sandbox"）时打开下单对话框
- **那么** 系统**必须**在对话框内、寄件人信息区域上方显示一个 `warning` 类型的 `el-alert` 组件
- **并且** alert 标题**必须**为「当前为沙箱环境」
- **并且** alert 内容**必须**说明「订单将不会被真实派发」
- **并且** alert 内容**必须**包含一个可点击的链接文字「请点击此处切换至生产环境」，点击后关闭下单对话框并导航到顺丰速运配置页面
- **并且** alert **必须**不可关闭（closable 为 false）
- **并且** alert **必须**显示图标（show-icon 为 true）
- **并且** 「提交订单」按钮**必须**保持可用状态（不因沙箱环境而禁用）

#### 场景：生产环境时打开下单界面

- **当** 用户已配置顺丰 API 凭据且当前环境为生产环境（environment 为 "production"）时打开下单对话框
- **那么** 系统**禁止**显示沙箱环境警告提示

#### 场景：寄件人未配置时的空状态展示

- **当** 用户未配置默认寄件人信息时打开下单对话框
- **那么** 寄件人信息区域**必须**显示空状态提示和「去配置」按钮
- **并且** 空状态区域的整体高度**必须**与寄件人已配置时的展示高度视觉协调，不应明显大于已配置状态

---

### 需求：下单配置跳转

系统**必须**支持从下单界面跳转到配置界面，并根据跳转来源精确定位到对应的配置 Tab。

#### 场景：从沙箱环境警告跳转到配置

- **当** 用户在沙箱环境警告中点击「请点击此处」链接
- **那么** 系统**必须**关闭下单对话框和分发对话框
- **并且** 导航到「数据配置 > 顺丰速运」页面
- **并且** 配置页面**必须**直接展示「API 凭据配置」Tab

#### 场景：从寄件人未配置状态跳转到配置

- **当** 用户在寄件人未配置的空状态中点击「去配置」按钮
- **那么** 系统**必须**关闭下单对话框和分发对话框
- **并且** 导航到「数据配置 > 顺丰速运」页面
- **并且** 配置页面**必须**直接展示「寄件人信息」Tab

#### 场景：从 API 未配置警告跳转到配置

- **当** 用户在 API 未配置警告中点击「去配置」按钮
- **那么** 系统**必须**关闭下单对话框和分发对话框
- **并且** 导航到「数据配置 > 顺丰速运」页面
- **并且** 配置页面**必须**按照默认逻辑展示对应 Tab（未配置时展示 API Tab）

#### 场景：直接从菜单进入配置页面

- **当** 用户从侧边栏菜单点击「顺丰速运」进入配置页面（不携带导航参数）
- **那么** 配置页面**必须**按照默认逻辑展示对应 Tab（已配置 API 时展示寄件人 Tab，未配置时展示 API Tab）

---

### 需求：下单表单重置

系统**必须**在每次打开下单对话框时重置收件人表单。

#### 场景：重新打开下单对话框

**前提条件：**
- 用户之前填写过收件人信息

**操作步骤：**
1. 用户打开下单对话框
2. 用户填写收件人信息
3. 用户关闭对话框（取消或完成）
4. 用户再次打开下单对话框

**预期结果：**
- 收件人表单被重置为空
- 如果有传入默认收件人信息（如从卡片地址缓存），则填充该信息
- 表单验证状态被清除，不显示之前的验证错误

### 需求：顺丰面单接入全局 TSPL 参数
系统必须让顺丰面单打印接入全局 TSPL 参数（GAP、DIRECTION），并在配置缺失或非法时回退到兼容默认值。

#### 场景：使用默认兼容参数打印
- **当** 全局 TSPL 参数缺失
- **那么** 系统必须使用默认参数 `GAP 2mm,0mm` 与 `DIRECTION 1,0` 生成 TSPL 并执行打印
- **并且** 打印行为必须不影响普通标签与地址标签打印路径

#### 场景：使用自定义参数打印
- **当** 用户在打印机配置中设置了有效的全局 GAP 与 DIRECTION
- **那么** 系统必须使用该参数生成 TSPL 并执行打印
- **并且** 系统必须在日志中记录实际生效的关键参数

#### 场景：参数非法时自动回退
- **当** 全局 GAP 或 DIRECTION 超出允许范围或格式错误
- **那么** 系统必须拒绝非法值并回退到兼容默认参数
- **并且** 系统必须返回可读错误信息或警告日志

