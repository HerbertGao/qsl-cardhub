# sf-express-integration Specification

## Purpose
TBD - created by archiving change add-sf-express-waybill. Update Purpose after archive.
## 需求
### 需求：顺丰配置管理

系统**必须**提供顺丰速运 API 配置管理功能。

#### 场景：配置顺丰凭据

**前提条件：**
- 用户已获取顺丰开放平台的顾客编码和校验码

**操作步骤：**
1. 用户打开「数据配置 > 顺丰速运」页面
2. 用户选择环境（生产/沙箱）
3. 用户输入顾客编码
4. 用户输入对应环境的校验码
5. 用户点击「保存」

**预期结果：**
- 配置保存成功
- 显示「已保存凭据」状态
- 凭据加密存储到系统钥匙串或本地加密文件

#### 场景：切换环境

**前提条件：**
- 用户已配置生产和沙箱两个环境的校验码

**操作步骤：**
1. 用户在配置页面切换环境选项

**预期结果：**
- 环境配置立即保存
- 后续 API 调用使用对应环境的地址和校验码

#### 场景：清除配置

**操作步骤：**
1. 用户点击「清除凭据」按钮
2. 系统显示确认对话框
3. 用户确认清除

**预期结果：**
- 所有顺丰相关凭据被删除
- 配置状态重置为未配置

---

### 需求：运单面单打印

系统**必须**支持通过顺丰云打印 API 打印运单面单。

#### 场景：从卡片列表打印面单（两步流程）

**前提条件：**
- 用户已配置顺丰凭据
- 用户已选择打印机

**操作步骤：**
1. 用户在卡片列表中点击某卡片的「打印面单」按钮
2. 系统打开运单打印对话框
3. 用户输入运单号
4. 用户点击「提交打印」按钮
5. 系统调用顺丰 API 获取 PDF 并显示预览
6. 用户确认预览无误后点击「打印」按钮

**预期结果：**
- 「提交打印」后显示 PDF 预览图像
- 只有成功获取 PDF 后「打印」按钮才可点击
- 点击「打印」后 PDF 转换为 TSPL 指令并发送到打印机
- 显示打印成功提示

#### 场景：从分发界面打印面单

**前提条件：**
- 用户在分发对话框中填写了备注（包含运单号）

**操作步骤：**
1. 用户在分发对话框中点击「打印面单」按钮
2. 系统打开运单打印对话框，自动带入备注作为运单号
3. 用户点击「提交打印」获取预览
4. 用户确认后点击「打印」

**预期结果：**
- 运单号输入框预填充备注内容
- 打印流程同上（两步）

#### 场景：获取面单失败处理

**前提条件：**
- 运单号不存在或签名错误

**操作步骤：**
1. 用户输入无效运单号
2. 用户点击「提交打印」

**预期结果：**
- 显示具体错误信息
- 错误信息为中文，便于用户理解
- 「打印」按钮保持禁用状态
- 用户可修改运单号后重试

---

### 需求：API 数字签名

系统**必须**使用数字签名方式进行顺丰 API 认证。

#### 场景：计算请求签名

**输入：**
- msgData：业务 JSON 字符串
- timestamp：当前时间戳（毫秒）
- checkWord：校验码

**计算步骤：**
1. 拼接字符串：`msgData + timestamp + checkWord`
2. 对拼接结果进行 MD5 哈希（UTF-8 编码）
3. 对 MD5 结果进行 Base64 编码

**预期结果：**
- 生成的 msgDigest 可通过顺丰 API 验证

---

### 需求：PDF 转 TSPL 打印

系统**必须**将 PDF 面单转换为 TSPL 指令进行打印。

#### 场景：PDF 渲染为点阵

**输入：**
- PDF 文件（76mm × 130mm）
- 目标 DPI：203

**处理步骤：**
1. 加载 PDF 文件
2. 渲染为 RGB 位图（608 × 1040 像素）
3. 转换为灰度图像
4. 使用阈值 128 进行二值化
5. 转换为 1bpp 点阵（MSB first）

**预期结果：**
- 输出 1bpp 点阵数据
- 尺寸为 76 bytes × 1040 行

#### 场景：生成 TSPL BITMAP 指令

**输入：**
- 1bpp 点阵数据

**预期输出：**
```
SIZE 76 mm, 130 mm
GAP 0 mm, 0 mm
DIRECTION 1,0
CLS
BITMAP 0,0,76,1040,0,<binary_data>
PRINT 1,1
```

---

### 需求：寄件人信息管理

系统**必须**提供寄件人信息的保存和管理功能。

#### 场景：添加寄件人信息

**前提条件：**
- 用户已打开顺丰速运配置页面

**操作步骤：**
1. 用户在配置页面点击「管理寄件人」按钮
2. 系统打开寄件人管理对话框
3. 用户点击「添加寄件人」
4. 用户填写寄件人信息：
   - 姓名（必填）
   - 电话（必填）
   - 手机（可选）
   - 省市区（通过地址选择器选择，基于 data_location 数据）
   - 详细地址（必填）
5. 用户可选择「设为默认寄件人」
6. 用户点击「保存」

**预期结果：**
- 寄件人信息保存成功
- 如果设为默认，其他寄件人的默认状态被取消
- 寄件人信息加密存储到本地数据库

#### 场景：编辑寄件人信息

**操作步骤：**
1. 用户在寄件人列表中点击「编辑」按钮
2. 系统打开编辑对话框，预填现有信息
3. 用户修改信息
4. 用户点击「保存」

**预期结果：**
- 寄件人信息更新成功
- 列表显示更新后的信息

#### 场景：删除寄件人信息

**操作步骤：**
1. 用户在寄件人列表中点击「删除」按钮
2. 系统显示确认对话框
3. 用户确认删除

**预期结果：**
- 寄件人信息从数据库中删除
- 如果删除的是默认寄件人，系统自动选择第一个寄件人为默认

#### 场景：地址选择器

**操作步骤：**
1. 用户在寄件人表单中点击「省市区」选择器
2. 系统显示三级联动选择器（省-市-区）
3. 用户依次选择省、市、区

**预期结果：**
- 地址数据基于 data_location 项目（符合 GB/T 2260 标准）
- 选择后自动填充到表单
- 支持搜索功能

---

### 需求：顺丰下单功能

系统**必须**支持通过顺丰开放平台 API 创建订单。

#### 场景：从分发界面下单

**前提条件：**
- 用户已配置顺丰凭据
- 用户已配置至少一个寄件人信息
- 用户在卡片分发界面选择了"快递"方式

**操作步骤：**
1. 用户在分发对话框中点击「下顺丰订单」按钮
2. 系统打开下单对话框
3. 系统自动预填默认寄件人信息
4. 用户填写或确认收件人信息：
   - 收件人姓名（必填）
   - 收件人电话（必填）
   - 收件人手机（可选）
   - 收件地址（省市区详细地址，支持地址选择器）
5. 用户确认订单信息
6. 用户点击「提交订单」
7. 系统调用 EXP_RECE_CREATE_ORDER 接口

**预期结果：**
- 订单创建成功，返回订单号（orderId）
- 系统显示「二次确认」对话框
- 订单保存到本地数据库，状态为"待确认"
- 如果创建失败，显示具体错误信息

#### 场景：订单二次确认（立即确认）

**前提条件：**
- 订单已创建成功

**操作步骤：**
1. 系统显示「二次确认」对话框，显示订单信息预览
2. 用户点击「立即确认」
3. 系统调用 EXP_RECE_UPDATE_ORDER 接口确认订单

**预期结果：**
- 订单确认成功，获取运单号（waybillNo）
- 订单状态更新为"已确认"
- 系统自动回填运单号到卡片分发备注
- 系统显示「打印面单」选项

#### 场景：订单二次确认（稍后确认）

**前提条件：**
- 订单已创建成功

**操作步骤：**
1. 系统显示「二次确认」对话框
2. 用户点击「稍后确认」

**预期结果：**
- 对话框关闭
- 订单保存到订单列表，状态为"待确认"
- 用户可在订单列表中稍后确认

#### 场景：下单数据验证

**操作步骤：**
1. 用户填写下单表单
2. 用户点击「提交订单」
3. 系统验证必填字段

**预期结果：**
- 如果必填字段缺失，显示具体错误提示
- 如果电话号码格式不正确，显示格式错误提示
- 如果地址信息不完整，提示补充地址信息
- 验证通过后才调用 API

---

### 需求：顺丰订单管理

系统**必须**提供订单列表页面，支持订单的查询、确认、取消和打印。

#### 场景：查看订单列表

**前提条件：**
- 系统中存在至少一个订单

**操作步骤：**
1. 用户打开「顺丰订单列表」页面（从菜单或分发界面进入）
2. 系统显示订单列表

**预期结果：**
- 列表显示以下信息：
  - 订单号（orderId）
  - 运单号（waybillNo，确认后显示）
  - 关联卡片信息（呼号、项目名称、数量，通过 LEFT JOIN 关联查询）
  - 订单状态（待确认、已确认、已取消、已打印）
  - 下单时间
  - 收件人信息（姓名、电话、地址）
  - 付款方式（寄方付、收方付、第三方付）
  - 托寄物名称
- 支持按状态筛选
- 支持按时间排序

#### 场景：确认待确认订单

**前提条件：**
- 订单列表中存在状态为"待确认"的订单

**操作步骤：**
1. 用户在订单列表中点击「确认订单」按钮
2. 系统显示确认对话框
3. 用户确认操作
4. 系统调用 EXP_RECE_UPDATE_ORDER 接口确认订单

**预期结果：**
- 订单确认成功，获取运单号
- 订单状态更新为"已确认"
- 如果订单关联卡片，自动回填运单号到卡片分发备注
- 显示「打印面单」按钮

#### 场景：取消待确认订单

**前提条件：**
- 订单列表中存在状态为"待确认"的订单

**操作步骤：**
1. 用户在订单列表中点击「取消订单」按钮
2. 系统显示确认对话框
3. 用户确认取消
4. 系统调用 EXP_RECE_UPDATE_ORDER 接口取消订单（waybillNoInfoList 传空数组）

**预期结果：**
- 订单取消成功
- 订单状态更新为"已取消"
- 订单从待处理列表中移除

#### 场景：取消已确认订单

**前提条件：**
- 订单列表中存在状态为"已确认"的订单
- 订单已获取运单号

**操作步骤：**
1. 用户在订单列表中点击「取消订单」按钮
2. 系统显示确认对话框
3. 用户确认取消
4. 系统调用 EXP_RECE_UPDATE_ORDER 接口取消订单（waybillNoInfoList 需传入运单号）

**预期结果：**
- 订单取消成功
- 订单状态更新为"已取消"
- 运单号保留在订单记录中（用于历史追溯）

#### 场景：查询订单状态

**操作步骤：**
1. 用户在订单列表中点击「查询订单」按钮
2. 系统调用 EXP_RECE_SEARCH_ORDER_RESP 接口查询订单

**预期结果：**
- 返回订单最新状态和详细信息
- 如果订单状态有变化，更新本地数据库
- 显示订单详细信息（包括运单号、物流状态等）

#### 场景：从订单列表打印面单

**前提条件：**
- 订单状态为"已确认"，已获取运单号

**操作步骤：**
1. 用户在订单列表中点击「打印面单」按钮
2. 系统打开运单打印对话框，自动带入运单号
3. 用户点击「提交打印」获取预览
4. 用户确认后点击「打印」

**预期结果：**
- 打印流程同「运单面单打印」需求
- 打印成功后，订单状态可更新为"已打印"（可选）

#### 场景：查看订单详情

**操作步骤：**
1. 用户在订单列表中点击「查看详情」按钮
2. 系统显示订单详情对话框

**预期结果：**
- 显示订单完整信息：
  - 订单号、运单号
  - 订单状态
  - 寄件人信息
  - 收件人信息
  - 快件信息（托寄物名称、数量）
  - 付款方式
  - 创建时间、更新时间
  - 关联卡片信息（呼号、项目、数量）

---

### 需求：订单与卡片关联

系统**必须**支持订单与卡片的关联，并自动回填运单号。

#### 场景：自动回填运单号到卡片备注

**前提条件：**
- 订单已确认，已获取运单号
- 订单关联了卡片

**操作步骤：**
1. 系统检测到订单确认成功
2. 系统查找关联的卡片
3. 系统自动将运单号回填到卡片的分发备注

**预期结果：**
- 卡片的分发备注字段自动更新为运单号
- 用户可在卡片列表中看到运单号
- 用户可直接从卡片列表打印面单

#### 场景：从卡片查看关联订单

**前提条件：**
- 卡片已关联订单

**操作步骤：**
1. 用户在卡片列表中点击「查看订单」按钮（如果备注包含运单号）
2. 系统打开订单详情对话框

**预期结果：**
- 显示关联订单的完整信息
- 支持跳转到订单列表页面

