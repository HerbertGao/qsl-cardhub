# cloud-database-support Specification

## Purpose
TBD - created by archiving change add-card-management. Update Purpose after archive.
## 需求
### 需求：数据导出功能

系统**必须**支持将本地数据库导出为 JSON 文件，便于备份和迁移。

#### 场景：导出全部数据

**前提条件：**
- 本地数据库已初始化

**操作步骤：**
1. 用户打开"数据管理"页面
2. 用户点击"导出数据"按钮
3. 系统弹出文件保存对话框
4. 用户选择保存位置和文件名
5. 用户确认保存

**预期结果：**
- 文件扩展名为 `.qslhub`
- 文件格式为 JSON（UTF-8 编码）
- 文件包含元信息：
  - `version`: 导出格式版本（"1.0"）
  - `db_version`: 数据库版本号（整数）
  - `db_version_display`: 可读版本号（如 "2026.1.23.003"）
  - `app_version`: 应用版本号
  - `exported_at`: 导出时间戳（ISO 8601 格式）
- 文件包含所有表的数据：
  - `tables.projects`: 项目列表
  - `tables.cards`: 卡片列表
  - `tables.sf_senders`: 顺丰寄件人列表
  - `tables.sf_orders`: 顺丰订单列表
- 导出成功后显示统计信息（项目数、卡片数、寄件人数、订单数）
- 默认文件名格式：`qslhub_backup_YYYYMMDD_HHmmss.qslhub`

#### 场景：空数据库导出

**前提条件：**
- 本地数据库已初始化但无数据

**操作步骤：**
1. 用户点击"导出数据"

**预期结果：**
- 导出成功
- 文件中表数据为空数组
- 版本信息正确

---

### 需求：数据导入功能

系统**必须**支持从 JSON 文件导入数据到本地数据库，并进行版本兼容性检查。

#### 场景：导入兼容版本数据

**前提条件：**
- 导入文件的 `db_version` <= 本地数据库版本
- 导入文件格式正确

**操作步骤：**
1. 用户打开"数据管理"页面
2. 用户点击"导入数据"按钮
3. 系统弹出文件选择对话框（过滤 `.qslhub` 文件）
4. 用户选择文件
5. 系统显示导入预览对话框：
   - 文件版本信息
   - 导出时间
   - 数据统计（项目数、卡片数等）
   - 版本兼容性状态
6. 系统显示覆盖警告："导入将覆盖本地所有数据，此操作不可逆"
7. 用户确认导入

**预期结果：**
- 本地数据被清空（事务内）
- 导入文件中的数据写入数据库（事务内）
- 如果发生错误，事务回滚，本地数据不变
- 导入成功后显示统计信息
- 页面数据自动刷新

#### 场景：拒绝高版本数据导入

**前提条件：**
- 导入文件的 `db_version` > 本地数据库版本

**操作步骤：**
1. 用户选择高版本的 `.qslhub` 文件

**预期结果：**
- 预览对话框显示错误状态
- 错误信息："导入文件的数据库版本（X.X.X.XXX）高于本地版本（Y.Y.Y.YYY），请升级应用后再导入"
- "确认导入"按钮禁用
- 本地数据不受影响

#### 场景：导入格式错误的文件

**前提条件：**
- 选择的文件不是有效的 JSON 或缺少必要字段

**操作步骤：**
1. 用户选择格式错误的文件

**预期结果：**
- 显示错误提示："文件格式错误，请选择有效的 QSL-CardHub 导出文件"
- 本地数据不受影响

#### 场景：导入过程中发生错误

**前提条件：**
- 导入文件格式正确
- 数据插入过程中发生错误（如外键约束失败）

**操作步骤：**
1. 用户确认导入
2. 系统开始导入
3. 导入过程中发生错误

**预期结果：**
- 事务回滚
- 本地数据保持不变
- 显示具体错误信息

---

### 需求：云端数据同步

系统**必须**支持将本地数据全量同步到用户自建的云端 API。

#### 场景：配置云端 API

**前提条件：**
- 用户已部署云端接收服务
- 用户已获取 API 地址和 API Key

**操作步骤：**
1. 用户打开"数据管理"页面
2. 用户在"云端同步"区域输入 API 地址
3. 用户输入 API Key
4. 用户点击"保存配置"

**预期结果：**
- API 地址保存到配置文件
- API Key 加密存储（使用凭据加密存储系统）
- 存储键名：`qsl-cardhub:sync:api_key`
- 显示保存成功提示
- 首次保存时自动生成 client_id（UUID 格式）

#### 场景：测试云端连接

**前提条件：**
- 已配置云端 API 地址和 API Key

**操作步骤：**
1. 用户点击"测试连接"按钮

**预期结果：**
- 发送 GET 请求到 `{api_url}/ping`
- 请求头携带 `Authorization: Bearer {api_key}`
- 连接成功：显示"连接成功"（绿色提示）
- 连接失败：显示具体错误信息：
  - 网络不可达："无法连接到服务器，请检查网络"
  - 401 错误："API Key 无效，请检查配置"
  - 其他错误：显示服务器返回的错误信息

#### 场景：执行全量同步

**前提条件：**
- 已配置云端 API
- 连接测试通过

**操作步骤：**
1. 用户点击"立即同步"按钮
2. 系统显示同步进度

**预期结果：**
- 发送 POST 请求到 `{api_url}/sync`
- 请求头携带 `Authorization: Bearer {api_key}`
- 请求体包含：
  - `client_id`: 客户端标识
  - `sync_time`: 同步时间戳
  - `data`: 所有本地数据（projects, cards, sf_senders, sf_orders）
- 同步成功：
  - 显示统计信息（项目数、卡片数等）
  - 记录上次同步时间
- 同步失败：显示具体错误信息

#### 场景：同步认证失败

**前提条件：**
- API Key 无效或过期

**操作步骤：**
1. 用户点击"立即同步"

**预期结果：**
- 显示错误提示："认证失败，请检查 API Key"
- 本地数据不受影响

#### 场景：清除同步配置

**操作步骤：**
1. 用户点击"清除配置"按钮
2. 系统显示确认对话框
3. 用户确认

**预期结果：**
- 清除 API 地址配置
- 清除 API Key
- 清除上次同步时间
- 保留 client_id（便于云端识别）
- 表单恢复空白状态

---

### 需求：云端 API 规范

系统**必须**提供云端 API 规范文档，供用户自行实现接收服务。

#### 场景：API 规范文档内容

**规范包含：**

1. **认证方式**
   - API Key（Bearer Token）
   - 在请求头中携带：`Authorization: Bearer {api_key}`

2. **接口列表**
   - `GET /ping` - 连接测试
   - `POST /sync` - 全量同步

3. **连接测试接口**
   ```
   GET /ping
   Authorization: Bearer {api_key}

   响应（200）：
   {
     "success": true,
     "message": "pong",
     "server_time": "2026-01-23T14:30:00+08:00"
   }
   ```

4. **同步接口**
   ```
   POST /sync
   Authorization: Bearer {api_key}
   Content-Type: application/json

   请求体：
   {
     "client_id": "uuid",
     "sync_time": "2026-01-23T14:30:00+08:00",
     "data": {
       "projects": [...],
       "cards": [...],
       "sf_senders": [...],
       "sf_orders": [...]
     }
   }

   响应（200）：
   {
     "success": true,
     "message": "同步成功",
     "received_at": "2026-01-23T14:30:01+08:00",
     "stats": {
       "projects": 10,
       "cards": 500,
       "sf_senders": 5,
       "sf_orders": 100
     }
   }
   ```

5. **错误响应格式**
   ```json
   {
     "success": false,
     "message": "错误描述"
   }
   ```

6. **数据结构定义**
   - Project 结构
   - Card 结构
   - SFSender 结构
   - SFOrder 结构

7. **云端实现建议**
   - 按 `client_id` 隔离不同客户端数据
   - 实现请求频率限制
   - 使用 HTTPS
   - 验证 API Key 有效性

---

