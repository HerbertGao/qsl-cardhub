# configuration-management Specification

## Purpose
TBD - created by archiving change config-management-improvements. Update Purpose after archive.
## 需求
### 需求：任务名称持久化
配置文件必须支持存储任务名称字段，该字段在打印时作为模板数据传入。

#### 场景：保存带有任务名称的配置
- **当** 用户创建或更新配置，并设置任务名称为"CRSA 2区卡片"
- **那么** 系统必须将 `task_name` 字段保存到配置文件中
- **并且** 字段值为 `"CRSA 2区卡片"`

#### 场景：加载包含任务名称的配置
- **当** 系统加载配置文件
- **那么** 系统必须读取 `task_name` 字段
- **并且** 在前端配置界面显示该任务名称

#### 场景：任务名称未设置
- **当** 用户创建新配置，未填写任务名称
- **那么** 配置文件中可以不包含 `task_name` 字段（或值为 null）
- **并且** 前端界面显示为空

#### 场景：任务名称在打印时使用
- **当** 用户执行打印操作
- **那么** 系统必须从当前配置读取 `task_name` 字段
- **并且** 将其作为 `task_name` 模板数据传入打印模板

### 需求：模板路径配置
配置文件必须存储实际的模板文件路径，而非描述性名称。

#### 场景：新建配置使用呼号模板
- **当** 用户创建新配置
- **那么** 系统必须设置 `template.path` 为 `"callsign.toml"`
- **并且** 该路径是相对于 `config/templates/` 目录的相对路径

#### 场景：加载配置并解析模板路径
- **当** 系统需要加载模板文件
- **那么** 系统必须从配置的 `template.path` 字段读取模板文件名
- **并且** 拼接为完整路径：`config/templates/{template.path}`
- **并且** 从该路径加载模板配置

#### 场景：模板文件不存在时的回退
- **当** 配置指定的模板文件路径不存在
- **那么** 系统必须回退到 `config/templates/callsign.toml`
- **并且** 记录警告日志，说明原路径和回退路径

### 需求：移除纸张规格字段
配置文件禁止包含纸张规格信息，纸张尺寸必须完全由模板文件定义。

#### 场景：新建配置不包含纸张规格
- **当** 用户创建新配置
- **那么** 生成的配置文件中必须不包含 `paper` 字段
- **并且** 配置结构体中不包含 `paper` 属性

#### 场景：前端不显示纸张规格
- **当** 用户在配置管理界面查看配置详情
- **那么** 界面必须不显示纸张规格相关字段（宽度、高度）
- **并且** 如需显示纸张信息，从模板文件读取

#### 场景：保存配置时不包含纸张规格
- **当** 用户修改并保存配置
- **那么** 序列化的配置文件中必须不包含 `paper` 字段

### 需求：移除打印机型号字段
配置文件禁止包含打印机型号信息,打印机型号是项目级常量,不属于配置内容。

#### 场景：新建配置不包含打印机型号
- **当** 用户创建新配置
- **那么** 生成的配置文件中必须不包含 `printer.model` 字段
- **并且** 配置结构体中不包含 `model` 属性

#### 场景：前端不显示打印机型号
- **当** 用户在配置管理界面查看或创建配置
- **那么** 界面必须不显示打印机型号字段
- **并且** 只显示系统打印机名称选择器

#### 场景：保存配置时不包含打印机型号
- **当** 用户修改并保存配置
- **那么** 序列化的配置文件中必须不包含 `printer.model` 字段

### 需求：东八区时间戳
配置文件中的创建时间和更新时间必须使用东八区（UTC+8）时区。

#### 场景：创建配置时使用东八区时间
- **当** 用户创建新配置
- **那么** 系统必须使用东八区（UTC+8）当前时间
- **并且** `created_at` 字段格式为 `"2026-01-21T12:00:00+08:00"`
- **并且** `updated_at` 字段格式为 `"2026-01-21T12:00:00+08:00"`

#### 场景：更新配置时使用东八区时间
- **当** 用户修改并保存配置
- **那么** 系统必须更新 `updated_at` 字段为当前东八区时间
- **并且** 时区偏移量为 `+08:00`

#### 场景：配置文件中的时间戳可读性
- **当** 用户手动查看配置文件
- **那么** 时间戳必须包含时区信息（`+08:00`）
- **并且** 时间必须是本地时间，便于理解

### 需求：配置文件格式
配置文件必须使用 TOML 格式，包含必要字段，结构清晰。

#### 场景：配置文件包含所有必需字段
- **当** 系统保存配置文件
- **那么** 文件必须包含以下字段：
  - `id`：配置唯一标识符（UUID）
  - `name`：配置名称
  - `created_at`：创建时间（东八区）
  - `updated_at`：更新时间（东八区）
  - `platform.os`：操作系统
  - `platform.arch`：CPU 架构
  - `printer.name`：系统中的打印机名称
  - `template.path`：模板文件路径
- **并且** 可选字段：
  - `task_name`：任务名称（可为空）

#### 场景：配置文件格式示例
- **当** 系统生成配置文件
- **那么** 文件格式必须如下：
```toml
id = "uuid-v4-string"
name = "配置名称"
task_name = "任务名称"  # 可选
created_at = "2026-01-21T12:00:00+08:00"
updated_at = "2026-01-21T12:00:00+08:00"

[platform]
os = "macOS"
arch = "arm64"

[printer]
name = "Deli DL-888C"

[template]
path = "callsign.toml"
```

### 需求：单配置模式支持全局 TSPL 参数
单配置模式必须支持保存全局 TSPL 参数（`gap_mm`、`gap_offset_mm`、`direction`），并持久化到 `printer.toml`。

#### 场景：读取旧配置文件
- **当** 现有 `printer.toml` 不包含 `tspl` 字段
- **那么** 系统必须自动使用默认值 `gap_mm=2`、`gap_offset_mm=0`、`direction=1,0`
- **并且** 保持原有打印机名称等配置可正常读取

#### 场景：保存新配置文件
- **当** 用户在打印机配置页面修改 GAP 或 DIRECTION
- **那么** 系统必须将新值写入 `printer.toml` 的 `tspl` 配置段
- **并且** 不得影响既有字段结构

### 需求：打印机配置界面支持 TSPL 参数编辑
打印机配置界面必须提供 GAP 与 DIRECTION 的可编辑项，并显示推荐默认值。

#### 场景：界面默认值
- **当** 用户首次进入打印机配置页面且未存在历史 TSPL 配置
- **那么** 界面必须显示默认值 `GAP 2mm,0mm` 与 `DIRECTION 1,0`

#### 场景：界面修改生效
- **当** 用户修改 GAP 或 DIRECTION 并触发自动保存
- **那么** 系统必须保存配置并用于后续所有打印任务

