# card-entry-and-management Specification

## Purpose
TBD - created by archiving change add-card-management. Update Purpose after archive.
## 需求
### 需求：卡片数据模型

系统必须定义卡片数据模型，支持卡片录入、列表展示和状态管理。

#### 场景：定义卡片数据表结构

- **当** 系统初始化数据库
- **那么** 必须创建 `cards` 表
- **并且** 表结构必须包含以下字段：
  - `id`: TEXT PRIMARY KEY（UUID 格式）
  - `project_id`: TEXT NOT NULL（外键关联 projects 表）
  - `creator_id`: TEXT（预留字段，Phase 3 使用）
  - `callsign`: TEXT NOT NULL（呼号）
  - `qty`: INTEGER NOT NULL CHECK(qty > 0)（数量）
  - `status`: TEXT NOT NULL CHECK(status IN ('pending', 'distributed', 'returned'))
  - `metadata`: TEXT（JSON 字符串，存储分发/退卡信息）
  - `created_at`: TEXT NOT NULL（东八区时间戳）
  - `updated_at`: TEXT NOT NULL（东八区时间戳）
- **并且** 必须创建索引：
  - `idx_cards_project` ON cards(project_id)
  - `idx_cards_callsign` ON cards(callsign)
  - `idx_cards_status` ON cards(status)

#### 场景：级联删除卡片

- **当** 删除项目
- **那么** 系统必须级联删除该项目下的所有卡片
- **并且** 删除操作必须是原子性的

#### 场景：序列化卡片元数据

- **当** 卡片被分发或退卡
- **那么** 系统必须将分发/退卡信息序列化为 JSON
- **并且** JSON 必须保存在 `metadata` 字段
- **并且** JSON 格式必须包含：
  - `distribution`：分发信息（method 处理方式、address 地址、remarks 备注、distributed_at 时间）
  - `return`：退卡信息（method 处理方式、remarks 备注、returned_at 时间）
- **并且** 分发信息和退回信息独立存储，互不覆盖

---

### 需求：卡片录入功能

系统必须提供卡片录入功能，支持单条录入和连续录入模式。

#### 场景：单条卡片录入

- **当** 用户打开卡片录入弹窗
- **那么** 系统必须显示表单：
  - 项目选择下拉框（必填）
  - 呼号输入框（必填）
  - 数量输入框（必填）
- **并且** 用户填写并提交表单
- **那么** 系统必须验证输入：
  - 呼号长度 3-10 字符
  - 呼号仅包含字母、数字、斜杠
  - 数量范围 1-9999
- **并且** 系统必须将呼号自动转为大写
- **并且** 系统必须创建卡片记录：
  - `status` 初始值为 `pending`
  - `created_at` 和 `updated_at` 为当前东八区时间
- **并且** 提交成功后关闭弹窗

#### 场景：连续录入模式

- **当** 用户勾选"连续录入"选项
- **并且** 用户提交表单
- **那么** 系统必须保存卡片记录
- **并且** 系统必须清空呼号和数量输入框
- **并且** 系统必须保持项目选择不变
- **并且** 弹窗必须保持打开状态
- **并且** 焦点必须自动移到呼号输入框

#### 场景：呼号输入验证错误

- **当** 用户输入的呼号格式不正确（如包含特殊字符、长度不足）
- **那么** 系统必须显示错误提示
- **并且** 不得保存记录
- **并且** 焦点必须保持在呼号输入框

#### 场景：快捷键支持

- **当** 用户在录入弹窗中按下 Enter 键
- **那么** 系统必须提交表单
- **当** 用户按下 Esc 键
- **那么** 系统必须关闭弹窗

---

### 需求：卡片列表展示

系统必须提供卡片列表，支持查询、筛选和分页功能。

#### 场景：按项目筛选卡片

- **当** 用户在左侧项目列表中选择项目
- **那么** 系统必须查询该项目下的所有卡片
- **并且** 必须按创建时间降序排列
- **并且** 必须在右侧列表中显示卡片

#### 场景：按呼号搜索

- **当** 用户在搜索框中输入呼号关键词
- **那么** 系统必须进行模糊匹配查询（LIKE '%keyword%'）
- **并且** 搜索必须防抖处理（延迟 300ms）
- **并且** 显示匹配的卡片列表

#### 场景：按状态筛选

- **当** 用户选择状态筛选条件（全部、待分发、已分发、已退回）
- **那么** 系统必须查询对应状态的卡片
- **并且** 状态映射关系为：
  - "待分发" → `pending`
  - "已分发" → `distributed`
  - "已退回" → `returned`
  - "全部" → 不筛选状态

#### 场景：分页显示

- **当** 卡片数量超过 20 条
- **那么** 系统必须启用分页
- **并且** 每页显示 20 条记录
- **并且** 必须显示分页控件（首页、上一页、下一页、尾页）

#### 场景：序号计算

- **当** 系统显示卡片列表
- **那么** 序号必须从 1 开始连续编号
- **并且** 序号必须考虑分页偏移量
- **并且** 公式为：`(当前页码 - 1) * 每页条数 + 行索引 + 1`

---

### 需求：卡片分发功能

系统必须提供卡片分发功能，记录分发方式、地址和备注。

#### 场景：分发对话框数量显示模式切换

- **当** 用户打开分发弹窗
- **那么** 基本信息区域的"数量"字段旁必须提供显示模式切换控件，支持：
  - **精确**：直接显示卡片的精确数量值
  - **大致**：将数量映射为三个档位显示：
    - 数量 ≤ 10 时显示 `≤10`
    - 数量 > 10 且 ≤ 50 时显示 `≤50`
    - 数量 > 50 时显示 `>50`
- **并且** 用户的模式选择必须持久化到本地存储，下次打开时自动恢复
- **并且** 该模式全局生效，影响所有展示数量的页面和打印标签

### 需求：卡片退卡功能

系统必须提供卡片退卡功能，记录处理方式和备注。

#### 场景：退卡卡片（支持任意状态）

- **当** 用户点击"退卡"按钮
- **那么** 系统必须显示退卡弹窗（允许对任意状态的卡片执行退回操作）
- **并且** 弹窗必须包含：
  - 基本信息区域（只读）：转卡项目、呼号、数量、当前状态、录入时间
  - 退回信息区域：
    - 处理方式（单选，带边框）：NOT FOUND、CALLSIGN INVALID、REFUSED、OTHER
    - 备注（多行文本输入框，带复制/粘贴按钮）
- **并且** 用户填写并提交
- **那么** 系统必须更新卡片记录：
  - `status` 更新为 `returned`
  - `metadata` 添加或更新 `return` 对象（保留已有的 `distribution` 信息）：
    ```json
    {
      "return": {
        "method": "NOT FOUND",
        "remarks": "用户输入的备注",
        "returned_at": "2026-01-21T16:00:00+08:00"
      }
    }
    ```
  - `updated_at` 更新为当前时间

#### 场景：重新退回或修改退回信息

- **当** 卡片状态为 `returned`
- **并且** 用户点击"退卡"按钮
- **那么** 系统允许重新退回（视为修改操作）
- **并且** 新的退回信息会覆盖旧的退回信息
- **并且** 分发信息（如果有）保持不变

> **设计说明**：允许对任意状态的卡片执行退回操作，支持以下场景：
> - 待分发(pending) → 已退回(returned)：直接退回
> - 已分发(distributed) → 已退回(returned)：分发后退回
> - 已退回(returned) → 已退回(returned)：修改退回信息
>
> 分发信息和退回信息独立存储在 metadata 中，互不覆盖。

---

### 需求：卡片详情查看

系统必须提供卡片详情查看功能，显示完整信息和记录。

#### 场景：查看卡片详情

- **当** 用户点击"查看"按钮
- **那么** 系统必须显示详情抽屉（从右侧滑入，宽度 400px）
- **并且** 抽屉必须包含：
  - 基本信息区域：转卡项目、呼号、数量、最终状态、录入时间
  - 分发记录区域（如果有）：处理方式、分发时间、分发地址（可选）、备注（可选）
  - 退回记录区域（如果有）：处理方式、退回时间、备注（可选）
- **并且** 所有字段必须为只读，不可编辑
- **并且** 底部提供"分发"和"退回"操作按钮

#### 场景：卡片无分发记录时不显示分发区域

- **当** 卡片的 `metadata.distribution` 不存在
- **那么** 详情抽屉不得显示分发记录区域

#### 场景：卡片无退回记录时不显示退回区域

- **当** 卡片的 `metadata.return` 不存在
- **那么** 详情抽屉不得显示退回记录区域

> **说明**：由于一张卡片可以同时拥有分发记录和退回记录（独立存储），
> 详情页会同时展示两者（如果存在）。最终状态显示当前的 `status` 值。

---

### 需求：卡片删除功能

系统必须提供卡片删除功能，支持删除单个卡片记录。

#### 场景：删除卡片记录

- **当** 用户点击"删除"按钮
- **那么** 系统必须显示确认弹窗："确定要删除此卡片吗？"
- **并且** 用户确认删除
- **那么** 系统必须从数据库中删除该卡片记录
- **并且** 必须刷新卡片列表

#### 场景：取消删除操作

- **当** 用户在删除确认弹窗中点击"取消"
- **那么** 系统不得删除卡片
- **并且** 必须关闭确认弹窗

---

### 需求：卡片列表与详情数量显示

系统必须在所有展示卡片数量的位置统一应用数量显示模式。

#### 场景：全局数量显示模式

- **当** 数量显示模式设置为"大致"
- **那么** 以下位置的数量必须显示为档位值（`≤10`、`≤50`、`>50`）：
  - 卡片列表页表格"数量"列
  - 卡片详情弹窗
  - 分发对话框基本信息区
  - 退回对话框基本信息区
  - 顺丰订单详情
  - 录入成功提示文案
  - 打印标签上的 `QTY` 字段
- **并且** 数据库中仍存储精确数值，仅前端展示和打印输出受影响

