# 能力：验证码防护 (captcha-protection)

## 概述

为云端查询服务提供自建的轻量级防刷机制，防止简单脚本批量请求接口或恶意绑定。

## 背景

云端服务暴露了公开的查询接口和订阅绑定功能，需要防止：
- 简单脚本（curl/requests）批量调用接口
- 爬虫遍历呼号抓取数据
- 自动化批量绑定虚假呼号

由于 QSL 查询服务攻击价值较低，不需要应对专业的验证码破解服务，采用自建轻量方案即可。

## 需求

### 功能需求

#### FR-1: IP 限流

- **FR-1.1**: 对所有 API 请求按 IP 进行频率限制
- **FR-1.2**: 默认限制为 20 次/分钟
- **FR-1.3**: 超限请求返回 HTTP 429 状态码及友好提示
- **FR-1.4**: 使用 Cloudflare KV 存储计数，支持自动过期

#### FR-2: 请求签名校验

- **FR-2.1**: 所有 API 请求必须携带有效签名
- **FR-2.2**: 签名由前端 JS 生成，包含时间戳、随机数（nonce）和 SHA-256 哈希
- **FR-2.3**: 服务端校验签名有效性、时间窗口（5分钟内）和 nonce 唯一性
- **FR-2.4**: nonce 使用 KV 存储去重，设置 5 分钟 TTL 自动过期
- **FR-2.5**: 签名无效或过期的请求返回 HTTP 403

#### FR-3: 算术验证码

- **FR-3.1**: 「订阅收卡」操作触发前必须完成算术验证码
- **FR-3.2**: 验证码为简单加法或减法运算（如 "12 + 7 = ?"）
- **FR-3.3**: 题目使用 Canvas 渲染，包含轻微干扰线，增加 OCR 识别难度
- **FR-3.4**: 服务端生成题目时返回加密 token，包含正确答案和过期时间
- **FR-3.5**: 用户提交答案时，服务端校验 token 有效性和答案正确性
- **FR-3.6**: token 有效期为 5 分钟，过期需重新获取题目

### 非功能需求

#### NFR-1: 用户体验

- **NFR-1.1**: 签名校验对用户完全无感
- **NFR-1.2**: 算术验证码仅在订阅操作时出现，查询操作无需交互
- **NFR-1.3**: 验证码 Canvas 在移动端清晰可读

#### NFR-2: 性能

- **NFR-2.1**: 限流检查延迟 < 10ms（KV 读取）
- **NFR-2.2**: 签名校验延迟 < 5ms（纯计算）
- **NFR-2.3**: 验证码生成延迟 < 20ms

#### NFR-3: 安全

- **NFR-3.1**: 签名密钥存储在环境变量中，前端仅获取用于签名的公开部分
- **NFR-3.2**: 验证码 token 使用服务端密钥签名，防止伪造
- **NFR-3.3**: 不记录用户 IP 的完整日志，仅用于限流计数

## 接口定义

### 请求签名格式

所有需要签名的请求必须携带以下参数：

| 参数 | 类型 | 说明 |
|------|------|------|
| `_ts` | number | 请求时间戳（毫秒） |
| `_nonce` | string | 随机字符串（UUID） |
| `_sig` | string | SHA-256 签名 |

签名算法：
```
payload = `${请求路径}:${关键参数}:${_ts}:${_nonce}`
signature = sha256(payload + CLIENT_SIGN_KEY)
```

### 验证码接口

#### GET /api/captcha

生成算术验证码题目。

**响应**:
```json
{
  "question": "12 + 7 = ?",
  "token": "eyJ...",
  "expires": 1234567890
}
```

> 注：`question` 字段仅供调试或无障碍场景使用，正常情况下前端应使用 Canvas 渲染。

### 验证码校验

订阅接口需额外携带：

| 参数 | 类型 | 说明 |
|------|------|------|
| `captcha_token` | string | 验证码 token |
| `captcha_answer` | number | 用户输入的答案 |

## 不在范围内

- 图形验证码（点选、滑动拼图）
- 第三方验证码服务集成（腾讯天御、极验等）
- 行为分析 / 风控系统
- IP 黑名单持久化管理