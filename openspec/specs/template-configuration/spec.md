# template-configuration Specification

## Purpose
TBD - created by archiving change fix-border-text-alignment. Update Purpose after archive.
## 需求
### 需求：文字宽度测量精度
文字渲染系统必须使用实际像素边界框测量文字宽度，而非字体排版宽度，以确保布局计算的准确性和文字的精确居中。

#### 场景：测量包含中文的文本
- **当** 测量包含中文字符的文本（如"中国无线电协会业余分会-2区卡片局"）
- **那么** 返回的宽度必须等于实际渲染后的像素宽度（使用 `pixel_bounding_box` 计算）
- **并且** 宽度计算必须考虑字形向左或向右延伸的情况

#### 场景：文字居中对称性
- **当** 使用 center 对齐渲染文字元素
- **那么** 元素左边距和右边距的差异必须 ≤ 1 个像素
- **并且** 实际渲染的像素分布必须左右对称

### 需求：边框与内容区域分离
边框必须绘制在 margin 边界（外框），内容区域必须在边框内侧（内框），两者计算逻辑完全分离。

#### 场景：启用边框时的内容区域
- **当** 模板配置启用边框（`border = true`）
- **那么** 边框必须绘制在 `margin_left`, `margin_top`, `margin_right`, `margin_bottom` 定义的边界上
- **并且** 内容区域必须向内缩进 `border_thickness` 的距离
- **并且** 所有元素必须在边框内边界范围内渲染

#### 场景：边框配置信息输出
- **当** 布局引擎计算边框配置
- **那么** 必须输出调试日志显示边框的 x, y, width, height, thickness
- **并且** 必须输出内容区域的左右边界信息

### 需求：文字安全边距
文字元素布局时必须预留安全边距，避免文字过于接近边框或边界。

#### 场景：计算文字最大字号
- **当** 为文字元素计算最大字号
- **那么** 必须从可用宽度中减去约 1mm 的安全边距（两侧总计）
- **并且** 安全边距的计算必须使用 `mm_to_dots(1.0, dpi)` 确保在不同 DPI 下一致

#### 场景：安全边距边界检查
- **当** 可用宽度小于或等于安全边距
- **那么** 使用原始可用宽度（不减去安全边距）
- **并且** 记录警告日志

### 需求：模板文件路径配置
模板文件加载路径必须正确配置，在开发模式下能够从项目根目录相对路径加载模板文件。

#### 场景：开发模式加载呼号模板
- **当** 在开发模式下（`debug_assertions` 启用）加载呼号模板
- **那么** 必须使用路径 `config/templates/callsign.toml`（从项目根目录开始）
- **并且** 必须成功加载模板配置文件
- **并且** 输出日志显示成功加载的模板路径

#### 场景：模板加载失败回退
- **当** 从文件加载模板失败
- **那么** 必须输出警告日志说明加载失败原因
- **并且** 必须回退到硬编码的默认模板配置
- **并且** 系统必须继续正常运行

#### 场景：向后兼容性处理
- **当** 配置文件中仍使用 `"default.toml"` 作为模板路径
- **那么** 系统必须自动回退到 `"callsign.toml"`
- **并且** 记录警告日志，说明已自动迁移

### 需求：布局计算调试信息
布局引擎必须提供详细的调试日志，帮助开发者诊断对齐和间距问题。

#### 场景：元素水平对齐日志
- **当** 布局引擎计算元素的水平位置
- **那么** 必须为每个元素输出调试日志
- **并且** 日志必须包含：元素 ID, x 坐标, width, 右边界位置（x + width）

#### 场景：内容区域边界日志
- **当** 启用边框时计算内容区域
- **那么** 必须输出调试日志显示内容区域的左右边界
- **并且** 日志格式必须清晰说明边界计算方式（如 "border_x + thickness"）

### 需求：模板配置读取接口
系统必须提供读取当前模板配置的接口，供前端获取完整的模板参数。

#### 场景：获取呼号模板配置
- **当** 前端调用 `get_template_config` 命令（不指定模板类型）
- **那么** 系统必须读取 `config/templates/callsign.toml` 文件
- **并且** 返回完整的 `TemplateConfig` 结构（包含 metadata, page, layout, fonts, elements, output）
- **并且** 如果文件不存在或格式错误，返回错误信息

#### 场景：获取地址模板配置
- **当** 前端调用 `get_address_template_config` 命令
- **那么** 系统必须读取 `config/templates/address.toml` 文件
- **并且** 返回完整的 `TemplateConfig` 结构
- **并且** 如果文件不存在或格式错误，返回错误信息

### 需求：模板配置保存接口
系统必须提供保存模板配置的接口，将用户修改的参数持久化到文件。

#### 场景：保存呼号模板配置到文件
- **当** 前端调用 `save_template_config` 命令并传入 `TemplateConfig` 结构（不指定模板类型）
- **那么** 系统必须将配置序列化为 TOML 格式
- **并且** 覆盖写入 `config/templates/callsign.toml` 文件
- **并且** 使用格式化的 TOML 输出（`toml::to_string_pretty`）保持可读性
- **并且** 保存成功后返回成功状态

#### 场景：保存地址模板配置到文件
- **当** 前端调用 `save_address_template_config` 命令并传入 `TemplateConfig` 结构
- **那么** 系统必须将配置序列化为 TOML 格式
- **并且** 覆盖写入 `config/templates/address.toml` 文件
- **并且** 使用格式化的 TOML 输出（`toml::to_string_pretty`）保持可读性
- **并且** 保存成功后返回成功状态

### 需求：模板设置用户界面
系统必须提供可视化的模板设置界面，让用户编辑模板参数并实时预览效果。

#### 场景：显示模板配置表单
- **当** 用户打开模板设置页面
- **那么** 系统必须调用 `get_template_config` 获取当前配置
- **并且** 在表单中显示所有配置字段
- **并且** 高频配置字段必须可编辑（边距、对齐、间距、元素高度）
- **并且** 低频配置字段必须只读显示（DPI、纸张尺寸、字体、元数据）

#### 场景：配置分组和折叠
- **当** 显示模板配置表单时
- **那么** 系统必须将配置按逻辑分组（页面配置、布局配置、元素配置等）
- **并且** 使用折叠面板组织各配置组
- **并且** 默认展开高频配置组（页面配置、布局配置）
- **并且** 默认折叠低频配置组（元数据、字体、输出）

#### 场景：字段编辑权限控制
- **当** 用户尝试编辑配置字段时
- **那么** 可编辑字段必须允许输入和修改
- **并且** 只读字段必须禁用输入（通过 `readonly` 或 `disabled` 属性）
- **并且** 可编辑字段包括：
  - `page.margin_*_mm`（四个边距）
  - `page.border`（边框开关）
  - `page.border_thickness_mm`（边框粗细）
  - `layout.align_h`、`layout.align_v`（对齐方式）
  - `layout.gap_mm`、`layout.line_gap_mm`（间距）
  - `elements[].max_height_mm`（文本元素高度）

### 需求：自动保存配置变更
系统必须在用户修改配置后自动保存，无需手动点击保存按钮。

#### 场景：配置变更自动保存
- **当** 用户修改可编辑字段的值
- **那么** 系统必须在 500ms 延迟后自动调用 `save_template_config`
- **并且** 使用防抖（debounce）机制避免频繁保存
- **并且** 保存成功后显示提示消息
- **并且** 保存失败后显示错误消息并允许重试

#### 场景：保存状态反馈
- **当** 系统正在保存配置时
- **那么** 必须显示保存状态指示（如"保存中..."）
- **并且** 保存成功后显示成功提示（如"配置已保存"）
- **并且** 保存失败后显示错误提示并包含失败原因

### 需求：实时预览功能
系统必须提供预览功能，让用户在修改配置后能够查看渲染效果。

#### 场景：刷新预览
- **当** 用户点击"刷新预览"按钮
- **那么** 系统必须使用当前表单中的配置生成预览
- **并且** 调用 `preview_qsl` 命令生成 PNG 预览图
- **并且** 使用测试数据填充运行时字段（task_name, callsign, sn, qty）
- **并且** 在右侧预览区域显示生成的图片
- **并且** 显示加载状态指示

#### 场景：预览生成失败处理
- **当** 预览生成失败（如配置参数无效）
- **那么** 系统必须显示错误提示
- **并且** 错误提示必须包含失败原因
- **并且** 不清除上一次成功的预览图

#### 场景：预览布局
- **当** 显示预览区域时
- **那么** 预览必须位于页面右侧
- **并且** 预览卡片必须包含标题"预览"和刷新按钮
- **并且** 预览图片必须自适应容器宽度
- **并且** 提供预览说明："预览仅供参考，实际打印可能有细微差异"

### 需求：表单验证和约束
系统必须验证用户输入的配置参数，防止无效配置导致系统异常。

#### 场景：数值范围验证
- **当** 用户输入边距或间距值时
- **那么** 系统必须验证数值 >= 0
- **并且** 如果输入无效，显示错误提示
- **并且** 阻止保存无效配置

#### 场景：字段提示和说明
- **当** 用户查看配置字段时
- **那么** 每个字段必须有清晰的标签（如"左边距"）
- **并且** 必须标注单位（如"mm"）
- **并且** 可选择性提供 tooltip 说明字段作用和推荐值

### 需求：配置变更生效
用户修改并保存的模板配置必须在后续打印操作中立即生效。

#### 场景：配置变更应用到打印
- **当** 用户修改并保存模板配置后
- **那么** 下次调用 `print_qsl` 或 `preview_qsl` 时
- **并且** 系统必须重新加载模板文件（模板热重载已在之前的变更中实现）
- **并且** 使用最新的配置参数进行布局和渲染

### 需求：地址模板配置
系统必须支持地址模板配置，用于打印地址信息。

#### 场景：地址模板文件存在
- **当** 系统需要加载地址模板
- **那么** 必须从 `config/templates/address.toml` 加载模板配置
- **并且** 模板配置必须符合 v2 模板格式规范
- **并且** 如果文件不存在，系统应创建默认地址模板

#### 场景：地址模板元素配置
- **当** 地址模板被加载时
- **那么** 模板必须包含以下元素类型：
  - 呼号（用于标识）
  - 姓名（如果存在）
  - 中文地址（如果存在）
  - 英文地址（如果存在）
  - 邮寄方式（如果存在）
- **并且** 模板必须不包含日期相关元素

### 需求：双份打印布局
地址模板必须支持在同一张纸上打印两遍，上半部分和下半部分完全一致。

#### 场景：双份打印布局计算
- **当** 地址模板配置了双份打印模式（`duplicate_print = true`）
- **那么** 布局引擎必须计算上半部分的正常布局
- **并且** 必须复制所有元素到下半部分，垂直偏移为纸张高度的一半
- **并且** 上下两部分的所有元素（位置、大小、内容）必须完全一致

#### 场景：双份打印元素位置
- **当** 布局引擎计算双份打印布局时
- **那么** 上半部分的元素位置必须从顶部边距开始计算
- **并且** 下半部分的元素位置必须从纸张高度的一半开始计算
- **并且** 上下两部分对应元素的水平位置必须相同

#### 场景：双份打印内容一致性
- **当** 生成双份打印布局时
- **那么** 上半部分和下半部分的所有元素内容必须完全相同
- **并且** 元素类型、文本内容、格式必须一致
- **并且** 元素的大小和字体必须一致

