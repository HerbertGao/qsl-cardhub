# 顺丰速运集成功能

## 概述

为 QSL-CardHub 添加完整的顺丰速运集成功能，包括下单、订单管理、面单打印等能力。集成顺丰开放平台的以下 API：
- **EXP_RECE_CREATE_ORDER**：下订单接口
- **EXP_RECE_UPDATE_ORDER**：订单确认/取消接口
- **EXP_RECE_SEARCH_ORDER_RESP**：订单结果查询接口
- **COM_RECE_CLOUD_PRINT_WAYBILLS**：云打印面单打印2.0

实现从卡片分发到下单、确认、打印面单的完整工作流程。

## 动机

当前卡片分发流程中，用户选择"快递"方式后需要手动在顺丰系统中下单，然后手动打印快递面单。通过集成顺丰开放平台 API，可以：
- 在应用内直接下顺丰订单，简化工作流程
- 支持订单的二次确认和取消，提供灵活性
- 自动获取订单号并回填到卡片分发备注
- 在应用内直接打印顺丰面单，无需切换系统
- 复用现有的 TSPL 打印基础设施
- 将下单、打印与卡片分发流程无缝衔接

## 功能范围

### 功能一：顺丰速运配置页面

在「数据配置」菜单下新增「顺丰速运」配置页面，提供以下配置项：

| 配置项 | 类型 | 说明 |
|--------|------|------|
| 环境 | 单选 | 生产环境 / 沙箱环境 |
| 顾客编码 | 文本 | 合作伙伴编码（partnerID） |
| 模板编码 | 只读 | 格式：`fm_76130_standard_{partnerID}`，系统根据顾客编码自动生成 |
| 生产校验码 | 密码 | 生产环境的 checkword |
| 沙箱校验码 | 密码 | 沙箱环境的 checkword |

配置界面根据当前选择的环境自动使用对应的校验码。模板编码会根据顾客编码动态生成，格式为 `fm_76130_standard_{partnerID}`。

### 功能二：寄件人信息管理

在顺丰速运配置页面中增加「寄件人信息」管理功能：

- **寄件人信息表单**：
  - 寄件人姓名（必填）
  - 寄件人电话（必填）
  - 寄件人手机（可选）
  - 寄件地址（省市区街道详细地址，支持地址选择器）
  - 地址选择器：基于 [data_location](https://github.com/mumuy/data_location) 数据实现省市区三级联动选择

- **功能特性**：
  - 支持保存多个寄件人信息（可设置默认）
  - 寄件人信息加密存储
  - 下单时自动预填寄件人信息

### 功能三：卡片分发流程集成

修改卡片分发流程，集成顺丰下单功能：

**新的分发流程：**
1. 用户在分发卡片界面选择"快递"方式
2. 系统显示「下顺丰订单」按钮
3. 用户点击「下顺丰订单」，打开下单对话框
4. 系统自动预填寄件人信息（从配置读取）
5. 用户填写或确认收件人信息（可从卡片备注或地址查询获取）
6. 用户提交订单，系统调用 EXP_RECE_CREATE_ORDER 接口
7. 订单创建成功，系统显示「二次确认」对话框：
   - 显示订单信息预览
   - 提供「立即确认」和「稍后确认」选项
8. 如果选择「稍后确认」，订单保存到订单列表，状态为"待确认"
9. 如果选择「立即确认」，系统调用 EXP_RECE_UPDATE_ORDER 接口确认订单
10. 确认成功后，系统获取顺丰订单号（运单号）
11. 系统自动回填订单号到卡片分发备注
12. 系统显示「打印面单」选项，用户可选择：
    - 立即打印面单（预览后打印）
    - 稍后打印（在订单列表中打印）

### 功能四：顺丰订单列表页面

新增「顺丰订单列表」页面，提供订单管理功能：

- **订单列表显示**：
  - 订单号（顺丰订单号）
  - 运单号（确认后显示）
  - 关联卡片信息（呼号、项目、数量，通过 LEFT JOIN 关联查询）
  - 订单状态（待确认、已确认、已取消、已打印）
  - 下单时间
  - 收件人信息
  - 付款方式
  - 托寄物名称

- **订单操作**：
  - **确认订单**：调用 EXP_RECE_UPDATE_ORDER 接口确认订单，获取运单号
  - **取消订单**：调用 EXP_RECE_UPDATE_ORDER 接口取消订单（待确认和已确认订单均可取消，已确认订单取消时需传入运单号）
  - **查询订单**：调用 EXP_RECE_SEARCH_ORDER_RESP 接口查询订单状态
  - **打印面单**：确认订单后，可打印面单
  - **查看详情**：查看订单完整信息

- **订单状态流转**：
  - 待确认 → 已确认（获取运单号）→ 已打印
  - 待确认 → 已取消
  - 已确认 → 已取消（需传入运单号）

### 功能五：运单打印对话框

在以下位置提供「打印面单」入口：
- 卡片列表的操作列（已有运单号时）
- 分发对话框中（确认订单后）
- 订单列表中（已确认订单）

运单打印对话框包含：
- 运单号显示（自动带入）
- PDF 预览区域
- 「提交打印」按钮：获取 PDF 并显示预览
- 「打印」按钮：将 PDF 转换为 TSPL 并发送到打印机

打印流程：
1. 调用顺丰 API 同步获取 PDF（`sync: true`）
2. 下载 PDF 文件
3. 将 PDF 渲染为预览图像显示
4. 用户确认后，将 PDF 渲染为 1bpp 点阵图
5. 生成 TSPL 指令并发送到打印机

## 技术方案

### API 集成

系统需要集成以下顺丰开放平台 API：

1. **EXP_RECE_CREATE_ORDER**（下订单接口）
   - 用于创建顺丰订单
   - 请求参数包括：寄件人信息、收件人信息、快件信息等
   - 返回订单号（orderId）

2. **EXP_RECE_UPDATE_ORDER**（订单确认/取消接口）
   - 用于确认订单（获取运单号）
   - 用于取消订单
   - 请求参数包括：订单号、操作类型（确认/取消）

3. **EXP_RECE_SEARCH_ORDER_RESP**（订单结果查询接口）
   - 用于查询订单状态和详细信息
   - 请求参数包括：订单号或运单号
   - 返回订单状态、运单号等信息

4. **COM_RECE_CLOUD_PRINT_WAYBILLS**（云打印面单打印2.0）
   - 用于获取面单 PDF
   - 模式：同步模式（sync: true），直接返回 PDF 下载地址

**API 认证**：
- 所有接口使用数字签名方式（msgDigest = MD5(msgData + timestamp + checkword)）
- 环境地址：
  - 生产：`https://bspgw.sf-express.com/std/service`
  - 沙箱：`https://sfapi-sbox.sf-express.com/std/service`

**API 文档参考**（详见 `docs/` 目录）：
- 下订单接口：`docs/下订单接口-速运类API（国内件、大陆港澳台互寄件）.md`
- 订单确认/取消接口：`docs/订单确认、取消接口-速运类API.md`
- 订单结果查询接口：`docs/订单结果查询接口-速运类API.md`
- 云打印面单接口：`docs/云打印面单打印2.0接口.md`

### PDF 转打印

1. 使用 Rust PDF 解析库（如 `pdf` 或 `pdfium`）读取 PDF
2. 将 PDF 页面渲染为位图
3. 转换为 1bpp 单色点阵（适配热敏打印）
4. 生成 TSPL BITMAP 指令
5. 通过现有打印管道发送到打印机

### 数据存储

**凭据存储**：
复用现有的凭据存储机制（系统钥匙串或本地加密文件），存储键名：
- `qsl-cardhub:sf:partner_id`
- `qsl-cardhub:sf:checkword_prod`
- `qsl-cardhub:sf:checkword_sandbox`
- `qsl-cardhub:sf:environment`

**寄件人信息存储**：
- 使用本地数据库（SQLite）存储寄件人信息
- 表结构：`sf_senders`（id, name, phone, mobile, province, city, district, address, is_default, created_at）
- 支持多个寄件人，可设置默认寄件人

**订单信息存储**：
- 使用本地数据库（SQLite）存储订单信息
- 表结构：`sf_orders`（id, order_id, waybill_no, card_id, status, sender_info, recipient_info, pay_method, cargo_name, created_at, updated_at）
- 订单状态：pending（待确认）、confirmed（已确认）、cancelled（已取消）、printed（已打印）
- pay_method：付款方式（1=寄方付, 2=收方付, 3=第三方付）
- cargo_name：托寄物名称

## 约束与限制

1. **纸张尺寸**：面单模板为 76mm × 130mm，与现有标签纸一致
2. **单票打印**：每次只打印单个运单，不支持批量
3. **网络依赖**：需要能够访问顺丰开放平台 API
4. **订单状态**：订单创建后需要确认才能获取运单号，支持取消未确认订单
5. **地址数据**：省市区地址数据基于 [data_location](https://github.com/mumuy/data_location) 项目（符合 GB/T 2260 标准），需要集成到应用中
6. **API 限制**：遵循顺丰开放平台的 API 调用频率和限制要求

## 受影响的规范

- **新增**：`sf-express-integration` - 顺丰速运集成规范

## 风险评估

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| PDF 解析复杂度 | 中 | 选择成熟的 PDF 库，做好错误处理 |
| API 调用失败 | 中 | 提供明确的错误提示，支持重试；订单状态本地缓存，支持离线查看 |
| 打印质量问题 | 低 | PDF 为 76×130 标准尺寸，直接转换即可 |
| 订单状态同步 | 中 | 本地存储订单状态，支持手动查询更新；提供订单状态刷新功能 |
| 地址数据维护 | 低 | 使用成熟的地址数据源，定期更新；支持手动输入地址 |
| 下单数据验证 | 中 | 前端和后端双重验证，确保必填字段完整；提供清晰的错误提示 |