#### 云打印面单打印2.0接口-面单类API

###### COM_RECE_CLOUD_PRINT_WAYBILLS

------------

##### 1. 功能描述

- 该接口提供给用户自主打单的服务，提供异步和同步返回面单pdf文件方式。

- **异步方式：** 面单pdf文件会直接推送到用户配置的回调地址，文档后半部分(2.8)提供面单推送的格式及解码出面单pdf文件的示例
- **同步方式：** 不需要配置回调地址，接口会同步返回面单pdf文件的url地址，下载时需要请求头携带对应token

- **云打印面单打印2.0接口**：是原来面单打印接口的升级版本，主要在业务参数做了简化，去掉了复杂的业务字段，用户只需要提供运单号等关键字段即可，云打印会查询订单系统的订单数据。
- **备注**:
  沙箱环境测试单号需要通过速运API-->通用寄件类-->下单接口，获取测试单号用于沙箱环境测试，下单接口文档：https://open.sf-express.com/Api/ApiDetails?level3=393&amp;interName=%E4%B8%8B%E8%AE%A2%E5%8D%95%E6%8E%A5%E5%8F%A3-EXP_RECE_CREATE_ORDER

##### 2. 接口定义

###### 2.1. 公共参数

| 名称     | 值                                             |
|--------|-----------------------------------------------|
| 接口服务代码 | COM_RECE_CLOUD_PRINT_WAYBILLS                 |
| 生产环境地址 | https://bspgw.sf-express.com/std/service      |
| 沙箱环境地址 | https://sfapi-sbox.sf-express.com/std/service |
| 接口类型   | 接入                                            |
| 报文类型   | JSON                                          |

###### <a id="commonReqParam">2.2. 公共请求参数

| 序号 | 参数列表        | 类型          | 是否必传 | 含义                                                                                                                                 |
|:--:|:------------|:------------|:----:|:-----------------------------------------------------------------------------------------------------------------------------------|
| 1  | partnerID   | String(64)  |  是   | 合作伙伴编码（即顾客编码）                                                                                                                      |
| 2  | requestID   | String(40)  |  是   | 请求唯一号UUID                                                                                                                          |
| 3  | serviceCode | String(50)  |  是   | 接口服务代码（COM_RECE_CLOUD_PRINT_WAYBILLS）                                                                                              |
| 4  | timestamp   | long        |  是   | 调用接口时间戳                                                                                                                            |
| 5  | msgDigest   | String(128) |  条件  | 数字签名,使用数字签名方式认证时必填 <br/>签名方法参考：[数字签名认证说明](https://open.sf-express.com/developSupport/976720?authId=1)                        |
| 6  | accessToken | String      |  条件  | 访问令牌，使用OAuth2方式认证时必填 <br/>获取方法参考：[OAuth2认证说明](https://open.sf-express.com/developSupport/976720?authId=0),**推荐使用OAuth2方式认证** |
| 7  | msgData     | String      |  是   | 业务数据报文                                                                                                                             |

###### 2.3. 请求参数<msgData> 

| # | 属性名                | 字段含义                                    | 必选 | 类型      | 说明                                                           |
|---|--------------------|-----------------------------------------|----|---------|--------------------------------------------------------------|
| 1 | templateCode       | 模板编码                                    | 是  | String  | 关联云打印接口后，点击查看，可在接口详情页获取模板编码，类似：fm_76130_standard_{partnerId} |
| 2 | documents          | 业务数据                                    | 是  | array   | 一批不要超过20个运单，字段定义参考 2.3.1 模板固定字段                              |
| 3 | version            | 版本号                                     | 是  | String  | 版本号，**传固定值:2.0**                                             |
| 4 | fileType           | 生成面单文件格式                                | 否  | String  | pdf格式                                                        |
| 5 | sync               | 是否同步                                    | 条件 | boolean | **true: 同步**,false: 异步,默认异步                                  |
| 6 | customTemplateCode | 自定义模板编码，当需要使用模板编辑器编辑自定义区时，将自定义模板编码赋值该字段 | 否  | String  | **自定义模板必须是已发布的，且规格要和需要打印的模板对应**                              |
| 7 | extJson            | 扩展字段                                    | 否  | Json    | **字段定义参考下方extJson字段**                                        |

###### 2.3.1 模板固定字段

| 固定字段名               | 类型     | 必 传 | 描述                                                                  | 值说明                                                                                                                                                                          |
|---------------------|--------|-----|---------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| masterWaybillNo     | String | 是   | 主运单号                                                                |                                                                                                                                                                              |
| branchWaybillNo     | String | 条件  | 子运单号                                                                | 单票运单时不填                                                                                                                                                                      |
| backWaybillNo       | String | 条件  | 签回单号                                                                | 打印签回单时，masterWayBillNo和branchWaybillNo为空                                                                                                                                     |
| seq                 | String | 条件  | 该运单号打印时对应的顺序号，母运单序号=1，子运单号时递增该值                                     | 单票运单时不填，当打印子母单时必填                                                                                                                                                            |
| sum                 | String | 条件  | 子母件运单总数                                                             | 单票运单时不填，当打印子母单时必填                                                                                                                                                            |
| isPrintLogo         | String | 否   | 如热敏贴纸上已印刷LOGO及服务电话则不需打印。如未印刷则需打印。 true:热敏纸上无印刷需要打印                  | 不需要打印则不填                                                                                                                                                                     |
| remark              | String | 否   | 自定义区域备注                                                             |                                                                                                                                                                              |
| waybillNoCheckType  | String | 否   | 运单号权限校验类型 1：收方电话后6位 2：寄方电话后6位 优先校验客户编码，如果客户编码校验不通过，才使用其他方式校验 比如：“1” | 第三方erp对接时，为必传，无法通过客户接入码校验运单号时，可以通过其他方式校验。                                                                                                                                    |
| waybillNoCheckValue | String | 否   | 运单号合法校验具体值 比如：“123456”                                              | 与 waybillNoCheckType 参数对应                                                                                                                                                    |
| customData          | Json   | 否   | 使用自定义模板编码时，对应的变量字段，如果没有使用变量字段，可以不传                                  | 注意字段类型是Json对象                                                                                                                                                                |
| printPageNum        | String | 否   | 打印页码，eg:  第 10/20 票                                                 | 调用方需注意传值长度，最多只能打印下"第 1000/2000 票"文本的长度。2024-06-06后新增，当前仅引用公共模板76130-v2.21版本及以上、76165一联V1.7版本及以上、76165二联V1.8版本及以上的模板支持。                                                       |
| isPrintStub         | String | 否   | 是否打印存根联，不打印存根联不传                                                    | true：打印存根联。不传或传false：不打印存根联。2024-08-22后新增，当前仅引用76*130公共模板2.24版本及以上的业务模板才生效。                                                                                                  |
| flowIcon            | String | 否   | 【特经项目】流向标识。传"1"打数字1图标，依次类推，当前最大支持15。                                | 支持传值范围：“1”-“15”，<br/>对应数字1到15的图标。<br/>2024-08-29后新增，<br/>仅引用76130公共模板V2.25版本及以上；<br/>76165一联公共模板V1.18版本及以上；<br/>76*165二联公共模板V2.0版本及以上的业务模板才生效。 |
| flowText            | String | 否   | 【特经项目】中文标识，支持配置，最长2个字符                                              | 支持配置，最长2个字符<br/>2025-09-04后新增，<br/>仅以下模板支持：<br/>丰密210公共模板；<br/>丰密76*130公共模板；<br/>76*165一联公共模板；<br/>76*165二联公共模板。                         |

###### 2.3.2 extJson字段

| 固定字段名           | 类型      | 必 传 | 描述                                                                                                                                                                                                                                                                                          | 值说明                                                                                                                                                                                                                                  |
|-----------------|---------|-----|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| channel         | String  | 否   | 订单所属渠道                                                                                                                                                                                                                                                                                      | eg: "medicine" 代表医药渠道运单，cx：代表是CX预约单                                                                                                                                                                                                  |
| ~~encryptFlag~~ | String  | 否   | 【**云打印统一收口脱敏逻辑，encryptFlag下线，如有特殊需求请联系云打印产品经理罗浩江**】自定义脱敏标识，6位0和1和2组成的字符串，0表示不脱敏，1表示需要脱敏，2表示隐藏（只对公司名生效）；顺序：<br>第1位：收件人姓名（只能脱敏或显示），<br>第2位：寄件人姓名（只能脱敏或显示），<br>第3位：收件人地址（只能脱敏或显示），<br>第4位：寄件人地址（只能脱敏或显示），<br>第5位：收件人公司名称（只能隐藏或显示），<br>第6位：寄件人公司名称（只能隐藏或显示） | eg: "101020" 表示收件人姓名和收件人地址脱敏，寄件人姓名和寄件人地址不脱敏,同时隐藏收件人公司名<br>**地址脱敏规则**：后10位，如果有阿拉伯数字、中文数字、字母就用\*替换  <br>**姓名脱敏规则**：1个字的 不隐藏，2个字的 隐藏末位，3个字的 隐藏中间，超过三个字，超过部分不打印，隐藏第三位，如欧阳娜娜-欧阳\*  <br>**手机号脱敏规则**：保留前1位和后4位 eg: 1*2345 |
| **mergePdf**    | Boolean | 否   | 是否合并pdf文件                                                                                                                                                                                                                                                                                   | true:批量打印时，多页合并为一个pdf文件返回，<br>false：一页一个pdf文件，默认false                                                                                                                                                                          |
| **mergeType**   | String  | 否   | 合并文件方式                                                                                                                                                                                                                                                                                      | all:将所有document合并为一个pdf文件返回,<br>single:一个document的多页合并一个pdf文件，默认all                                                                                                                                                            |

###### <a id="commonRespParam">2.4. 公共响应参数 

| # | 属性名           | 类型(约束) | 必填 | 默认值 | 描述           |
|---|---------------|--------|----|-----|--------------|
| 1 | apiResultCode | String | 是  |     | API平台结果代码    |
| 2 | apiErrorMsg   | String | 否  |     | API平台异常信息    |
| 3 | apiResponseID | String | 是  |     | API响应唯一号UUID |
| 4 | apiResultData | String | 否  |     | 业务处理详细结果     |

###### <a id="respParam">2.5. 响应参数<apiResultData> 

| # | 属性名          | 类型      | 说明                                 |
|---|--------------|---------|------------------------------------|
| 1 | success      | boolean | 请求成功标志                             |
| 2 | errorMessage | String  | 失败提示信息                             |
| 3 | errorCode    | String  | 失败状态码                              |
| 4 | requestId    | String  | 发送请求中的ID,原封不动返回，使客户系统能识别出哪个请求对应的响应 |
| 5 | obj          | object  | 同步方式才有值，异步方式为空对象                   |

###### obj

| # | 属性名          | 类型                    | 说明                        |
|---|--------------|-----------------------|---------------------------|
| 1 | files        | List<PrintFile> | pdf文件集合,不保证顺序，自行通过seqNo排序 |
| 2 | clientCode   | String                | 客户编码                      |
| 3 | templateCode | String                | 模板编码                      |
| 4 | fileType     | String                | 文件类型(pdf)                 |

###### PrintFile

| # | 属性名       | 类型     | 说明                                                |
|---|-----------|--------|---------------------------------------------------|
| 1 | url       | String | pdf文件的url下载地址,使用 **GET** 协议                       |
| 2 | token     | String | 下载文件时需要的token,设置在请求头的 **X-Auth-token** 字段，有效期 24h |
| 3 | waybillNo | String | 顺丰运单号（子母单为子单号）                                    |
| 4 | seqNo     | int    | 面单序号（批量打印场景，为documents的序号）                        |
| 5 | areaNo    | int    | 联编号（大客户面单为固定值：1）                                  |
| 6 | pageNo    | int    | 每联的页号(大客户面单为固定值：1)                                |
| 7 | pageCount | int    | 文件的页数                                             |

###### <a id="requestJsonPost">2.6. 请求示例\应用场景(JSON)示例 

请求报文1:单票传值举例（msgData字段）:

```json
{
  "templateCode": "fm_210_standard_{{clientcode}}",
  "version": "2.0",
  "fileType": "pdf",
  "sync": true,
  "documents": [
    {
      "masterWaybillNo": "SF1234567890999"
    }
  ]
}
```

请求报文2:签回单传值举例

```json
{
  "templateCode": "fm_210_standard_{{clientcode}}",
  "version": "2.0",
  "fileType": "pdf",
  "sync": true,
  "documents": [
    {
      "masterWaybillNo": "SF1234567890999"
    },
    {
      "backWaybillNo": "SF1234567890666"
    }
  ]
}
```

请求报文3:子母单场景传值举例

```json
{
  "templateCode": "fm_210_standard_{{clientcode}}",
  "version": "2.0",
  "fileType": "pdf",
  "sync": true,
  "documents": [
    {
      "masterWaybillNo": "SF1234567890999",
      "seq": "1",
      "sum": "3",
      "remark": "有需要可以传自己需要备注的简短内容，没有可以不传该字段"
    },
    {
      "masterWaybillNo": "SF1234567890999",
      "branchWaybillNo": "SF2234567890100",
      "seq": "2",
      "sum": "3",
      "remark": "有需要可以传自己需要备注的简短内容，没有可以不传该字段"
    },
    {
      "masterWaybillNo": "SF1234567890999",
      "branchWaybillNo": "SF2234567890101",
      "seq": "3",
      "sum": "3",
      "remark": "有需要可以传自己需要备注的简短内容，没有可以不传该字段"
    }
  ]
}
```

请求报文4:使用自定义模板编辑器场景传值举例

```json
{
  "templateCode": "fm_76130_standard_{{clientcode}}",
  "customTemplateCode": "fm_76130_standard_custom_10000022213_1",
  "version": "2.0",
  "fileType": "pdf",
  "sync": true,
  "documents": [
    {
      "masterWaybillNo": "SF1234567890999",
      "customData": {
        "var123": "自定义变量内容"
      }
    }
  ]
}
```

###### <a id="responseJsonPost">2.7. 返回示例\应用场景(JSON)示例 

响应报文:

- 成功响应-同步:

```json
{
  "apiErrorMsg": "",
  "apiResponseID": "000189F87B1B193FE3DE5E798D07183F",
  "apiResultCode": "A1000",
  "apiResultData": "{\"obj\":{\"clientCode\":\"SLKJNH0b5Xc\",\"fileType\":\"pdf\",\"files\":[{\"areaNo\":1,\"documentSize\":0,\"pageCount\":0,\"pageNo\":1,\"seqNo\":1,\"token\":\"AUTH_tkv12_f146d1855480549d262b5c46ab0a***c608f9725bcd2\",\"url\":\"https://eos-scp-core-shenzhen-futian1-oss.sf-express.com:443/v1.2/AUTH_EOS-SCP-CORE/print-file/SLKJ***b5Xc_dqx-test-06102056_SF1687***931891_fm_76130_standard_SLKJ***b5Xc_1_1_1.pdf\",\"waybillNo\":\"SF1687***931891\"}],\"templateCode\":\"fm_76130_standard_SLKJ***b5Xc\"},\"requestId\":\"dqx-test-06102056\",\"success\":true}"
}

```

- 成功响应-异步:

```json
 {
  "apiErrorMsg": "",
  "apiResponseID": "00016ABEC9ECCB3FE1C04106BA87EF3F",
  "apiResultCode": "A1000",
  "apiResultData": "{\"requestId\": \"123\",\"success\": true}"
}

```

- 失败响应：

```json
{
  "apiErrorMsg": "auth_error:partnerID:test010d_is_not_exist",
  "apiResponseID": "00016ABEC9ECCB3FE1C04106BA87EF3F",
  "apiResultCode": "A1011",
  "apiResultData": "{***}"
}
```

###### 2.8. 面单pdf文件推送说明

**同步方式请求接口时不需要关注此部分内容**
此接口用于云打印文件推送，将文件推送给客户配置的回调地址，

###### 2.8.1接口基本信息

| 接口类型  | 推送                                                                             |
|-------|--------------------------------------------------------------------------------|
| 请求方式  | SF请求CP                                                                         |
| 接口方式  | HTTP /HTTPS POST Content_type:application/x-www-form-urlencoded; Charset=utf-8 |
| 接口服务码 | COM_PUSH_CLOUD_PRINT_WAYBILLS                                                  |

###### 2.8.2 元素<请求>Resquest

| 参数列表        | 类型          | 是否必传 | 含义                  |
|-------------|-------------|------|---------------------|
| logisticID  | String(20)  | Y    | 物流公司代码，SF代表顺丰       |
| requestID   | String(40)  | Y    | 请求唯一号UUID           |
| serviceCode | String(50)  | Y    | 接口服务代码 此处为面单推送接口服务码 |
| timestamp   | long        | Y    | 调用接口时间戳             |
| msgDigest   | String(128) | Y    | 数字签名 同CP请求SF的加密方式相同 |
| msgData     | String      | Y    | 业务数据报文              |
| nonce       | String      | N    | 调用接口随机数             |

###### 2.8.3 元素<请求>msgData

| # | 属性名          | 必填 | 默认值 | 描述                                                                                  |
|---|--------------|----|-----|-------------------------------------------------------------------------------------|
| 1 | content      | 是  |     | 文件数据,base64.encode后的数据                                                              |
| 2 | waybillNo    | 是  |     | 顺丰运单号（子母单为子单号）                                                                      |
| 3 | fileName     | 是  |     | 文件名(规则：clientCode+"*"+requestID+"*"+templateCode+"*"+单号+"*"+业务数据列表序号+"*"+联号+"*"+页号) |
| 4 | fileType     | 是  |     | 文件类型(pdf)                                                                           |
| 5 | seqNo        | 是  |     | 面单序号（批量打印场景，为documents的序号）                                                          |
| 6 | areaNo       | 是  |     | 联编号（大客户面单为固定值：1）                                                                    |
| 7 | pageNo       | 是  |     | 每联的页号(大客户面单为固定值：1)                                                                  |
| 8 | templateCode | 是  |     | 模板编码                                                                                |

###### 2.8.4 元素<响应>Response

| # | 属性名     | 类型（约束       | 必填 | 默认值 | 描述                    |
|---|---------|-------------|----|-----|-----------------------|
| 1 | success | String(10)  | 是  |     | 是否成功接收 true:是，false:否 |
| 2 | msg     | String(200) | 否  |     | 接收失败异常描述              |

###### 2.8.5报文范例

content是文件的内容，先base64.decode()解密得到byte[]，再转换成文件

```
{    "content": "ADWqad321ad=qqawd12542",    "fileName": "*_20190915152030.pdf",    "waybillNo": "432135131355",    "fileType": "pdf",    "seqNo": "1111",    "areaNo": "1",    "pageNo": "1",    "templateCode": "xxx"}
复制代码
```

解码示例

```
String message = "{\"content\":\"xxx\", \"fileType\":\"pdf\"}";String content = JSON.parseObject(message).getString("content");Base64Encoder base64Encoder = new Base64Encoder();byte[] fileBytes= base64Encoder.decode(content);Files.write(Paths.get("path.pdf"), fileBytes);
复制代码
```

###### 2.8.6.响应报文

成功

```
{    "success": "true",    "msg": ""}
复制代码
```

失败

```
{    "success": "false",    "msg": "xxx"}
```

###### <a id="errorCode">3.1. 错误代码 

##### 3.1 （API）平台结果代码列表

| 标识    | 说明                                                                        | 【处理建议】                                                                                                      |
|-------|---------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------|
| A1000 | 统一接入平台校验成功，调用后端服务成功； 注意：不代表后端业务处理成功，实际业务处理结果， 需要查看响应属性apiResultData中的详细结果 |                                                                                                             |
| A1001 | 必传参数不可为空                                                                  | serviceCode  partnerID requestID timestamp msgDigest msgData 不可为空                                           |
| A1002 | 请求时效已过期                                                                   | 时效参考auth2 https://open.sf-express.com/customerService/395002?interId=590549&amp;faqId=4                     |
| A1003 | IP无效                                                                      | 参考常见问题 https://open.sf-express.com/customerService/395002?activeIndex=905584&amp;interId=590549&amp;faqId=2 |
| A1004 | 无对应服务权限                                                                   | 联系销售经理，配置权限                                                                                                 |
| A1005 | 流量受控                                                                      | 测试环境流量限制为5000，请不要在测试环境做压测                                                                                   |
| A1006 | 数字签名无效                                                                    | 参考常见问题 签名加解密问题 https://open.sf-express.com/customerService/395002?activeIndex=905584&amp;interId=795986     |
| A1007 | 重复请求                                                                      | 过一分钟在尝试                                                                                                     |
| A1008 | 数据解密失败                                                                    |                                                                                                             |
| A1009 | 目标服务异常或不可达                                                                |                                                                                                             |
| A1099 | 系统异常                                                                      |                                                                                                             |

##### 3.2 业务异常代码