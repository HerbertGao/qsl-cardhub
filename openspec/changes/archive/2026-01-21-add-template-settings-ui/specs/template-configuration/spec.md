# 模板配置系统 - 增量规范

## 新增需求

### 需求：模板配置读取接口
系统必须提供读取当前模板配置的接口，供前端获取完整的模板参数。

#### 场景：获取默认模板配置
- **当** 前端调用 `get_template_config` 命令
- **那么** 系统必须读取 `config/templates/default.toml` 文件
- **并且** 返回完整的 `TemplateConfig` 结构（包含 metadata, page, layout, fonts, elements, output）
- **并且** 如果文件不存在或格式错误，返回错误信息

#### 场景：文件读取失败处理
- **当** 模板文件不存在或无读取权限
- **那么** 系统必须返回描述性错误信息
- **并且** 错误信息必须包含文件路径和失败原因

### 需求：模板配置保存接口
系统必须提供保存模板配置的接口，将用户修改的参数持久化到文件。

#### 场景：保存模板配置到文件
- **当** 前端调用 `save_template_config` 命令并传入 `TemplateConfig` 结构
- **那么** 系统必须将配置序列化为 TOML 格式
- **并且** 覆盖写入 `config/templates/default.toml` 文件
- **并且** 使用格式化的 TOML 输出（`toml::to_string_pretty`）保持可读性
- **并且** 保存成功后返回成功状态

#### 场景：配置验证
- **当** 保存模板配置时
- **那么** 系统必须验证配置的合法性（如边距 >= 0）
- **并且** 如果验证失败，返回具体的验证错误信息
- **并且** 不写入文件

#### 场景：文件写入失败处理
- **当** 文件无写入权限或磁盘空间不足
- **那么** 系统必须返回描述性错误信息
- **并且** 不覆盖原文件（保证原子性）

### 需求：模板设置用户界面
系统必须提供可视化的模板设置界面，让用户编辑模板参数并实时预览效果。

#### 场景：显示模板配置表单
- **当** 用户打开模板设置页面
- **那么** 系统必须调用 `get_template_config` 获取当前配置
- **并且** 在表单中显示所有配置字段
- **并且** 高频配置字段必须可编辑（边距、对齐、间距、元素高度）
- **并且** 低频配置字段必须只读显示（DPI、纸张尺寸、字体、元数据）

#### 场景：配置分组和折叠
- **当** 显示模板配置表单时
- **那么** 系统必须将配置按逻辑分组（页面配置、布局配置、元素配置等）
- **并且** 使用折叠面板组织各配置组
- **并且** 默认展开高频配置组（页面配置、布局配置）
- **并且** 默认折叠低频配置组（元数据、字体、输出）

#### 场景：字段编辑权限控制
- **当** 用户尝试编辑配置字段时
- **那么** 可编辑字段必须允许输入和修改
- **并且** 只读字段必须禁用输入（通过 `readonly` 或 `disabled` 属性）
- **并且** 可编辑字段包括：
  - `page.margin_*_mm`（四个边距）
  - `page.border`（边框开关）
  - `page.border_thickness_mm`（边框粗细）
  - `layout.align_h`、`layout.align_v`（对齐方式）
  - `layout.gap_mm`、`layout.line_gap_mm`（间距）
  - `elements[].max_height_mm`（文本元素高度）

### 需求：自动保存配置变更
系统必须在用户修改配置后自动保存，无需手动点击保存按钮。

#### 场景：配置变更自动保存
- **当** 用户修改可编辑字段的值
- **那么** 系统必须在 500ms 延迟后自动调用 `save_template_config`
- **并且** 使用防抖（debounce）机制避免频繁保存
- **并且** 保存成功后显示提示消息
- **并且** 保存失败后显示错误消息并允许重试

#### 场景：保存状态反馈
- **当** 系统正在保存配置时
- **那么** 必须显示保存状态指示（如"保存中..."）
- **并且** 保存成功后显示成功提示（如"配置已保存"）
- **并且** 保存失败后显示错误提示并包含失败原因

### 需求：实时预览功能
系统必须提供预览功能，让用户在修改配置后能够查看渲染效果。

#### 场景：刷新预览
- **当** 用户点击"刷新预览"按钮
- **那么** 系统必须使用当前表单中的配置生成预览
- **并且** 调用 `preview_qsl` 命令生成 PNG 预览图
- **并且** 使用测试数据填充运行时字段（task_name, callsign, sn, qty）
- **并且** 在右侧预览区域显示生成的图片
- **并且** 显示加载状态指示

#### 场景：预览生成失败处理
- **当** 预览生成失败（如配置参数无效）
- **那么** 系统必须显示错误提示
- **并且** 错误提示必须包含失败原因
- **并且** 不清除上一次成功的预览图

#### 场景：预览布局
- **当** 显示预览区域时
- **那么** 预览必须位于页面右侧
- **并且** 预览卡片必须包含标题"预览"和刷新按钮
- **并且** 预览图片必须自适应容器宽度
- **并且** 提供预览说明："预览仅供参考，实际打印可能有细微差异"

### 需求：表单验证和约束
系统必须验证用户输入的配置参数，防止无效配置导致系统异常。

#### 场景：数值范围验证
- **当** 用户输入边距或间距值时
- **那么** 系统必须验证数值 >= 0
- **并且** 如果输入无效，显示错误提示
- **并且** 阻止保存无效配置

#### 场景：字段提示和说明
- **当** 用户查看配置字段时
- **那么** 每个字段必须有清晰的标签（如"左边距"）
- **并且** 必须标注单位（如"mm"）
- **并且** 可选择性提供 tooltip 说明字段作用和推荐值

### 需求：配置变更生效
用户修改并保存的模板配置必须在后续打印操作中立即生效。

#### 场景：配置变更应用到打印
- **当** 用户修改并保存模板配置后
- **那么** 下次调用 `print_qsl` 或 `preview_qsl` 时
- **并且** 系统必须重新加载模板文件（模板热重载已在之前的变更中实现）
- **并且** 使用最新的配置参数进行布局和渲染
