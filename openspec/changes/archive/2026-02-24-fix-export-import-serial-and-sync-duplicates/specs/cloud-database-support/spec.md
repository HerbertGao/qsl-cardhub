## MODIFIED Requirements

### 需求：数据导出功能

系统**必须**支持将本地数据库导出为 JSON 文件，便于备份和迁移。

#### 场景：导出全部数据

**前提条件：**
- 本地数据库已初始化

**操作步骤：**
1. 用户打开"数据管理"页面
2. 用户点击"导出数据"按钮
3. 系统弹出文件保存对话框
4. 用户选择保存位置和文件名
5. 用户确认保存

**预期结果：**
- 文件扩展名为 `.qslhub`
- 文件格式为 JSON（UTF-8 编码）
- 文件包含元信息：
  - `version`: 导出格式版本（"1.1"）
  - `db_version`: 数据库版本号（整数）
  - `db_version_display`: 可读版本号（如 "2026.1.23.003"）
  - `app_version`: 应用版本号
  - `exported_at`: 导出时间戳（ISO 8601 格式）
  - `client_id`: 云端同步客户端标识（可选，仅当已配置同步时包含）
- 文件包含所有表的数据：
  - `tables.projects`: 项目列表
  - `tables.cards`: 卡片列表（必须包含 serial 字段）
  - `tables.sf_senders`: 顺丰寄件人列表
  - `tables.sf_orders`: 顺丰订单列表
- 导出成功后显示统计信息（项目数、卡片数、寄件人数、订单数）
- 默认文件名格式：`qslhub_backup_YYYYMMDD_HHmmss.qslhub`

#### 场景：导出包含 client_id

- **当** 用户已配置云端同步（sync.toml 存在且包含 client_id）
- **那么** 导出文件的顶层必须包含 `client_id` 字段，值为当前同步配置的 client_id

#### 场景：未配置同步时导出

- **当** 用户未配置云端同步（sync.toml 不存在）
- **那么** 导出文件的顶层 `client_id` 字段必须为 null 或不存在

#### 场景：空数据库导出

**前提条件：**
- 本地数据库已初始化但无数据

**操作步骤：**
1. 用户点击"导出数据"

**预期结果：**
- 导出成功
- 文件中表数据为空数组
- 版本信息正确

---

### 需求：数据导入功能

系统**必须**支持从 JSON 文件导入数据到本地数据库，并进行版本兼容性检查。导入时**必须**完整恢复所有字段，包括卡片的 serial（序号）字段。

#### 场景：导入兼容版本数据

**前提条件：**
- 导入文件的 `db_version` <= 本地数据库版本
- 导入文件格式正确

**操作步骤：**
1. 用户打开"数据管理"页面
2. 用户点击"导入数据"按钮
3. 系统弹出文件选择对话框（过滤 `.qslhub` 文件）
4. 用户选择文件
5. 系统显示导入预览对话框：
   - 文件版本信息
   - 导出时间
   - 数据统计（项目数、卡片数等）
   - 版本兼容性状态
6. 系统显示覆盖警告："导入将覆盖本地所有数据，此操作不可逆"
7. 用户确认导入

**预期结果：**
- 本地数据被清空（事务内）
- 导入文件中的数据写入数据库（事务内）
- 卡片的 serial 字段必须正确写入数据库，禁止遗漏
- 如果发生错误，事务回滚，本地数据不变
- 导入成功后显示统计信息
- 页面数据自动刷新

#### 场景：导入包含 client_id 的文件

- **当** 导入文件的顶层包含非空 `client_id` 字段
- **那么** 系统必须将该 `client_id` 写入本地 sync.toml 配置
- **并且** 必须保留 sync.toml 中已有的 `api_url` 和 `last_sync_at` 不变
- **并且** 如果 sync.toml 不存在，必须创建包含该 `client_id` 的默认配置

#### 场景：导入不含 client_id 的旧版文件

- **当** 导入文件不包含 `client_id` 字段或其值为 null
- **那么** 系统必须跳过 client_id 恢复，不修改本地 sync.toml
- **并且** 导入流程正常完成，不报错

#### 场景：拒绝高版本数据导入

**前提条件：**
- 导入文件的 `db_version` > 本地数据库版本

**操作步骤：**
1. 用户选择高版本的 `.qslhub` 文件

**预期结果：**
- 预览对话框显示错误状态
- 错误信息："导入文件的数据库版本（X.X.X.XXX）高于本地版本（Y.Y.Y.YYY），请升级应用后再导入"
- "确认导入"按钮禁用
- 本地数据不受影响

#### 场景：导入格式错误的文件

**前提条件：**
- 选择的文件不是有效的 JSON 或缺少必要字段

**操作步骤：**
1. 用户选择格式错误的文件

**预期结果：**
- 显示错误提示："文件格式错误，请选择有效的 QSL-CardHub 导出文件"
- 本地数据不受影响

#### 场景：导入过程中发生错误

**前提条件：**
- 导入文件格式正确
- 数据插入过程中发生错误（如外键约束失败）

**操作步骤：**
1. 用户确认导入
2. 系统开始导入
3. 导入过程中发生错误

**预期结果：**
- 事务回滚
- 本地数据保持不变
- 显示具体错误信息