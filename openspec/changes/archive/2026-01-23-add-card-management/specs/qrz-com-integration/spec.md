# 规范：QRZ.com 登录和呼号查询集成 (Phase 2)

## 新增需求

### 需求：QRZ.com 登录配置

系统必须提供 QRZ.com 登录配置功能,允许用户输入用户名和密码获取会话 Cookie。配置界面在独立的 QRZ.com 配置页面中显示。

#### 场景：访问 QRZ.com 配置页面

- **当** 用户点击"数据配置"菜单下的"QRZ.com"子菜单项
- **那么** 系统必须打开 QRZ.com 配置页面
- **并且** 页面必须使用标准页面布局（page-content）

#### 场景：配置 QRZ.com 登录凭据

- **当** 用户在 QRZ.com 配置页面查看配置表单
- **那么** 系统必须显示以下表单元素:
  - 页面标题："QRZ.com 配置"
  - 功能说明文本
  - 用户名输入框(必填)
  - 密码输入框(必填,密码遮罩显示)
  - "保存并登录"按钮
  - "清除凭据"按钮
  - "测试连接"按钮
- **并且** 显示当前登录状态(已登录/未登录)
- **并且** 如果已登录,显示 Cookie 有效期提示
- **并且** 如果已保存凭据,显示提示"已保存凭据"

#### 场景：保存登录凭据并登录

- **当** 用户填写用户名和密码
- **并且** 点击"保存并登录"按钮
- **那么** 系统必须使用凭据加密存储系统保存凭据
- **并且** 存储键为 `qsl-cardhub:qrz.com:username` 和 `qsl-cardhub:qrz.com:password`
- **并且** 凭据不得明文存储（参考 **local-credential-storage** 规范）
- **并且** 自动执行登录操作
- **并且** 登录成功后显示"登录成功，凭据已保存"提示
- **并且** 内存中保存会话 Cookie

#### 场景：清除已保存凭据

- **当** 用户点击"清除凭据"按钮
- **那么** 系统必须显示确认对话框："确定要清除已保存的 QRZ.com 凭据吗？"
- **并且** 用户确认后
- **那么** 系统必须从凭据存储中删除用户名和密码
- **并且** 清除内存中的 Cookie
- **并且** 登录状态更新为"未登录"
- **并且** 清空表单中的用户名和密码输入框
- **并且** 隐藏"已保存凭据"提示
- **并且** 显示"凭据已清除"提示

#### 场景：自动加载已保存凭据

- **当** 用户打开 QRZ.com 配置页面
- **那么** 系统必须自动调用后端加载凭据
- **并且** 如果凭据存在,自动填充用户名和密码到输入框（密码遮罩显示）
- **并且** 显示"已保存凭据"提示
- **并且** 显示存储方式提示（系统钥匙串/本地加密文件）

#### 场景：执行 QRZ.com 登录

- **当** 用户点击"保存并登录"按钮
- **那么** 系统必须发送 HTTP POST 请求到 `https://www.qrz.com/login`
- **并且** 请求必须包含以下头部:
  - `Content-Type: application/x-www-form-urlencoded`
  - `User-Agent: Mozilla/5.0`
  - `Referer: https://www.qrz.com/`
- **并且** 请求体必须包含表单数据:
  - `username=<用户名>`
  - `password=<密码>`
  - `login_ref=https%3A%2F%2Fwww.qrz.com%2F`
  - `target=%2F`
  - `flush=1`
  - `2fcode=` (空值)
- **并且** 系统必须从响应头中提取 Set-Cookie 字段
- **并且** 必须保存 xf_session Cookie 值
- **并且** Cookie 必须存储到应用状态中供后续查询使用

#### 场景：登录成功

- **当** QRZ.com 登录请求返回 HTTP 200
- **并且** 响应头包含 `Set-Cookie: xf_session=xxx`
- **那么** 系统必须将 Cookie 存储到内存中的应用状态
- **并且** Cookie 格式为:
  ```rust
  struct QrzComSession {
      xf_session: String,
      expires_at: DateTime<Utc>, // 从 Max-Age 推算（约 30 天后过期）
  }
  ```
- **并且** Cookie 仅内存存储,应用关闭后丢弃
- **并且** 系统必须显示"登录成功"消息
- **并且** 登录状态必须更新为"已登录"
- **并且** 显示 Cookie 有效期提示

#### 场景：登录失败

- **当** QRZ.com 登录请求失败(网络错误、凭据错误等)
- **那么** 系统必须显示"登录失败"错误消息
- **并且** 必须包含具体错误原因
- **并且** 登录状态必须保持为"未登录"
- **并且** 不得保存无效的 Cookie

---

### 需求：分发弹框中的呼号地址查询

系统必须在卡片分发弹框中提供基于 QRZ.com 的呼号查询功能,实时查询并展示呼号对应的地址信息。

#### 场景：在分发弹框中显示地址查询功能

- **当** 用户打开卡片分发弹框
- **那么** 系统必须在收件地址区域上方显示"查询 QRZ.com 地址"按钮
- **并且** 按钮必须关联当前卡片的呼号
- **并且** 如果用户未登录 QRZ.com,按钮必须禁用并显示提示"请先在数据配置中设置 QRZ.com 登录"

#### 场景：执行呼号查询

- **当** 用户点击"查询地址"按钮
- **那么** 系统必须发送 HTTP GET 请求到 `https://www.qrz.com/db/<呼号>`
- **并且** 请求必须包含以下头部:
  - `User-Agent: Mozilla/5.0`
  - `Referer: https://www.qrz.com/`
  - `Cookie: xf_session=<已保存的xf_session>`
- **并且** 系统必须接收 UTF-8 编码的 HTML 响应

#### 场景：解析呼号查询结果

- **当** 收到 QRZ.com 查询响应
- **那么** 系统必须解析 HTML 响应内容
- **并且** 必须提取以下信息:
  - 呼号(在 `<span class="csignm hamcall">` 标签内,如 `<span class="csignm hamcall">BY1CRA</span>`)
  - 姓名和地址(在 `<p class="m0" style="color: #666; font-weight: normal; font-size: 17px">` 标签内)
    - 第一行 `<span style="color: black; font-weight: bold">` 为姓名/组织名
    - 后续 `<br/>` 分隔的行为地址行
  - 最后更新时间(在 Detail 标签页的 `<tr><td class="dh">Last Update</td><td class="di">` 后,如 `2020-04-26 12:33:04`)
- **并且** 如果呼号不存在,必须检测 404 错误或"Not Found"提示

#### 场景：显示查询结果

- **当** 呼号查询成功或显示缓存数据
- **那么** 系统必须在分发弹框的地址展示区域按以下格式显示:
  ```
  呼号: BY*** (qrz.com)
  姓名: Chinese Amateur Radio Club Station
  地址: Box 100029-73
        Beijing 100029
        China
  更新时间: 2020-04-26
  缓存时间: 2026-01-22 10:30
  ```
- **并且** 各字段显示规则:
  - 呼号: 显示从 QRZ.com 查询到的呼号，后面跟数据来源标识 `(qrz.com)`
  - 姓名: 姓名或组织名称
  - 地址: 多行地址信息（每行独立显示）
  - 更新时间: QRZ.com 显示的数据更新日期（格式: YYYY-MM-DD）
  - 缓存时间: 本地查询时间（格式: YYYY-MM-DD HH:mm）
- **并且** 所有地址信息必须可复制
- **并且** 提供"复制地址"快捷按钮
- **并且** 地址信息为只读展示，不自动填充到收件地址输入框

#### 场景：查询失败处理

- **当** 呼号查询失败(网络错误、Cookie 过期、呼号不存在等)
- **那么** 系统必须显示错误消息
- **并且** 如果是 Cookie 过期,必须提示"登录已过期,请重新登录"
- **并且** 如果是呼号不存在,必须显示"呼号未找到"
- **并且** 如果是网络错误,必须显示具体错误信息

#### 场景：查询结果缓存（智能去重）

- **当** 查询成功获取呼号地址
- **那么** 系统必须检查最新缓存记录的数据内容
- **并且** 比较以下字段是否完全一致:
  - `callsign`（呼号）
  - `name`（姓名）
  - `address`（地址，完整字符串）
  - `data_updated_at`（QRZ.com 数据更新日期）
- **当** 数据内容完全一致（仅 `cached_at` 不同）
- **那么** 系统必须更新现有记录的 `cached_at` 字段为当前查询时间
- **并且** 不得创建新记录
- **当** 数据内容有任何差异
- **那么** 系统必须更新 `address_cache` 中的记录
- **并且** 缓存格式为:
  ```json
  {
    "address_cache": [
      {
        "source": "qrz.com",
        "callsign": "BY***",
        "name": "Chinese Amateur Radio Club Station",
        "address": "Box 100029-73\nBeijing 100029\nChina",
        "data_updated_at": "2020-04-26",
        "cached_at": "2026-01-22T10:30:00+08:00"
      }
    ]
  }
  ```
- **并且** `source` 字段必须固定为 `"qrz.com"`,标识数据来源
- **并且** `data_updated_at` 存储 QRZ.com 显示的数据更新日期
- **并且** `cached_at` 存储查询时间（本地时间戳）
- **并且** 数组按 `cached_at` 降序排列，最新查询结果在最前面

#### 场景：单版本缓存规则

- **当** 查询成功获取新数据
- **那么** 系统必须检查该来源是否已有缓存记录
- **并且** 如果数据有变化，直接覆盖原有记录（单版本）
- **并且** 如果数据无变化，仅更新 `cached_at` 时间戳

#### 场景：优先显示缓存数据

- **当** 用户打开分发弹框
- **并且** 卡片的 metadata 包含地址缓存记录
- **那么** 系统必须自动显示最新的缓存地址
- **并且** 按标准格式显示呼号、姓名、地址、更新时间、缓存时间
- **并且** 如果缓存距今不超过 365 天（1年），数据有效
- **并且** 如果缓存距今超过 365 天，显示提示"数据已过期，建议刷新"
- **并且** 提供"刷新"按钮供用户手动更新

#### 场景：手动刷新地址

- **当** 用户在分发弹框中点击"刷新"按钮
- **那么** 系统必须向 QRZ.com 发起实时查询
- **并且** 查询期间显示加载状态
- **并且** 查询成功后将新结果更新到 address_cache
- **并且** 自动显示最新查询结果
- **并且** 更新缓存时间标识

---

## 相关规范

- **card-entry-and-management**(Phase 2): 卡片录入和管理(依赖,在分发弹框中集成查询功能)
- **local-credential-storage**(Phase 2): 本地凭据加密存储(用于安全存储 QRZ.com 密码)
- **qrz-cn-integration**(Phase 2): QRZ.cn 集成(相似功能,不同数据源)

## 技术约束

- **登录接口**: `https://www.qrz.com/login`
- **查询接口**: `https://www.qrz.com/db/<CALLSIGN>`
- **编码格式**: 响应为 UTF-8 编码
- **Cookie 字段**: xf_session
- **Cookie 过期**: 约 30 天（从 Max-Age 推算）
- **Cookie 存储**: 仅内存存储,应用关闭后丢弃
- **凭据存储**: 使用凭据加密存储系统（详见 **local-credential-storage** 规范）
- **存储键**: `qsl-cardhub:qrz.com:username` 和 `qsl-cardhub:qrz.com:password`
- **凭据清除**: 提供"清除凭据"按钮,需用户确认
- **查询模式**: 优先显示缓存，支持手动刷新
- **缓存有效期**: 365 天（1年，超过显示过期提示）
- **数据来源标识**: 所有查询结果必须标记 `source: "qrz.com"`
- **版本管理**: 地址缓存记录存储在 `metadata.address_cache` 数组中
- **缓存去重**: 数据完全一致时仅更新缓存时间，不创建新记录
- **单版本缓存**: 每个来源只保留1条最新记录，数据变化时直接覆盖
- **展示格式**:
  ```
  呼号: [呼号] (qrz.com)
  姓名: [姓名]
  地址: [地址行1]
        [地址行2]
        [地址行3]
  更新时间: YYYY-MM-DD
  缓存时间: YYYY-MM-DD HH:mm
  ```
- **HTML 解析**:
  - 呼号: `<span class="csignm hamcall">呼号</span>`
  - 地址: `<p class="m0" style="color: #666; font-weight: normal; font-size: 17px">...</p>`
  - 更新时间: `<tr><td class="dh">Last Update</td><td class="di">日期时间</td></tr>`
- **页面布局**: QRZ.com 配置页面使用标准页面布局（page-content）
- **存储方式提示**: 页面显示当前使用的存储方式（本地加密文件）

## 向后兼容性

- ✅ 无破坏性变更,新增功能
- ✅ 依赖 Phase 2 卡片管理功能
- ✅ QRZ.com 登录为可选功能,不影响现有卡片管理流程
- ✅ QRZ.com 配置页面为独立页面,不影响现有页面布局
- ✅ 地址缓存格式兼容不同数据源（qrz.cn 和 qrz.com）
