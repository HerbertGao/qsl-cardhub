## 新增需求

### 需求：启动时更新检查

应用启动时必须自动检查更新，并在有新版本时提供视觉提示。

#### 场景：启动时自动检查

- **当** 应用启动完成后
- **那么** 必须在后台静默检查是否有新版本
- **并且** 检查过程不能阻塞应用启动
- **并且** 检查过程不能显示任何加载提示
- **并且** 如果检查失败，必须静默忽略（不提示用户）

#### 场景：发现新版本时显示菜单标记

- **当** 启动时检查发现有新版本
- **那么** 必须在侧边栏的"关于"菜单项旁显示红色标记（红点或徽章）
- **并且** 红色标记必须持续显示直到用户查看关于页面
- **并且** 红色标记样式必须醒目但不突兀

#### 场景：已是最新版本

- **当** 启动时检查发现已是最新版本
- **那么** 不显示任何提示
- **并且** "关于"菜单项保持正常样式

---

### 需求：检查更新功能

应用必须提供检查更新功能，让用户能够发现并获取新版本。

#### 场景：手动检查更新

- **当** 用户在关于页面点击"检查更新"按钮
- **那么** 应用必须请求 GitHub Releases API 获取最新版本信息
- **并且** 必须显示加载状态（如"正在检查..."）
- **并且** 如果有新版本，必须显示更新对话框
- **并且** 如果已是最新版本，必须显示"已是最新版本"提示
- **并且** 如果检查失败，必须显示友好的错误信息

#### 场景：更新信息展示

- **当** 检测到有新版本可用
- **那么** 更新对话框必须显示新版本号
- **并且** 必须显示发布日期
- **并且** 必须显示更新日志（Release Notes）
- **并且** 必须显示下载按钮
- **并且** 必须显示"稍后提醒"选项

#### 场景：网络错误处理

- **当** 检查更新时网络请求失败
- **那么** 必须显示"无法连接到更新服务器"错误
- **并且** 必须提供重试按钮
- **并且** 必须提供手动下载链接（指向 GitHub Releases 页面）

---

### 需求：下载更新功能

应用必须支持在应用内下载更新包。

#### 场景：开始下载更新

- **当** 用户在更新对话框点击"下载更新"按钮
- **那么** 应用必须开始后台下载更新包
- **并且** 必须显示下载进度条
- **并且** 必须显示已下载大小和总大小
- **并且** 必须显示下载速度
- **并且** 用户必须能够继续使用应用

#### 场景：下载进度更新

- **当** 更新包下载过程中
- **那么** 进度条必须实时更新
- **并且** 进度百分比必须准确反映下载状态
- **并且** 如果网络中断，必须提示并允许重试

#### 场景：取消下载

- **当** 用户点击"取消下载"按钮
- **那么** 必须立即停止下载
- **并且** 必须清理已下载的临时文件
- **并且** 必须恢复到检查更新状态

#### 场景：下载完成

- **当** 更新包下载完成
- **那么** 必须显示"下载完成"状态
- **并且** 必须显示"立即安装"按钮
- **并且** 必须显示"稍后安装"选项

---

### 需求：安装更新功能

应用必须支持安装已下载的更新包。

#### 场景：Windows 安装更新

- **当** 用户在 Windows 上点击"立即安装"
- **那么** 应用必须验证更新包签名
- **并且** 签名验证通过后，必须启动 NSIS 安装程序
- **并且** 安装程序必须以静默模式运行
- **并且** 当前应用必须退出以完成安装
- **并且** 安装完成后必须自动启动新版本

#### 场景：macOS 安装提示

- **当** 用户在 macOS 上点击"立即安装"
- **那么** 应用必须将 DMG 文件保存到用户下载目录
- **并且** 必须在 Finder 中显示该文件
- **并且** 必须显示安装指南对话框
- **并且** 指南必须说明"拖拽应用到 Applications 文件夹"
- **并且** 必须提供"打开安装文件"按钮

#### 场景：签名验证失败

- **当** 更新包签名验证失败
- **那么** 必须显示安全警告
- **并且** 必须阻止安装
- **并且** 必须建议用户从官方渠道下载
- **并且** 必须提供 GitHub Releases 链接

---

### 需求：更新清单配置

CI/CD 必须生成更新清单文件，供应用检查更新使用。

#### 场景：生成 latest.json

- **当** GitHub Actions 发布新版本
- **那么** 必须生成 `latest.json` 更新清单
- **并且** 清单必须包含版本号、发布日期、更新日志
- **并且** 清单必须包含各平台的下载 URL
- **并且** 清单必须包含各平台的签名
- **并且** 清单必须上传到 GitHub Releases

#### 场景：更新清单格式

- **当** 应用解析 latest.json
- **那么** JSON 结构必须符合 Tauri Updater 格式
- **并且** 必须包含 `version`、`notes`、`pub_date` 字段
- **并且** 必须包含 `platforms` 对象，键为平台标识符
- **并且** 每个平台必须包含 `signature` 和 `url` 字段

---

### 需求：更新包签名

所有更新包必须经过签名，确保来源可信。

#### 场景：构建时签名

- **当** CI/CD 构建更新包
- **那么** 必须使用私钥对更新包进行签名
- **并且** 必须生成 `.sig` 签名文件
- **并且** 私钥必须存储在 GitHub Secrets 中
- **并且** 签名必须使用 Ed25519 算法

#### 场景：应用端验证

- **当** 应用准备安装更新
- **那么** 必须使用公钥验证更新包签名
- **并且** 公钥必须内嵌在应用配置中
- **并且** 如果验证失败，必须拒绝安装

---

### 需求：NSIS 安装包支持

系统必须生成 NSIS 格式的 Windows 安装包，支持静默升级。

#### 场景：生成 NSIS 安装包

- **当** CI/CD 构建 Windows 版本
- **那么** 除了 MSI 格式外，必须同时生成 NSIS 格式安装包
- **并且** NSIS 包文件名格式为 `qsl-cardhub-v{version}-windows-{arch}-setup.exe`
- **并且** NSIS 包必须支持静默安装（`/S` 参数）
- **并且** NSIS 包必须支持覆盖安装（升级场景）

#### 场景：自动更新使用 NSIS

- **当** 应用执行自动更新
- **那么** 必须下载 NSIS 格式的安装包
- **并且** 必须以静默模式执行安装
- **并且** 安装完成后必须自动启动新版本
