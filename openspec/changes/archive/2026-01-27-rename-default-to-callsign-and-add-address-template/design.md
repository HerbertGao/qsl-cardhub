# 设计文档：重命名默认模板并新增地址模板

## 上下文

当前系统使用 `default.toml` 作为默认打印模板，主要用于打印呼号标签。为了更清晰地表达模板用途，需要将其重命名为 `callsign.toml`。

同时，在卡片分发场景中，用户需要打印地址信息用于邮寄。现有系统只提供复制地址功能，缺少直接打印地址的功能。

## 目标 / 非目标

### 目标
- 将 `default.toml` 重命名为 `callsign.toml`，使模板名称更清晰
- 创建地址模板 `address.toml`，支持打印完整的地址信息
- 在分发对话框中提供打印地址按钮，方便用户快速打印地址
- 地址模板在同一张纸上打印两遍，方便用户裁剪使用
- 地址模板不打印日期信息

### 非目标
- 不支持多模板选择界面（v1 暂时固定使用 callsign.toml 和 address.toml）
- 不支持自定义地址模板布局（v1 使用固定布局）

## 决策

### 1. 模板文件重命名策略

**决策**：将 `default.toml` 重命名为 `callsign.toml`，并更新所有引用。

**理由**：
- 模板名称更清晰地表达用途（呼号标签）
- 为后续可能添加的其他模板类型（如地址模板）预留空间

**迁移方案**：
- 在代码中更新所有硬编码的 `default.toml` 引用
- 配置文件中的 `template.path` 需要从 `"default.toml"` 更新为 `"callsign.toml"`
- 如果用户配置中仍使用 `"default.toml"`，系统应自动回退到 `callsign.toml`

### 2. 地址模板设计

**决策**：创建独立的 `address.toml` 模板文件，参考现有的标签模板配置。

**地址模板元素**：
- 姓名（如果有）
- 中文地址（如果有）
- 英文地址（如果有）
- 邮寄方式（如果有）
- 呼号（用于标识）

**不包含的元素**：
- 日期信息（不打印）

**布局设计**：
- 同一张纸（76mm × 130mm）上打印两遍
- 上半部分：正常布局，高度为纸张高度的一半（65mm）
- 下半部分：完全复制上半部分的布局，垂直偏移到下半部分
- 上下两部分完全一致（元素位置、大小、内容）

### 3. 地址数据来源

**决策**：从分发对话框的地址缓存中获取地址数据。

**数据格式处理**：
- **qrz.cn**：使用 `chinese_address` 和 `english_address`
- **qrz.com**：使用 `english_address`（可能包含姓名）
- **QRZ卡片查询**：使用 `name`、`english_address` 和 `mail_method`

**数据优先级**：
- 优先使用中文地址（如果存在）
- 如果只有英文地址，使用英文地址
- 如果存在姓名，单独显示姓名行

### 4. 双份打印布局实现

**决策**：在布局引擎中支持双份打印模式。

**实现方案**：
1. 正常计算上半部分的布局
2. 复制所有元素到下半部分，垂直偏移 `height_mm / 2`
3. 确保上下两部分完全一致

**技术细节**：
- 在 `LayoutEngine` 中添加 `duplicate_layout` 方法
- 在 `TemplateConfig` 中添加 `duplicate_print` 配置项（布尔值）
- 当 `duplicate_print = true` 时，自动生成双份布局

### 5. 地址模板配置界面

**决策**：在现有的 `TemplateView.vue` 中添加模板类型选择。

**实现方案**：
- 添加模板类型选择器（呼号模板/地址模板）
- 根据选择的模板类型，加载对应的模板配置
- 地址模板的配置界面与呼号模板类似，但元素配置不同

## 风险 / 权衡

### 风险
1. **向后兼容性**：现有配置文件中可能仍使用 `"default.toml"`，需要处理回退逻辑
2. **地址数据格式**：不同地址源的数据格式不同，需要统一处理
3. **双份打印布局**：需要确保上下两部分完全一致，避免布局计算错误

### 缓解措施
1. 在模板加载函数中添加回退逻辑，如果找不到 `callsign.toml`，尝试加载 `default.toml`
2. 在地址数据格式化函数中统一处理不同来源的数据格式
3. 在布局引擎中添加双份打印的单元测试，确保布局正确

## 迁移计划

### 步骤
1. 重命名模板文件：`default.toml` → `callsign.toml`
2. 更新代码中所有引用
3. 创建地址模板文件 `address.toml`
4. 实现地址打印功能
5. 更新前端界面
6. 测试验证

### 回滚
如果出现问题，可以：
1. 将 `callsign.toml` 重命名回 `default.toml`
2. 恢复代码中的引用
3. 删除地址模板相关代码

## 待决问题

- [ ] 地址模板的默认元素配置（哪些字段必须显示，哪些可选）
- [ ] 双份打印时是否需要添加分割线
- [ ] 地址模板的字体大小和间距配置
