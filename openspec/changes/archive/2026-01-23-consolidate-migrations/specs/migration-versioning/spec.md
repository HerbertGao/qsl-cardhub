# migration-versioning 规范增量

## 修改需求

### 需求：迁移文件自动发现

系统**必须**自动发现 `migrations/` 目录下的所有迁移脚本，支持新旧两种版本号格式。

#### 场景：解析新格式版本号

**给定** 迁移文件名为 `2026.1.23.001_add_feature.sql`
**当** 系统解析文件名时
**则** 应该正确提取版本号组件：年=2026，月=1，日=23，子版本=001
**并且** 生成可比较的整数版本号 `60123001`

#### 场景：新格式文件命名规范

**给定** 需要创建新的迁移文件
**当** 日期为 2026年1月23日且是当天第一个迁移
**则** 文件名应为 `2026.1.23.001_{description}.sql`
**并且** 月份和日期不需要补零

#### 场景：同一天多个迁移

**给定** 2026年1月23日已有迁移 `2026.1.23.001_xxx.sql`
**当** 需要添加第二个迁移
**则** 新迁移文件名应为 `2026.1.23.002_{description}.sql`
**并且** 子版本号递增

---

## 新增需求

### 需求：向后兼容旧版本号

系统**必须**同时支持旧格式（`NNN_xxx.sql`）和新格式版本号。

#### 场景：解析旧格式版本号

**给定** 迁移文件名为 `001_init.sql`
**当** 系统解析文件名时
**则** 应该正确提取版本号 `1`
**并且** 该版本号应小于任何新格式版本号

#### 场景：混合格式排序

**给定** 存在迁移文件 `001_init.sql`、`005_xxx.sql`、`2026.1.23.001_yyy.sql`
**当** 系统对迁移文件排序时
**则** 执行顺序应为 `001` → `005` → `2026.1.23.001`
**并且** 旧格式始终在新格式之前

#### 场景：旧数据库升级

**给定** 数据库当前版本为 5（旧格式）
**并且** 存在新迁移 `2026.1.24.001_new_feature.sql`
**当** 执行迁移时
**则** 新迁移应该被执行
**并且** 数据库版本更新为 `60124001`

---

### 需求：版本号整数转换

系统**必须**将日期化版本号转换为可比较的整数，用于存储在 SQLite 的 `user_version` 中。

#### 场景：版本号转整数

**给定** 版本号 `2026.1.23.001`
**当** 转换为整数时
**则** 结果应为 `(2026 - 2020) * 10000000 + 123 * 1000 + 1` = `60123001`

#### 场景：整数范围

**给定** 版本号范围为 2020-2099 年
**当** 转换为整数时
**则** 所有版本号应在 32 位有符号整数范围内（< 2147483647）

#### 场景：版本号比较

**给定** 版本号 A = `2026.1.23.001` 和 B = `2026.1.24.001`
**当** 比较两个版本号时
**则** B 应大于 A
**并且** `60123001` < `60124001`
