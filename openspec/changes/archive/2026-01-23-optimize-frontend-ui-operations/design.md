# 前端界面操作优化 - 设计文档

## 架构决策

### 决策 1：task_name 重命名为 project_name 并变更数据来源

**背景**：
- 当前：打印配置（Profile）中存储 task_name，打印时直接使用
- 变更：
  1. 移除配置中的 task_name
  2. 将模板中的 `task_name` 统一重命名为 `project_name`
  3. 从卡片所属的项目（Project）获取 project_name

**命名变更**：
```
task_name → project_name（全局替换）
```

影响范围：
- 打印模板配置文件（TOML）
- 后端数据结构
- 前端显示文本

**数据流变化**：

```
【当前流程】
打印页面 → Profile.task_name → 打印模板

【变更后流程-录入打印】
卡片管理 → Card.project_id → Project.name → 打印模板 (project_name)

【变更后流程-列表打印】
卡片列表 → Card.project_id → Project.name → 打印模板 (project_name)
```

> 注意：独立的打印页面将被移除，所有打印操作都在卡片管理中进行。

**影响**：
1. 后端 Profile 结构体移除 `task_name` 字段
2. 打印模板 `task_name` 重命名为 `project_name`
3. **删除独立打印页面（PrintView.vue）**
4. 卡片管理的打印功能自动使用所属项目名称

### 决策 2：序列号作为卡片属性

**背景**：序列号是卡片的固有属性，应当存储在卡片记录中，而非仅用于打印。

**数据库变更**：
```sql
ALTER TABLE cards ADD COLUMN serial TEXT;
```

**数据模型变更**：
```typescript
interface Card {
  id: string
  project_id: string
  callsign: string
  qty: number
  serial: string | null  // 新增：序列号，三位数格式如 "001"
  status: CardStatus
  metadata: CardMetadata | null
  created_at: string
  updated_at: string
}
```

### 决策 3：打印与录入的集成方式

**方案选择**：在录入对话框中添加「打印标签」复选框，序列号作为卡片信息的一部分。

**详细设计**：

```
┌─────────────────────────────────────────┐
│ 录入卡片                               X │
├─────────────────────────────────────────┤
│                                          │
│ 转卡     [项目下拉选择]                   │
│                                          │
│ 呼号     [________________]               │
│                                          │
│ 数量     [1           ▼]                  │
│                                          │
│ 序列号   [1    ] 预览: 001  [重置]        │
│                                          │
│ ☑ 跳过包含数字 4 的序列号                  │
│                                          │
│ ─────────────────────────────────────    │
│                                          │
│ ☑ 打印标签                                │
│                                          │
│ ☐ 连续录入模式                            │
│                                          │
├─────────────────────────────────────────┤
│            [取消]  [录入并打印]            │
└─────────────────────────────────────────┘
```

**设计要点**：
- 序列号放在「数量」下方，作为卡片信息的一部分
- 跳过4选项紧跟序列号
- 打印设置区域仅包含「打印标签」复选框
- 打印机从全局配置获取（单配置模式）

**序列号自动计算逻辑**：
```
打开对话框 / 切换项目
    ↓
查询项目下所有卡片的 serial 字段
    ↓
找到最大值（忽略空值，解析为数字比较）
    ↓
最大值 + 1（如果没有卡片则为 1）
    ↓
如果勾选「跳过4」，跳过包含 4 的数字
    ↓
设置为序列号默认值
```

**行为说明**：
- 「打印标签」默认勾选
- 勾选时按钮文字变为「录入并打印」
- 取消勾选时按钮文字恢复为「录入」
- 打开对话框时自动计算序列号（基于当前项目最大序列号 +1）
- 切换项目时重新计算序列号
- 连续模式下序列号自动递增（无论是否打印）
- 打印使用全局配置的打印机

### 决策 4：卡片列表操作布局重构

**当前布局**：
```
| 序号 | 呼号 | 数量 | 状态 | 时间 | 录入时间 | 操作 |
|      |      |      |      |      |          | [查看] [更多▼] |
                                                     ├─ 分发
                                                     ├─ 退回
                                                     ├─ 打印面单
                                                     └─ 删除
```

**变更后布局**：
```
| 序号 | 呼号          | 数量 | 状态 | 时间 | 录入时间 | 操作 |
|      | BG7XXX [🔍][📋] |      |      |      |          | [分发] [更多▼] |
                                                              ├─ 打印标签
                                                              ├─ 打印顺丰面单
                                                              ├─ 退回
                                                              └─ 删除
```

**按钮详情**：
- `[🔍]`：查看详情（圆形小按钮，Search 图标）
- `[📋]`：复制呼号（圆形小按钮，CopyDocument 图标）
- `[分发]`：分发卡片（原来在更多菜单中，现在提升为主按钮）
- 更多菜单：打印标签、打印顺丰面单、退回、删除

### 决策 5：菜单结构重构

**背景**：当前菜单结构中「打印」「打印配置」「打印模板」三个独立菜单，层级混乱。

**变更方案**：

```
【变更前菜单】
├── 卡片管理
├── 顺丰订单
├── 数据配置 ▼
│   └── ...
├── ─────────
├── 打印              ← 删除
├── 打印配置          ← 改为二级菜单
├── 打印模板          ← 移入打印配置，改名
├── ─────────
├── 日志
└── 关于

【变更后菜单】
├── 卡片管理
├── 顺丰订单
├── 数据配置 ▼
│   └── ...
├── ─────────
├── 打印配置 ▼
│   ├── 打印机配置    ← 原打印配置功能
│   └── 标签模板配置  ← 原打印模板
├── ─────────
├── 日志
└── 关于
```

**菜单索引映射**：
| 变更前 | 变更后 |
|--------|--------|
| `print` | 删除 |
| `config` | `print-config-printer` |
| `template` | `print-config-template` |

### 决策 6：配置从多配置改为单配置

**背景**：当前支持多个 Profile 配置，但实际使用中用户通常只需要一套打印机配置。

**变更方案**：

1. **数据结构简化**：
   - 移除 Profile 列表管理
   - 改为单一配置文件 `config/printer.toml`

2. **配置内容**：
   ```toml
   # config/printer.toml
   [printer]
   name = "Deli DL-888C"

   [platform]
   os = "macOS"
   arch = "arm64"
   ```

3. **UI 变更**：
   - 移除配置列表、新建、删除功能
   - 改为直接编辑单一配置
   - 打印机选择下拉框 + 保存按钮

4. **迁移策略**：
   - 如果存在多个配置，使用默认配置或第一个配置
   - 旧配置文件保留但不再使用

## 组件变更清单

### 需要修改的组件

| 组件 | 变更内容 |
|------|----------|
| `App.vue` | 菜单结构重构：移除打印菜单，打印配置改为二级菜单 |
| `CardInputDialog.vue` | 添加打印设置区域（复选框、序列号、跳过4、打印机） |
| `CardList.vue` | 调整操作列布局，呼号列添加图标按钮 |
| `CardManagementView.vue` | 集成打印逻辑，处理录入并打印事件 |
| `ConfigView.vue` | 重构为单配置编辑页面（打印机配置） |
| `TemplateView.vue` | 页面标题改为「标签模板配置」 |

### 需要删除的组件

| 组件 | 说明 |
|------|------|
| `PrintView.vue` | 独立打印页面，功能已合并到卡片管理 |

### 需要修改的后端

| 模块 | 变更内容 |
|------|----------|
| 配置管理 | 从多 Profile 改为单配置 |
| `Profile` 结构体 | 移除 `task_name` 字段，简化为单配置结构 |
| `get_profiles` 命令 | 改为 `get_printer_config` 返回单配置 |
| `create_profile` 命令 | 移除，改为 `save_printer_config` |
| `update_profile` 命令 | 移除，合并到 `save_printer_config` |
| `delete_profile` 命令 | 移除 |
| 打印模板 | `task_name` 重命名为 `project_name` |

## 状态管理

### 录入对话框状态

```typescript
interface CardInputState {
  // 基本信息
  projectId: string
  callsign: string
  qty: number

  // 打印设置
  printEnabled: boolean      // 是否打印标签（默认 true）
  serial: number             // 序列号（1-999）
  skip4Enabled: boolean      // 跳过4（默认 true）
  printerName: string        // 选中的打印机

  // 模式
  continuousMode: boolean    // 连续录入
}
```

### 打印机列表获取

打印机列表通过 `get_printers` Tauri 命令获取，需要在对话框打开时加载。

## 错误处理

1. **打印机未选择**：打印标签勾选时必须选择打印机，否则提交按钮禁用
2. **打印失败**：录入成功后打印失败，显示错误提示但不回滚录入
3. **序列号溢出**：超过 999 自动重置为 1

## 向后兼容性

1. **配置文件迁移**：
   - 旧的多配置文件保留但不再使用
   - 首次启动时自动迁移默认配置或第一个配置到新的单配置格式
   - task_name 字段忽略
2. **打印模板**：
   - task_name 重命名为 project_name
   - 旧模板中的 task_name 需要手动更新或提供自动迁移
3. **打印页面**：独立打印页面移除，所有打印操作在卡片管理中进行
4. **API 变更**：
   - `get_profiles` → `get_printer_config`
   - `create_profile` / `update_profile` → `save_printer_config`
   - `print_qsl` 命令接口 task_name 参数改为 project_name
