# card-entry-with-print 规范增量

## 修改需求

### 修改需求：卡片数据模型

系统必须扩展卡片数据模型，增加序列号字段。

#### 场景：卡片表增加序列号字段

- **当** 系统初始化或迁移数据库
- **那么** `cards` 表必须包含以下新字段：
  - `serial`: TEXT（序列号，三位数格式如 "001"）
- **并且** 该字段可为空（兼容历史数据）

---

### 修改需求：卡片录入功能

系统必须提供卡片录入功能，支持单条录入、连续录入模式，以及录入时同时打印标签。

#### 场景：录入弹窗表单结构

- **当** 用户打开卡片录入弹窗
- **那么** 系统必须显示以下表单结构（按顺序）：
  1. **卡片信息区域**：
     - 转卡项目选择（必填）
     - 呼号输入框（必填）
     - 数量输入框（必填）
     - 序列号输入框（1-999）+ 预览（三位数格式）+ 重置按钮
     - 跳过包含数字 4 的序列号复选框（默认勾选）
  2. **打印设置区域**（可折叠）：
     - 打印标签复选框（默认勾选）
  3. **模式选项**：
     - 连续录入模式复选框

#### 场景：序列号自动计算

- **当** 用户打开卡片录入弹窗
- **并且** 已选中转卡项目（或有预选项目）
- **那么** 系统必须查询该项目下所有卡片的序列号
- **并且** 找到最大序列号并 +1 作为新的默认值
- **并且** 如果勾选「跳过4」，新序列号必须跳过包含数字 4 的数字
- **并且** 如果该项目下没有卡片，序列号默认为 1

#### 场景：切换转卡项目时重新计算序列号

- **当** 用户在录入弹窗中切换转卡项目
- **那么** 系统必须重新查询新项目下的最大序列号
- **并且** 按照上述规则设置新的序列号默认值

#### 场景：单条卡片录入（仅录入）

- **当** 用户打开卡片录入弹窗
- **并且** 取消勾选「打印标签」复选框
- **并且** 用户填写并提交表单
- **那么** 系统必须验证输入并创建卡片记录（包含序列号）
- **并且** 提交成功后关闭弹窗
- **并且** 不执行打印操作

#### 场景：单条卡片录入并打印（默认行为）

- **当** 用户打开卡片录入弹窗
- **那么** 「打印标签」复选框必须默认勾选
- **当** 用户填写表单并提交
- **那么** 系统必须先创建卡片记录（包含序列号）
- **并且** 使用卡片所属项目名称作为 project_name、卡片序列号执行打印
- **并且** 打印成功或失败均显示提示
- **并且** 打印失败不影响卡片录入成功

#### 场景：录入弹窗按钮文字切换

- **当** 用户勾选「打印标签」复选框
- **那么** 提交按钮文字必须变为「录入并打印 (Enter)」
- **当** 用户取消勾选「打印标签」复选框
- **那么** 提交按钮文字必须变为「录入 (Enter)」

#### 场景：连续录入模式下的序列号递增

- **当** 用户勾选「连续录入」选项
- **并且** 用户提交表单
- **那么** 系统必须保存卡片记录
- **并且** 如果勾选打印，执行打印操作
- **并且** 序列号必须自动递增
- **并且** 如果勾选「跳过4」，递增后的序列号必须跳过包含数字 4 的数字
- **并且** 序列号超过 999 时必须重置为 1
- **并且** 弹窗保持打开，焦点移到呼号输入框

---

### 修改需求：卡片列表展示

系统必须在卡片列表中展示序列号字段。

#### 场景：卡片列表显示序列号

- **当** 用户查看卡片列表
- **那么** 表格必须包含「序列号」列
- **并且** 序列号显示为三位数格式（如 "001"）
- **并且** 无序列号的历史卡片显示为 "-"

---

## 新增需求

### 需求：序列号跳过 4 功能

录入卡片时的序列号必须支持跳过包含数字 4 的序列号。

#### 场景：序列号向上跳过 4

- **当** 用户输入或自动递增的序列号包含数字 4（如 4, 14, 40-49, 140-149）
- **并且** 勾选「跳过包含数字 4 的序列号」
- **那么** 系统必须自动将序列号调整为下一个不包含 4 的数字
- **并且** 显示调整后的序列号

#### 场景：序列号向下跳过 4

- **当** 用户减小序列号输入值
- **并且** 新值包含数字 4
- **并且** 勾选「跳过包含数字 4 的序列号」
- **那么** 系统必须自动将序列号调整为上一个不包含 4 的数字

#### 场景：序列号重置

- **当** 用户点击「重置」按钮
- **那么** 序列号必须重置为 1
- **并且** 显示成功提示

---

### 需求：卡片列表操作布局

卡片列表必须提供优化的操作布局，常用功能更易触达。

#### 场景：呼号列快捷操作

- **当** 用户查看卡片列表
- **那么** 呼号文字后必须显示两个圆形小图标按钮：
  - 查看按钮（Search 图标，点击打开详情抽屉）
  - 复制按钮（CopyDocument 图标，点击复制呼号到剪贴板）
- **并且** 按钮样式为 `<el-button :icon="Search" size="small" circle />`
- **并且** 按钮间距适当，不影响呼号显示

#### 场景：复制呼号到剪贴板

- **当** 用户点击呼号后的复制按钮
- **那么** 系统必须将呼号文本复制到系统剪贴板
- **并且** 显示成功提示「已复制呼号: XXXXX」

#### 场景：操作列布局调整

- **当** 用户查看卡片列表操作列
- **那么** 必须显示以下按钮：
  - 「分发」按钮（主操作，link 样式）
  - 「更多」下拉菜单
- **并且** 「更多」菜单必须包含以下选项（按顺序）：
  - 打印标签
  - 打印顺丰面单
  - 退回
  - 删除（带分隔线）

#### 场景：从列表打印标签

- **当** 用户在卡片列表中点击「更多」→「打印标签」
- **那么** 系统直接使用卡片的序列号和所属项目名称执行打印
- **并且** 打印成功/失败显示提示

---

### 需求：菜单结构优化

系统必须提供优化的菜单结构，打印相关配置统一在二级菜单中。

#### 场景：打印配置二级菜单

- **当** 用户查看左侧导航菜单
- **那么** 「打印配置」必须显示为可展开的二级菜单
- **并且** 包含以下子菜单项：
  - 打印机配置
  - 标签模板配置

#### 场景：独立打印菜单移除

- **当** 用户查看左侧导航菜单
- **那么** 必须不显示独立的「打印」菜单项
- **并且** 必须不显示独立的「打印模板」菜单项

---

### 需求：单配置模式

系统必须使用单配置模式管理打印机配置，取代原有的多配置模式。

#### 场景：打印机配置页面

- **当** 用户进入「打印机配置」页面
- **那么** 系统必须显示单一配置编辑界面
- **并且** 包含打印机选择下拉框
- **并且** 包含保存按钮
- **并且** 不显示配置列表、新建、删除功能

#### 场景：保存打印机配置

- **当** 用户选择打印机并点击保存
- **那么** 系统必须保存配置到 `config/printer.toml`
- **并且** 显示保存成功提示

---

## 移除需求

### 移除需求：打印配置中的任务名称

~~系统必须支持在打印配置中设置任务名称。~~

> 任务名称（task_name）已重命名为项目名称（project_name），不再存储在打印配置中，改为使用卡片所属项目名称。此需求从 `configuration-management` 规范中移除。

### 移除需求：独立打印页面

~~系统必须提供独立的 QSL 卡片打印页面。~~

> 独立打印页面（PrintView.vue）已移除。所有打印功能合并到卡片管理中：
> - 录入卡片时可选择同时打印标签
> - 卡片列表中可对已录入的卡片打印标签
>
> 用户不再需要在「打印」和「卡片管理」之间切换。

### 移除需求：多配置管理

~~系统必须支持多个打印配置（Profile）的管理。~~

> 多配置模式已简化为单配置模式。系统只保存一套打印机配置，无需管理多个配置。
