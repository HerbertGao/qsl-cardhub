## 上下文

当前系统的打印链路分为 QSL 标签、地址标签、顺丰面单三条路径，历史上它们在 TSPL 头参数（尤其 GAP 与 DIRECTION）上存在实现差异。线上反馈显示仅顺丰面单在 HPRT N31D 上异常，说明“链路参数不一致”是核心风险点。为避免后续再次出现“某一路径异常、另一路径正常”的问题，本次改为统一的全局 TSPL 参数配置模型。

## 目标 / 非目标

**目标：**
- 让顺丰面单打印在主流热敏标签打印机（包含 HPRT N31D）上达到与普通标签一致的稳定性。
- 在打印机配置界面与配置文件中提供全局 TSPL 参数（GAP、DIRECTION）配置能力。
- 让 QSL 标签、地址标签、顺丰面单三条链路统一接入同一套 GAP/DIRECTION 参数。
- 保留现有两步打印交互（先预览再打印）与 API 接口稳定性。

**非目标：**
- 不重构整套打印架构。
- 不改造顺丰 API 调用协议或订单业务流程。
- 不引入与本问题无关的 UI 大改。

## 决策

1. 统一关键 TSPL 头参数策略
- 决策：三条打印链路统一由全局配置提供 GAP 与 DIRECTION，避免链路内各自硬编码。
- 原因：问题虽然在顺丰触发，但根因是参数分叉；统一治理优于按链路修补。
- 备选：仅针对 N31D 做机型分支；放弃，因维护成本高且不可扩展。

2. 全局 TSPL 参数配置化
- 决策：在单配置模型（`printer.toml`）中新增全局 `tspl` 配置段，至少包含 `gap_mm`、`gap_offset_mm`、`direction`。
- 原因：GAP/DIRECTION 与设备/介质兼容性强相关，应由用户可调且统一生效。
- 备选：仅在顺丰模块单独新增参数；放弃，会继续保留跨链路漂移风险。

3. 增强可观测性
- 决策：在所有打印链路记录关键 TSPL 生效参数与作业上下文（不记录敏感信息）。
- 原因：后续问题定位不应局限于顺丰链路，统一日志口径可显著降低排障成本。
- 备选：仅依赖用户口头反馈；放弃，定位效率过低。

## 风险 / 权衡

- [风险] 参数可配置后，错误配置可能导致新的打印异常
  - 缓解措施：提供安全默认值；新增参数校验与回退逻辑；在 UI 提示推荐值。
- [风险] 参数统一后影响少数已适配设备
  - 缓解措施：保留可配置覆盖，先以默认策略灰度验证。
- [风险] 测试环境与客户设备不一致
  - 缓解措施：增加日志与回归用例，支持快速 A/B 对比。

## Migration Plan

1. 增加全局 TSPL 参数配置结构与读取逻辑，保留向后兼容默认值。
2. 在打印机配置页面新增 GAP/DIRECTION 设置项，默认值为 `2mm,0mm` 和 `1,0`。
3. 调整 QSL/地址/顺丰三条链路 TSPL 参数来源，统一接入全局配置。
3. 补充日志与单元测试/集成测试。
4. 在测试环境回归普通标签、地址标签、顺丰面单三条路径。
5. 若出现兼容问题，使用配置回退到旧参数组合并记录样本。

## Open Questions

- 是否为特定机型（如 N31D）内置推荐预设档位（标准/兼容）？
