# v0.3 版本完成总结

**版本**：v0.3
**完成日期**：2026-01-20
**主题**：模板配置系统实施

---

## 概述

v0.3 实现了完整的模板配置系统，将硬编码的布局参数配置化，使用户能够通过 TOML 文件自定义 QSL 卡片的打印布局。

## 主要功能

###  1. 模板配置数据模型

**文件**：`src/config/template.rs` (约 300 行)

**核心结构**：
- `TemplateConfig` - 完整的模板配置结构
- `TemplateMetadata` - 模板元信息（名称、版本、描述）
- `PaperConfig` - 纸张配置（尺寸、间隙、方向）
- `TitleConfig` - 标题配置（固定文本，可启用/禁用）
- `SubtitleConfig` - 副标题配置（动态文本，可启用/禁用）
- `CallsignConfig` - 呼号配置（位置、字体、缩放、对齐）
- `BarcodeConfig` - 条形码配置（位置、类型、高度、宽度）
- `SerialConfig` - 序列号配置（位置、字体、前缀、格式）
- `QuantityConfig` - 数量配置（位置、字体、前缀）

**关键方法**：
```rust
impl TemplateConfig {
    pub fn load_from_file(path: PathBuf) -> Result<Self>
    pub fn default_qsl_v1() -> Self
    pub fn save_to_file(&self, path: PathBuf) -> Result<()>
}
```

###  2. 模板管理器

**文件**：`src/config/template_manager.rs` (约 180 行)

**功能**：
- 模板目录管理
- 模板文件加载和缓存
- 默认模板自动创建
- 模板 CRUD 操作

**核心 API**：
```rust
impl TemplateManager {
    pub fn new(template_dir: PathBuf) -> Result<Self>
    pub fn list_templates(&self) -> Vec<String>
    pub fn get_template(&self, name: &str) -> Result<&TemplateConfig>
    pub fn get_default_template(&self) -> Result<&TemplateConfig>
    pub fn add_template(&mut self, template: TemplateConfig) -> Result<()>
    pub fn remove_template(&mut self, name: &str) -> Result<()>
    pub fn reload(&mut self) -> Result<()>
}
```

### 3. TSPL 生成器扩展

**文件**：`src/printer/tspl.rs` (新增约 100 行)

**新功能**：
- 基于模板配置生成 TSPL 指令
- 支持标题和副标题元数据
- 动态序列号格式化

**新方法**：
```rust
impl TSPLGenerator {
    pub fn generate_from_template(
        &self,
        template: &TemplateConfig,
        callsign: &str,
        serial: u32,
        qty: u32,
        task_name: Option<&str>,
    ) -> String
}
```

**TSPL 元数据扩展**：
- `; TITLE: <标题文本>` - 主标题
- `; SUBTITLE: <副标题文本>` - 副标题/任务名称
- `; TASK_NAME: <任务名称>` - 兼容旧格式

### 4. PDF 后端元数据解析

**文件**：`src/printer/backend/pdf.rs` (修改约 20 行)

**更新**：
- 解析 `_META_TITLE` 元数据
- 解析 `_META_SUBTITLE` 元数据
- 保持兼容 `_META_TASK_NAME` 旧格式

**解析逻辑**：
```rust
match cmd.as_str() {
    "_META_TITLE" => data.title = params[0].clone(),
    "_META_SUBTITLE" => data.subtitle = params[0].clone(),
    "_META_TASK_NAME" => data.subtitle = params[0].clone(), // 兼容模式
    _ => {}
}
```

### 5. 默认模板文件

**文件**：`config/templates/qsl-card-v1.toml`

**内容**：
- 完整的 QSL Card v1 模板配置
- 包含所有元素的配置参数
- 中文标题和可选副标题
- TOML 格式，易于编辑

**示例**：
```toml
[metadata]
name = "QSL Card v1"
version = "1.0"
description = "标准 QSL 卡片模板，76mm x 130mm，包含中文标题"

[paper]
width_mm = 76
height_mm = 130
gap_mm = 2
direction = 0

[title]
text = "中国无线电协会业余分会-2区卡片局"
enabled = true

[subtitle]
enabled = true

[callsign]
x = 304
y = 80
font = "5"
rotation = 0
x_scale = 3
y_scale = 3
align = "center"

[barcode]
x = 200
y = 300
type = "128"
height = 120
human_readable = 1
rotation = 0
narrow_bar = 3
wide_bar = 3

[serial]
x = 50
y = 520
font = "5"
rotation = 0
x_scale = 2
y_scale = 2
prefix = "SN: "
format = "{:03}"

[quantity]
x = 50
y = 720
font = "5"
rotation = 0
x_scale = 2
y_scale = 2
prefix = "QTY: "
```

### 6. 集成测试

**文件**：`tests/integration/template_config.rs` (约 200 行)

**测试覆盖**：
- ✅ 模板配置加载测试
- ✅ 模板序列化/反序列化测试
- ✅ 模板管理器测试
- ✅ 基于模板的 TSPL 生成测试
- ✅ 基于模板的 PDF 渲染测试
- ✅ 模板文件加载测试

**测试结果**：所有 6 个测试全部通过 ✅

## 技术亮点

### 1. 配置与渲染分离

- **TSPL 配置**：用于真实打印机的固定布局参数
- **PDF 渲染**：保留 v0.2 的动态优化布局（自动居中、字号调整等）
- **元数据传递**：通过 TSPL 注释传递标题、副标题等信息

### 2. 向后兼容

- 保持兼容原有的 `generate_qsl_card()` 方法
- 支持旧的 `TASK_NAME` 元数据格式
- 新增 `generate_from_template()` 方法，不影响现有代码

### 3. 灵活的配置格式

- 使用 TOML 格式，易于人工编辑
- 支持注释说明
- 结构化配置，便于验证和扩展

### 4. 完整的模板管理

- 自动创建默认模板
- 模板文件缓存
- CRUD 操作支持
- 目录管理

## 代码统计

| 项目 | 新增 | 修改 | 总计 |
|------|------|------|------|
| Rust 代码 | ~680 行 | ~40 行 | ~720 行 |
| 配置文件 | 1 个 | 1 个 | 2 个 |
| 测试代码 | ~200 行 | 0 行 | ~200 行 |
| 新增模块 | 2 个 | - | - |

**新增文件**：
- `src/config/template.rs`
- `src/config/template_manager.rs`
- `tests/integration/template_config.rs`

**修改文件**：
- `src/config/mod.rs`
- `src/printer/tspl.rs`
- `src/printer/backend/pdf.rs`
- `config/templates/qsl-card-v1.toml`

## 使用示例

### 加载和使用模板

```rust
use QSL_CardHub::config::TemplateManager;
use QSL_CardHub::printer::tspl::TSPLGenerator;

// 创建模板管理器
let manager = TemplateManager::new(PathBuf::from("config/templates"))?;

// 获取默认模板
let template = manager.get_default_template()?;

// 使用模板生成 TSPL
let generator = TSPLGenerator::new();
let tspl = generator.generate_from_template(
    template,
    "BG7XXX",
    123,
    50,
    Some("春季活动")
);

// TSPL 包含元数据：
// ; TITLE: 中国无线电协会业余分会-2区卡片局
// ; SUBTITLE: 春季活动
// SIZE 76 mm, 130 mm
// ...
```

### 创建自定义模板

```rust
// 加载默认模板作为基础
let mut custom_template = TemplateConfig::default_qsl_v1();

// 修改配置
custom_template.metadata.name = "自定义模板".to_string();
custom_template.title.text = "我的自定义标题".to_string();
custom_template.callsign.x = 300;

// 保存到文件
custom_template.save_to_file(PathBuf::from("config/templates/custom.toml"))?;

// 添加到管理器
manager.add_template(custom_template)?;
```

## 后续工作

### v0.4 计划

1. **Profile 集成模板**
   - 将 Template 字段从简单字符串改为 TemplateConfig 引用
   - 每个 Profile 可以选择使用的模板
   - UI 支持模板选择

2. **模板 Tauri Commands**
   - `list_templates()` - 列出所有模板
   - `get_template(name)` - 获取模板详情
   - `create_template(config)` - 创建新模板
   - `update_template(name, config)` - 更新模板
   - `delete_template(name)` - 删除模板

3. **前端模板管理 UI**
   - 模板列表页面
   - 模板编辑器
   - 实时预览功能

4. **PrinterManager 集成**
   - 修改 `print_qsl()` 方法支持模板参数
   - 默认使用 Profile 关联的模板

### 可选增强（v1.0+）

- **模板验证**：验证模板配置的有效性（位置是否越界、字体是否存在等）
- **模板导入导出**：支持模板的打包和分享
- **模板预设库**：提供多种预设模板供用户选择
- **可视化编辑器**：拖拽式模板编辑界面
- **PDF 渲染配置**：为 PDF 后端添加独立的渲染参数配置

## 已知限制

1. **PDF 渲染固定**：当前 PDF 后端使用固定的动态布局，不读取模板的位置参数
2. **模板格式单一**：当前只支持 QSL Card v1 格式，未来可扩展支持其他卡片尺寸
3. **缺少 UI 集成**：模板管理当前只有后端 API，缺少前端管理界面
4. **验证不足**：缺少对模板配置有效性的完整验证

## 总结

v0.3 成功实现了模板配置系统的核心功能，为 qsl-cardhub 的可定制性奠定了基础。通过 TOML 配置文件，用户可以灵活调整打印布局，满足不同的打印需求。

**关键成果**：
- ✅ 完整的模板数据模型
- ✅ 模板文件加载和管理
- ✅ TSPL 生成器支持模板
- ✅ PDF 后端解析模板元数据
- ✅ 6 个集成测试全部通过
- ✅ 默认模板文件完整可用

**下一步**：将模板系统集成到 Profile 和前端 UI，实现完整的模板管理功能（v0.4）。
