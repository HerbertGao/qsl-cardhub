# 打印模板配置规范

## 目的

本规范定义了 qsl-cardhub Rust 版本的打印模板配置化需求。将原本硬编码在代码中的 TSPL 布局参数（坐标、字号、尺寸等）提取到 TOML 配置文件中，允许用户手动调整打印布局，适应不同打印机和纸张规格。

## 新增需求

### 需求:模板配置文件

系统必须将打印模板参数存储在独立的 TOML 配置文件中。

#### 场景:模板文件位置

- **当** 系统初始化时
- **那么** 应在配置目录创建 `templates/` 子目录
- **并且** 目录结构应为：
  ```
  ~/.config/qsl-cardhub/
  ├── config.toml
  ├── profiles/
  │   └── ...
  └── templates/
      ├── qsl-card-v1.toml
      └── calibration-page-v1.toml
  ```

#### 场景:默认模板创建

- **当** 系统首次运行或模板文件不存在
- **那么** 应自动创建默认模板文件
- **并且** 应使用内置的默认参数
- **并且** 应添加详细的注释说明各参数含义

#### 场景:模板文件结构

- **当** 系统创建 QSL 卡片模板
- **那么** 应包含以下配置：
  ```toml
  # QSL 卡片打印模板 v1
  # 适用于 76mm × 130mm 纸张，203 DPI 打印机

  [paper]
  width_mm = 76
  height_mm = 130
  gap_mm = 2
  direction = 0  # 0=正常, 90=旋转90度, 180=旋转180度, 270=旋转270度

  [callsign]
  x = 304  # X 坐标（dots）
  y = 80   # Y 坐标（dots）
  font = "5"  # TSPL 字体编号
  rotation = 0  # 旋转角度
  x_scale = 3  # X 方向放大倍数
  y_scale = 3  # Y 方向放大倍数
  align = "center"  # 对齐方式: left, center, right

  [barcode]
  x = 200
  y = 300
  type = "128"  # 条形码类型: 128, 39, EAN13, etc.
  height = 120  # 条形码高度（dots）
  human_readable = 1  # 是否显示人眼可读文本: 0=否, 1=是
  rotation = 0
  narrow_bar = 3  # 窄条宽度
  wide_bar = 3    # 宽条宽度

  [serial]
  x = 50
  y = 520
  font = "5"
  rotation = 0
  x_scale = 2
  y_scale = 2
  prefix = "SN: "  # 前缀文本
  format = "{:03}"  # 格式化字符串（Rust 格式）

  [quantity]
  x = 50
  y = 720
  font = "5"
  rotation = 0
  x_scale = 2
  y_scale = 2
  prefix = "QTY: "
  ```

### 需求:模板加载和验证

系统必须在运行时加载和验证模板配置。

#### 场景:模板加载

- **当** PrinterManager 初始化时
- **那么** 应加载默认模板（qsl-card-v1.toml）
- **并且** 应使用 `toml::from_str()` 解析为 `TemplateConfig` struct
- **并且** 如果加载失败，应回退到内置默认值
- **并且** 应记录警告日志

#### 场景:模板验证

- **当** 加载模板配置时
- **那么** 应验证所有必填字段存在
- **并且** 应验证坐标在纸张范围内（0 - width_dots, 0 - height_dots）
- **并且** 应验证字号、倍数等参数在有效范围内
- **并且** 如果验证失败，应返回详细错误信息

#### 场景:模板热重载

- **当** 用户修改模板文件后
- **那么** 可以通过重启应用使配置生效
- **并且** 或通过 Tauri Command 提供"重新加载模板"功能
- **并且** 重新加载后立即生效

### 需求:TSPL 生成器使用模板

系统必须使用模板配置生成 TSPL 指令。

#### 场景:基于模板生成 TSPL

- **当** 系统调用 `TSPLGenerator::generate_qsl_card()`
- **那么** 应从 TemplateConfig 读取所有布局参数
- **并且** 应使用模板中的坐标、字号、倍数生成 TEXT 命令
- **并且** 应使用模板中的参数生成 BARCODE 命令
- **并且** 应替换变量（如 `{callsign}`, `{:03}` 格式化序列号）

#### 场景:坐标计算

- **当** 模板中使用相对定位（如 "center"）
- **那么** 系统应根据纸张尺寸和文本宽度计算实际坐标
- **并且** 应使用 DPI 将 mm 转换为 dots
- **并且** 计算结果应准确

#### 场景:格式化字符串

- **当** 模板中定义了格式化字符串（如 `format = "{:03}"`）
- **那么** 系统应使用 Rust 的 `format!()` 宏应用格式化
- **并且** 支持常见的格式化选项（如 {:03}, {:>5}, {:.2}）

### 需求:模板管理 UI

系统必须提供模板管理功能（v0.5 或 v2.0）。

#### 场景:模板列表查看

- **当** 用户访问模板管理页面
- **那么** 应显示所有可用的模板文件
- **并且** 显示模板名称、版本、适用纸张尺寸
- **并且** 标识当前正在使用的模板

#### 场景:模板编辑（可选）

- **当** 用户点击"编辑模板"按钮
- **那么** 可以在 UI 中直接编辑模板参数
- **并且** 提供可视化预览（显示元素位置）
- **并且** 保存后生成新的 TOML 文件

#### 场景:模板导入导出

- **当** 用户导出模板
- **那么** 应导出 .toml 文件
- **当** 用户导入模板
- **那么** 应验证文件格式并保存到 templates/ 目录

### 需求:模板版本管理

系统必须支持多版本模板共存。

#### 场景:模板版本号

- **当** 创建新模板
- **那么** 文件名应包含版本号（如 default.toml）
- **并且** 模板内部应有 `version = "2.0"` 字段

#### 场景:模板选择

- **当** 用户在配置中选择模板
- **那么** Profile 配置应包含 `template_file` 字段
- **并且** 可以为不同配置选择不同模板
- **并且** 如果模板文件不存在，应回退到默认模板

### 需求:模板文档

系统必须提供模板配置文档。

#### 场景:参数说明

- **当** 用户查看模板文件
- **那么** 应在 TOML 注释中包含详细说明：
  - 每个参数的含义
  - 有效值范围
  - 单位（dots, mm, etc.）
  - 示例值

#### 场景:坐标参考

- **当** 用户调整坐标时
- **那么** 应提供坐标系统说明：
  - 原点位置（左上角 0,0）
  - DPI 换算（1mm ≈ 8 dots at 203dpi）
  - 纸张边界（76mm × 130mm = 608 × 1040 dots）

#### 场景:模板示例

- **当** 用户需要创建自定义模板
- **那么** 应提供完整的模板示例文件
- **并且** 说明如何复制和修改
- **并且** 提供常见布局的预设模板

## 实施优先级

**v0.1（当前版本）：**
- 硬编码 TSPL 布局（与 Python 版一致）
- 不实现模板配置化

**v0.5：**
- 实现模板配置文件加载
- 基于模板生成 TSPL 指令
- 支持手动编辑模板文件

**v2.0：**
- 实现模板管理 UI
- 可视化模板编辑器
- 模板导入导出功能
