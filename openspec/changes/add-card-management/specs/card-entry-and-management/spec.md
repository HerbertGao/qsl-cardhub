# 规范：卡片录入和管理 (Phase 2)

## 新增需求

### 需求：卡片数据模型

系统必须定义卡片数据模型，支持卡片录入、列表展示和状态管理。

#### 场景：定义卡片数据表结构

- **当** 系统初始化数据库
- **那么** 必须创建 `cards` 表
- **并且** 表结构必须包含以下字段：
  - `id`: TEXT PRIMARY KEY（UUID 格式）
  - `project_id`: TEXT NOT NULL（外键关联 projects 表）
  - `creator_id`: TEXT（预留字段，Phase 3 使用）
  - `callsign`: TEXT NOT NULL（呼号）
  - `qty`: INTEGER NOT NULL CHECK(qty > 0)（数量）
  - `status`: TEXT NOT NULL CHECK(status IN ('pending', 'distributed', 'returned'))
  - `metadata`: TEXT（JSON 字符串，存储分发/退卡信息）
  - `created_at`: TEXT NOT NULL（东八区时间戳）
  - `updated_at`: TEXT NOT NULL（东八区时间戳）
- **并且** 必须创建索引：
  - `idx_cards_project` ON cards(project_id)
  - `idx_cards_callsign` ON cards(callsign)
  - `idx_cards_status` ON cards(status)

#### 场景：级联删除卡片

- **当** 删除项目
- **那么** 系统必须级联删除该项目下的所有卡片
- **并且** 删除操作必须是原子性的

#### 场景：序列化卡片元数据

- **当** 卡片被分发或退卡
- **那么** 系统必须将分发/退卡信息序列化为 JSON
- **并且** JSON 必须保存在 `metadata` 字段
- **并且** JSON 格式必须包含：
  - `distribution`：分发信息（方式、地址、备注、时间）
  - `return`：退卡信息（原因、备注、时间）

---

### 需求：卡片录入功能

系统必须提供卡片录入功能，支持单条录入和连续录入模式。

#### 场景：单条卡片录入

- **当** 用户打开卡片录入弹窗
- **那么** 系统必须显示表单：
  - 项目选择下拉框（必填）
  - 呼号输入框（必填）
  - 数量输入框（必填）
- **并且** 用户填写并提交表单
- **那么** 系统必须验证输入：
  - 呼号长度 3-10 字符
  - 呼号仅包含字母、数字、斜杠
  - 数量范围 1-9999
- **并且** 系统必须将呼号自动转为大写
- **并且** 系统必须创建卡片记录：
  - `status` 初始值为 `pending`
  - `created_at` 和 `updated_at` 为当前东八区时间
- **并且** 提交成功后关闭弹窗

#### 场景：连续录入模式

- **当** 用户勾选"连续录入"选项
- **并且** 用户提交表单
- **那么** 系统必须保存卡片记录
- **并且** 系统必须清空呼号和数量输入框
- **并且** 系统必须保持项目选择不变
- **并且** 弹窗必须保持打开状态
- **并且** 焦点必须自动移到呼号输入框

#### 场景：呼号输入验证错误

- **当** 用户输入的呼号格式不正确（如包含特殊字符、长度不足）
- **那么** 系统必须显示错误提示
- **并且** 不得保存记录
- **并且** 焦点必须保持在呼号输入框

#### 场景：快捷键支持

- **当** 用户在录入弹窗中按下 Enter 键
- **那么** 系统必须提交表单
- **当** 用户按下 Esc 键
- **那么** 系统必须关闭弹窗

---

### 需求：卡片列表展示

系统必须提供卡片列表，支持查询、筛选和分页功能。

#### 场景：按项目筛选卡片

- **当** 用户在左侧项目列表中选择项目
- **那么** 系统必须查询该项目下的所有卡片
- **并且** 必须按创建时间降序排列
- **并且** 必须在右侧列表中显示卡片

#### 场景：按呼号搜索

- **当** 用户在搜索框中输入呼号关键词
- **那么** 系统必须进行模糊匹配查询（LIKE '%keyword%'）
- **并且** 搜索必须防抖处理（延迟 300ms）
- **并且** 显示匹配的卡片列表

#### 场景：按状态筛选

- **当** 用户选择状态筛选条件（全部、已录入、已分发、已退卡）
- **那么** 系统必须查询对应状态的卡片
- **并且** 状态映射关系为：
  - "已录入" → `pending`
  - "已分发" → `distributed`
  - "已退卡" → `returned`
  - "全部" → 不筛选状态

#### 场景：分页显示

- **当** 卡片数量超过 20 条
- **那么** 系统必须启用分页
- **并且** 每页显示 20 条记录
- **并且** 必须显示分页控件（首页、上一页、下一页、尾页）

#### 场景：序号计算

- **当** 系统显示卡片列表
- **那么** 序号必须从 1 开始连续编号
- **并且** 序号必须考虑分页偏移量
- **并且** 公式为：`(当前页码 - 1) * 每页条数 + 行索引 + 1`

---

### 需求：卡片分发功能

系统必须提供卡片分发功能，记录分发方式、地址和备注。

#### 场景：分发已录入状态的卡片

- **当** 用户点击"分发"按钮
- **并且** 卡片状态为 `pending`
- **那么** 系统必须显示分发弹窗
- **并且** 弹窗必须包含：
  - 处理方式（单选）：直接分发、邮寄、自取
  - 分发地址（文本输入框）
  - 备注（多行文本输入框）
- **并且** 用户填写并提交
- **那么** 系统必须验证：
  - 如果处理方式为"邮寄"，地址必填
- **并且** 系统必须更新卡片记录：
  - `status` 更新为 `distributed`
  - `metadata` 添加 `distribution` 对象：
    ```json
    {
      "distribution": {
        "method": "邮寄",
        "address": "用户输入的地址",
        "remarks": "用户输入的备注",
        "distributed_at": "2026-01-21T15:30:00+08:00"
      }
    }
    ```
  - `updated_at` 更新为当前时间

#### 场景：非已录入状态的卡片不可分发

- **当** 卡片状态为 `distributed` 或 `returned`
- **那么** 系统必须隐藏或禁用"分发"按钮

#### 场景：邮寄方式地址必填验证

- **当** 用户选择"邮寄"方式
- **并且** 地址输入框为空
- **并且** 用户提交分发表单
- **那么** 系统必须显示错误提示："邮寄方式地址不能为空"
- **并且** 不得更新卡片状态

---

### 需求：卡片退卡功能

系统必须提供卡片退卡功能，记录退卡原因和备注。

#### 场景：退卡已录入或已分发状态的卡片

- **当** 用户点击"退卡"按钮
- **并且** 卡片状态为 `pending` 或 `distributed`
- **那么** 系统必须显示退卡弹窗
- **并且** 弹窗必须包含：
  - 退卡原因（单选）：地址错误、无法联系、其他
  - 备注（多行文本输入框）
- **并且** 用户填写并提交
- **那么** 系统必须更新卡片记录：
  - `status` 更新为 `returned`
  - `metadata` 添加 `return` 对象：
    ```json
    {
      "return": {
        "reason": "地址错误",
        "remarks": "用户输入的备注",
        "returned_at": "2026-01-21T16:00:00+08:00"
      }
    }
    ```
  - `updated_at` 更新为当前时间

#### 场景：已退卡状态的卡片不可再次退卡

- **当** 卡片状态为 `returned`
- **那么** 系统必须隐藏或禁用"退卡"按钮

---

### 需求：卡片详情查看

系统必须提供卡片详情查看功能，显示完整信息和历史。

#### 场景：查看卡片详情

- **当** 用户点击"查看"按钮
- **那么** 系统必须显示详情弹窗（只读模式）
- **并且** 弹窗必须包含：
  - 基本信息：项目名称、呼号、数量、状态、创建时间
  - 分发历史（如果有）：处理方式、地址、备注、分发时间
  - 退卡历史（如果有）：退卡原因、备注、退卡时间
- **并且** 所有字段必须为只读，不可编辑

#### 场景：未分发的卡片不显示分发历史

- **当** 卡片状态为 `pending`
- **那么** 详情弹窗不得显示分发历史部分

#### 场景：未退卡的卡片不显示退卡历史

- **当** 卡片状态为 `pending` 或 `distributed`
- **那么** 详情弹窗不得显示退卡历史部分

---

### 需求：卡片删除功能

系统必须提供卡片删除功能，支持删除单个卡片记录。

#### 场景：删除卡片记录

- **当** 用户点击"删除"按钮
- **那么** 系统必须显示确认弹窗："确定要删除此卡片吗？"
- **并且** 用户确认删除
- **那么** 系统必须从数据库中删除该卡片记录
- **并且** 必须刷新卡片列表

#### 场景：取消删除操作

- **当** 用户在删除确认弹窗中点击"取消"
- **那么** 系统不得删除卡片
- **并且** 必须关闭确认弹窗

---

## 相关规范

- **card-management-core**（Phase 1）：卡片管理基础（依赖）
- **cloud-database-support**（Phase 3）：云数据库支持（后续）

## 技术约束

- **数据库**：使用 SQLite 本地数据库
- **呼号格式**：3-10 字符，仅包含字母、数字、斜杠
- **数量范围**：1-9999
- **状态枚举**：pending（已录入）、distributed（已分发）、returned（已退卡）
- **元数据格式**：JSON 字符串存储在 `metadata` 字段

## 向后兼容性

- ✅ 无破坏性变更，新增功能
- ✅ 依赖 Phase 1 完成（projects 表已存在）
