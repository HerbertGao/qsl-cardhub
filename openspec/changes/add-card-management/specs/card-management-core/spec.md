# 规范：卡片管理核心 (Phase 1)

## 新增需求

### 需求：本地 SQLite 数据库自动初始化

系统必须在首次启动时自动创建本地 SQLite 数据库，无需用户任何配置。

#### 场景：首次启动自动创建数据库

- **当** 用户首次启动应用
- **并且** 数据库文件不存在
- **那么** 系统必须自动创建数据库文件
- **并且** 文件路径为：
  - macOS/Linux: `~/.config/qsl-cardhub/cards.db`
  - Windows: `%APPDATA%\qsl-cardhub\cards.db`
- **并且** 如果目录不存在，必须自动创建目录
- **并且** 文件权限必须为当前用户可读写（600）

#### 场景：执行数据库初始化脚本

- **当** 系统创建新的数据库文件
- **那么** 系统必须执行 SQL 初始化脚本
- **并且** 脚本必须创建 `projects` 表：
  ```sql
  CREATE TABLE projects (
      id TEXT PRIMARY KEY,
      name TEXT NOT NULL UNIQUE,
      created_at TEXT NOT NULL,
      updated_at TEXT NOT NULL
  );
  ```
- **并且** 必须设置数据库版本号：`PRAGMA user_version = 1;`
- **并且** 必须记录初始化日志

#### 场景：数据库已存在时跳过初始化

- **当** 用户启动应用
- **并且** 数据库文件已存在
- **那么** 系统不得重复创建数据库
- **并且** 必须检查数据库版本号
- **并且** 如果版本号正确，直接使用现有数据库

#### 场景：数据库版本管理

- **当** 系统检测到数据库版本号低于应用要求
- **那么** 系统必须自动执行迁移脚本
- **并且** 按版本号顺序执行（如 v1 → v2）
- **并且** 更新 `user_version`
- **并且** 迁移失败时，记录错误日志并提示用户

---

### 需求：转卡项目管理

系统必须支持转卡项目的创建、查询、更新和删除操作。

#### 场景：创建新项目

- **当** 用户点击"新建项目"按钮
- **并且** 在弹窗中输入项目名称（如"2026年1月活动"）
- **并且** 点击"确定"按钮
- **那么** 系统必须验证项目名称不为空
- **并且** 系统必须验证项目名称不重复
- **并且** 系统必须生成 UUID 作为项目ID
- **并且** 系统必须记录创建时间和更新时间（东八区时间戳，ISO 8601 格式）
- **并且** 系统必须插入数据到 `projects` 表
- **并且** 刷新项目列表

#### 场景：项目名称为空时显示错误

- **当** 用户在新建项目弹窗中未输入项目名称
- **并且** 点击"确定"按钮
- **那么** 系统必须显示错误提示："项目名称不能为空"
- **并且** 不得创建项目记录
- **并且** 弹窗保持打开状态

#### 场景：项目名称重复时显示错误

- **当** 用户输入的项目名称已存在
- **那么** 系统必须显示错误提示："项目名称已存在，请使用其他名称"
- **并且** 不得创建重复项目

#### 场景：查询项目列表

- **当** 用户进入卡片管理页面
- **那么** 系统必须自动加载项目列表
- **并且** 项目必须按创建时间降序排序（最新的在前）
- **并且** 每个项目显示：项目名称、卡片总数
- **并且** 如果没有项目，显示"暂无项目，请点击新建项目"提示

#### 场景：统计项目的卡片数量

- **当** 系统查询项目列表
- **那么** 必须同时统计每个项目的卡片总数
- **并且** 使用 SQL `LEFT JOIN` 和 `COUNT` 聚合
- **并且** 如果项目没有卡片，显示"0 张卡片"

#### 场景：更新项目名称

- **当** 用户点击项目的"重命名"按钮
- **并且** 在弹窗中输入新的项目名称
- **并且** 点击"确定"按钮
- **那么** 系统必须验证新名称不为空且不重复
- **并且** 系统必须更新 `name` 字段
- **并且** 系统必须更新 `updated_at` 字段为当前时间
- **并且** 刷新项目列表

#### 场景：删除项目

- **当** 用户点击项目的"删除"按钮
- **那么** 系统必须显示确认对话框："删除项目将同时删除所有关联卡片，是否继续？"
- **并且** 用户点击"确定"
- **那么** 系统必须执行删除操作
- **并且** 由于外键级联，关联的卡片也会被删除
- **并且** 刷新项目列表

#### 场景：取消删除项目

- **当** 用户点击项目的"删除"按钮
- **并且** 在确认对话框中点击"取消"
- **那么** 系统不得删除项目
- **并且** 对话框关闭

---

### 需求：菜单导航优化

系统必须优化左侧导航菜单，使用横线对功能进行分组。

#### 场景：菜单分组显示

- **当** 用户打开应用
- **那么** 左侧菜单必须按以下分组显示：
  1. 打印相关：打印、配置管理、模板设置
  2. （横线分隔）
  3. 卡片管理：卡片管理
  4. （横线分隔）
  5. 系统功能：日志查看、关于
- **并且** 横线必须使用 `<el-divider>` 组件
- **并且** 横线样式：`margin: 20px 0`

#### 场景：卡片管理菜单项

- **当** 用户点击"卡片管理"菜单项
- **那么** 主内容区必须显示卡片管理页面
- **并且** 菜单项高亮显示（背景色：#ecf5ff）
- **并且** 图标使用 `Box`（Element Plus 图标）
- **并且** 图标大小与其他菜单项一致

---

### 需求：卡片管理页面框架

系统必须提供卡片管理页面的基础框架，采用左右分栏布局。

#### 场景：左右分栏布局

- **当** 用户打开卡片管理页面
- **那么** 页面必须使用 `<el-container>` 左右分栏布局
- **并且** 左侧面板宽度固定为 `240px`
- **并且** 右侧面板自动填充剩余宽度
- **并且** 两侧之间有 1px 分割线（颜色：#dcdfe6）

#### 场景：左侧项目列表显示

- **当** 左侧面板加载
- **那么** 顶部必须显示"新建项目"按钮（全宽，主题色）
- **并且** 中间区域显示项目列表
- **并且** 每个项目显示为列表项，包含：
  - 项目图标（Box 图标）
  - 项目名称
  - 卡片数量（灰色小字）
- **并且** 底部显示项目总数统计（如"共 3 个项目"）

#### 场景：选中项目高亮

- **当** 用户点击左侧某个项目
- **那么** 该项目必须高亮显示（背景色：#f5f7fa）
- **并且** 右侧面板必须显示该项目的卡片列表（Phase 2 实现）
- **并且** 如果是 Phase 1，右侧显示占位符提示："请在 Phase 2 完成后查看卡片列表"

#### 场景：右侧占位符（Phase 1）

- **当** Phase 1 实施完成，Phase 2 尚未开始
- **那么** 右侧面板必须显示占位符组件
- **并且** 占位符内容为："卡片列表功能将在 Phase 2 实现"
- **并且** 提供"了解更多"按钮，链接到 Phase 2 提案文档

---

### 需求：错误处理

系统必须正确处理数据库操作的各类错误。

#### 场景：数据库文件权限错误

- **当** 数据库文件目录无写权限
- **那么** 系统必须捕获权限错误
- **并且** 显示错误提示："无法创建数据库文件，请检查目录权限"
- **并且** 记录错误日志

#### 场景：数据库连接失败

- **当** 数据库文件损坏或格式错误
- **那么** 系统必须捕获连接错误
- **并且** 显示错误提示："数据库文件已损坏，请删除后重新启动"
- **并且** 提供数据库文件路径供用户定位

#### 场景：SQL 执行错误

- **当** SQL 语句执行失败（如约束冲突、语法错误）
- **那么** 系统必须捕获 SQL 错误
- **并且** 显示用户友好的错误提示（不显示原始 SQL 错误）
- **并且** 记录详细错误日志供开发调试

---

### 需求：数据模型定义

系统必须定义清晰的数据模型结构。

#### 场景：Project 数据模型

- **当** 系统定义项目数据结构
- **那么** 必须包含以下字段：
  - `id`: String（UUID 格式）
  - `name`: String（项目名称）
  - `created_at`: String（ISO 8601 格式，东八区）
  - `updated_at`: String（ISO 8601 格式，东八区）
- **并且** 必须实现 `serde::Serialize` 和 `serde::Deserialize`
- **并且** 必须实现 `Debug` 和 `Clone` trait

#### 场景：时间戳格式

- **当** 系统生成时间戳
- **那么** 必须使用东八区时区（UTC+8）
- **并且** 格式必须为 ISO 8601：`2026-01-21T15:30:00+08:00`
- **并且** 使用 `chrono` crate 的 `FixedOffset` 实现

---

## 相关规范

- **card-entry-and-management**（Phase 2）：卡片录入和管理
- **cloud-database-support**（Phase 3）：云数据库支持

## 技术约束

- **数据库**：SQLite 3（bundled 模式，使用 `rusqlite` crate）
- **UUID 生成**：使用 `uuid` crate v4
- **时间戳**：使用 `chrono` crate，东八区固定偏移
- **前端框架**：Vue 3 Composition API + Element Plus
- **后端命令**：Tauri 2.x Commands

## 向后兼容性

- ✅ 无破坏性变更，新增功能
- ✅ 不影响现有打印功能
- ✅ 数据库表结构预留扩展字段，便于 Phase 2 和 Phase 3 添加功能
