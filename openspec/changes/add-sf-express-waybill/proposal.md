# 顺丰速运面单打印功能

## 概述

为 QSL-CardHub 添加顺丰速运面单打印功能，集成顺丰开放平台的云打印 API（COM_RECE_CLOUD_PRINT_WAYBILLS），实现运单面单的同步获取和 TSPL 打印。

## 动机

当前卡片分发流程中，用户选择"快递"方式后需要手动打印快递面单。通过集成顺丰云打印 API，可以：
- 在应用内直接打印顺丰面单，简化工作流程
- 复用现有的 TSPL 打印基础设施
- 将面单打印与卡片分发流程无缝衔接

## 功能范围

### 功能一：顺丰速运配置页面

在「数据配置」菜单下新增「顺丰速运」配置页面，提供以下配置项：

| 配置项 | 类型 | 说明 |
|--------|------|------|
| 环境 | 单选 | 生产环境 / 沙箱环境 |
| 顾客编码 | 文本 | 合作伙伴编码（partnerID） |
| 模板编码 | 只读 | 固定值：`fm_76130_standard_HBTRJT0FNP6E` |
| 生产校验码 | 密码 | 生产环境的 checkword |
| 沙箱校验码 | 密码 | 沙箱环境的 checkword |

配置界面根据当前选择的环境自动使用对应的校验码。

### 功能二：运单打印对话框

在卡片管理的以下位置提供「打印面单」入口：
- 卡片列表的操作列
- 分发对话框中

运单打印对话框包含：
- 运单号输入框（从分发界面进入时，若备注非空则自动带入备注作为运单号）
- 打印按钮

点击打印后：
1. 调用顺丰 API 同步获取 PDF（`sync: true`）
2. 下载 PDF 文件
3. 将 PDF 渲染为 1bpp 点阵图
4. 生成 TSPL 指令并发送到打印机

## 技术方案

### API 集成

- **接口**：COM_RECE_CLOUD_PRINT_WAYBILLS（云打印面单打印2.0）
- **认证**：数字签名方式（msgDigest = MD5(msgData + timestamp + checkword)）
- **模式**：同步模式（sync: true），直接返回 PDF 下载地址
- **环境地址**：
  - 生产：`https://bspgw.sf-express.com/std/service`
  - 沙箱：`https://sfapi-sbox.sf-express.com/std/service`

### PDF 转打印

1. 使用 Rust PDF 解析库（如 `pdf` 或 `pdfium`）读取 PDF
2. 将 PDF 页面渲染为位图
3. 转换为 1bpp 单色点阵（适配热敏打印）
4. 生成 TSPL BITMAP 指令
5. 通过现有打印管道发送到打印机

### 凭据存储

复用现有的凭据存储机制（系统钥匙串或本地加密文件），存储键名：
- `qsl-cardhub:sf:partner_id`
- `qsl-cardhub:sf:checkword_prod`
- `qsl-cardhub:sf:checkword_sandbox`
- `qsl-cardhub:sf:environment`

## 约束与限制

1. **纸张尺寸**：面单模板为 76mm × 130mm，与现有标签纸一致
2. **单票打印**：每次只打印单个运单，不支持批量
3. **网络依赖**：需要能够访问顺丰开放平台 API
4. **不涉及下单**：仅打印已存在的运单，不涉及顺丰下单 API

## 受影响的规范

- **新增**：`sf-express-integration` - 顺丰速运集成规范

## 风险评估

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| PDF 解析复杂度 | 中 | 选择成熟的 PDF 库，做好错误处理 |
| API 调用失败 | 低 | 提供明确的错误提示，支持重试 |
| 打印质量问题 | 低 | PDF 为 76×130 标准尺寸，直接转换即可 |
