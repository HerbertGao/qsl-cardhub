# 顺丰速运集成

## 新增需求

### 需求：顺丰配置管理

系统**必须**提供顺丰速运 API 配置管理功能。

#### 场景：配置顺丰凭据

**前提条件：**
- 用户已获取顺丰开放平台的顾客编码和校验码

**操作步骤：**
1. 用户打开「数据配置 > 顺丰速运」页面
2. 用户选择环境（生产/沙箱）
3. 用户输入顾客编码
4. 用户输入对应环境的校验码
5. 用户点击「保存」

**预期结果：**
- 配置保存成功
- 显示「已保存凭据」状态
- 凭据加密存储到系统钥匙串或本地加密文件

#### 场景：切换环境

**前提条件：**
- 用户已配置生产和沙箱两个环境的校验码

**操作步骤：**
1. 用户在配置页面切换环境选项

**预期结果：**
- 环境配置立即保存
- 后续 API 调用使用对应环境的地址和校验码

#### 场景：清除配置

**操作步骤：**
1. 用户点击「清除凭据」按钮
2. 系统显示确认对话框
3. 用户确认清除

**预期结果：**
- 所有顺丰相关凭据被删除
- 配置状态重置为未配置

---

### 需求：运单面单打印

系统**必须**支持通过顺丰云打印 API 打印运单面单。

#### 场景：从卡片列表打印面单（两步流程）

**前提条件：**
- 用户已配置顺丰凭据
- 用户已选择打印机

**操作步骤：**
1. 用户在卡片列表中点击某卡片的「打印面单」按钮
2. 系统打开运单打印对话框
3. 用户输入运单号
4. 用户点击「提交打印」按钮
5. 系统调用顺丰 API 获取 PDF 并显示预览
6. 用户确认预览无误后点击「打印」按钮

**预期结果：**
- 「提交打印」后显示 PDF 预览图像
- 只有成功获取 PDF 后「打印」按钮才可点击
- 点击「打印」后 PDF 转换为 TSPL 指令并发送到打印机
- 显示打印成功提示

#### 场景：从分发界面打印面单

**前提条件：**
- 用户在分发对话框中填写了备注（包含运单号）

**操作步骤：**
1. 用户在分发对话框中点击「打印面单」按钮
2. 系统打开运单打印对话框，自动带入备注作为运单号
3. 用户点击「提交打印」获取预览
4. 用户确认后点击「打印」

**预期结果：**
- 运单号输入框预填充备注内容
- 打印流程同上（两步）

#### 场景：获取面单失败处理

**前提条件：**
- 运单号不存在或签名错误

**操作步骤：**
1. 用户输入无效运单号
2. 用户点击「提交打印」

**预期结果：**
- 显示具体错误信息
- 错误信息为中文，便于用户理解
- 「打印」按钮保持禁用状态
- 用户可修改运单号后重试

---

### 需求：API 数字签名

系统**必须**使用数字签名方式进行顺丰 API 认证。

#### 场景：计算请求签名

**输入：**
- msgData：业务 JSON 字符串
- timestamp：当前时间戳（毫秒）
- checkWord：校验码

**计算步骤：**
1. 拼接字符串：`msgData + timestamp + checkWord`
2. 对拼接结果进行 MD5 哈希（UTF-8 编码）
3. 对 MD5 结果进行 Base64 编码

**预期结果：**
- 生成的 msgDigest 可通过顺丰 API 验证

---

### 需求：PDF 转 TSPL 打印

系统**必须**将 PDF 面单转换为 TSPL 指令进行打印。

#### 场景：PDF 渲染为点阵

**输入：**
- PDF 文件（76mm × 130mm）
- 目标 DPI：203

**处理步骤：**
1. 加载 PDF 文件
2. 渲染为 RGB 位图（608 × 1040 像素）
3. 转换为灰度图像
4. 使用阈值 128 进行二值化
5. 转换为 1bpp 点阵（MSB first）

**预期结果：**
- 输出 1bpp 点阵数据
- 尺寸为 76 bytes × 1040 行

#### 场景：生成 TSPL BITMAP 指令

**输入：**
- 1bpp 点阵数据

**预期输出：**
```
SIZE 76 mm, 130 mm
GAP 0 mm, 0 mm
DIRECTION 1,0
CLS
BITMAP 0,0,76,1040,0,<binary_data>
PRINT 1,1
```
